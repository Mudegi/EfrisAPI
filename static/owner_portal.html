<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Owner Dashboard - EFRIS Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 24px;
        }
        
        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-info .name {
            font-weight: bold;
            color: #333;
        }
        
        .user-info .role {
            font-size: 12px;
            color: #667eea;
            background: #f0f0ff;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 4px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card.warning .number {
            color: #ffc107;
        }
        
        .stat-card.success .number {
            color: #28a745;
        }
        
        .stat-card.danger .number {
            color: #dc3545;
        }
        
        .tabs {
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            display: flex;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-active {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-suspended {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-trial {
            background: #cce5ff;
            color: #004085;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
            font-size: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .alert {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .activity-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #999;
        }
        
        .activity-details {
            margin-top: 5px;
            font-size: 14px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .login-container h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }
        
        .login-container .logo {
            text-align: center;
            margin-bottom: 20px;
            font-size: 48px;
        }
        
        #dashboard {
            display: none;
        }
        
        #loginForm {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="login-container">
        <div class="logo">üëë</div>
        <h2>Platform Owner Login</h2>
        <div id="loginError"></div>
        <form onsubmit="login(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login_email" required placeholder="owner@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login_password" required placeholder="Enter your password">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Login as Owner</button>
        </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container">
        <div class="header">
            <h1>üëë Platform Owner Dashboard</h1>
            <div class="header-right">
                <div class="user-info">
                    <div class="name" id="ownerName">Owner Name</div>
                    <span class="role">PLATFORM OWNER</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Resellers</h3>
                <div class="number" id="stat_resellers">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Pending Clients (Approval Needed)</h3>
                <div class="number" id="stat_pending">0</div>
            </div>
            <div class="stat-card success">
                <h3>Active Clients</h3>
                <div class="number" id="stat_active_clients">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Invoices Today</h3>
                <div class="number" id="stat_invoices">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('pending')">‚è≥ Pending Approvals</button>
            <button class="tab" onclick="switchTab('resellers')">üë• Resellers</button>
            <button class="tab" onclick="switchTab('clients')">üè¢ All Clients</button>
            <button class="tab" onclick="switchTab('activity')">üìä Activity Feed</button>
            <button class="tab" onclick="switchTab('add')">‚ûï Add Direct Client</button>
        </div>

        <!-- Tab: Pending Approvals -->
        <div id="tab-pending" class="tab-content active">
            <h2>Pending Client Approvals</h2>
            <p style="color: #666; margin-bottom: 20px;">These clients were added by resellers and need your approval to become active.</p>
            <div id="pendingAlert"></div>
            <table id="pendingTable">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>TIN</th>
                        <th>Email</th>
                        <th>Reseller</th>
                        <th>Added On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pendingList"></tbody>
            </table>
        </div>

        <!-- Tab: Resellers -->
        <div id="tab-resellers" class="tab-content">
            <h2>All Resellers</h2>
            <table id="resellersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Clients</th>
                        <th>Subscription</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resellersList"></tbody>
            </table>
        </div>

        <!-- Tab: All Clients -->
        <div id="tab-clients" class="tab-content">
            <h2>All Clients</h2>
            <table id="clientsTable">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>TIN</th>
                        <th>Email</th>
                        <th>Reseller</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientsList"></tbody>
            </table>
        </div>

        <!-- Tab: Activity Feed -->
        <div id="tab-activity" class="tab-content">
            <h2>Activity Feed</h2>
            <p style="color: #666; margin-bottom: 20px;">Real-time tracking of invoices and EFRIS operations across all clients.</p>
            <div id="activityFeed"></div>
        </div>

        <!-- Tab: Add Direct Client -->
        <div id="tab-add" class="tab-content">
            <h2>Add Direct Client</h2>
            <p style="color: #666; margin-bottom: 20px;">Add clients directly without going through resellers.</p>
            <div id="addClientAlert"></div>
            <form onsubmit="addDirectClient(event)">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="add_company_name" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="add_email" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="add_password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="add_phone">
                </div>
                <div class="form-group">
                    <label>TIN *</label>
                    <input type="text" id="add_tin" required>
                </div>
                <div class="form-group">
                    <label>Device Number *</label>
                    <input type="text" id="add_device_no" required>
                </div>
                <div class="form-group">
                    <label>Certificate (.pfx file) *</label>
                    <input type="file" id="add_pfx_file" accept=".pfx" required>
                </div>
                <div class="form-group">
                    <label>Certificate Password *</label>
                    <input type="password" id="add_cert_password" required>
                </div>
                <div class="form-group">
                    <label style="font-weight: bold; color: #2d3748;">
                        EFRIS Environment *
                    </label>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="radio" name="efris_env" value="production" id="add_prod_mode" checked style="margin-right: 10px;">
                            <div>
                                <strong>üöÄ Production Environment (Default)</strong>
                                <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">
                                    For real invoices. Uses: efris.ura.go.ug
                                </p>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="radio" name="efris_env" value="test" id="add_test_mode" style="margin-right: 10px;">
                            <div>
                                <strong>üß™ Test/Sandbox (Demo only)</strong>
                                <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">
                                    Only for public demo endpoints. Uses: efristest.ura.go.ug
                                </p>
                            </div>
                        </label>
                        <p style="margin-top: 10px; font-size: 11px; color: #e53e3e;">
                            ‚ö†Ô∏è Most clients should use Production. Only use Test for development/training.
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <label style="font-weight: bold; color: #2d3748;">
                        ERP/Accounting System *
                    </label>
                    <select id="add_erp_type" onchange="toggleERPFields()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                        <option value="none">None - Manual Invoice Entry</option>
                        <option value="quickbooks">QuickBooks Online</option>
                        <option value="xero">Xero</option>
                        <option value="zoho">Zoho Books</option>
                        <option value="sage">Sage</option>
                        <option value="odoo">Odoo</option>
                        <option value="custom">Custom API Integration</option>
                    </select>
                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
                        üí° Select the accounting system your client uses. Invoices will sync automatically.
                    </p>
                </div>

                <!-- QuickBooks Fields -->
                <div id="quickbooks_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìò QuickBooks Configuration</h4>
                    <div class="form-group">
                        <label>Realm ID (Company ID) *</label>
                        <input type="text" id="add_qb_realm_id" placeholder="e.g., 123145876921234">
                        <p style="font-size: 11px; color: #666; margin: 3px 0 0 0;">Find in QuickBooks: Settings ‚Üí Your Company ‚Üí Company ID</p>
                    </div>
                    <div class="form-group">
                        <label>Client ID *</label>
                        <input type="text" id="add_qb_client_id" placeholder="From QuickBooks Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>Client Secret *</label>
                        <input type="password" id="add_qb_client_secret" placeholder="From QuickBooks Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <select id="add_qb_region" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                </div>

                <!-- Xero Fields -->
                <div id="xero_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìó Xero Configuration</h4>
                    <div class="form-group">
                        <label>Tenant ID *</label>
                        <input type="text" id="add_xero_tenant_id" placeholder="Xero Organization ID">
                    </div>
                    <div class="form-group">
                        <label>Client ID *</label>
                        <input type="text" id="add_xero_client_id" placeholder="From Xero Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>Client Secret *</label>
                        <input type="password" id="add_xero_client_secret" placeholder="From Xero Developer Portal">
                    </div>
                </div>

                <!-- Zoho Fields -->
                <div id="zoho_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìï Zoho Books Configuration</h4>
                    <div class="form-group">
                        <label>Organization ID *</label>
                        <input type="text" id="add_zoho_org_id" placeholder="Zoho Organization ID">
                    </div>
                    <div class="form-group">
                        <label>Client ID *</label>
                        <input type="text" id="add_zoho_client_id" placeholder="From Zoho API Console">
                    </div>
                    <div class="form-group">
                        <label>Client Secret *</label>
                        <input type="password" id="add_zoho_client_secret" placeholder="From Zoho API Console">
                    </div>
                </div>

                <!-- Sage Fields -->
                <div id="sage_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìô Sage Configuration</h4>
                    <div class="form-group">
                        <label>Company ID *</label>
                        <input type="text" id="add_sage_company_id" placeholder="Sage Company ID">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="text" id="add_sage_api_key" placeholder="From Sage Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>API Secret *</label>
                        <input type="password" id="add_sage_api_secret" placeholder="From Sage Developer Portal">
                    </div>
                </div>

                <!-- Odoo Fields -->
                <div id="odoo_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üü£ Odoo Configuration</h4>
                    <div class="form-group">
                        <label>Odoo URL *</label>
                        <input type="text" id="add_odoo_url" placeholder="https://yourcompany.odoo.com">
                    </div>
                    <div class="form-group">
                        <label>Database Name *</label>
                        <input type="text" id="add_odoo_db" placeholder="Database name">
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="add_odoo_username" placeholder="Odoo username">
                    </div>
                    <div class="form-group">
                        <label>API Key/Password *</label>
                        <input type="password" id="add_odoo_password" placeholder="API Key or Password">
                    </div>
                </div>

                <!-- Custom API Fields -->
                <div id="custom_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üîß Custom API Configuration</h4>
                    <div class="form-group">
                        <label>API URL *</label>
                        <input type="text" id="add_custom_url" placeholder="https://api.yourcompany.com">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="text" id="add_custom_api_key" placeholder="Your API Key">
                    </div>
                    <div class="form-group">
                        <label>API Secret</label>
                        <input type="password" id="add_custom_api_secret" placeholder="Optional API Secret">
                    </div>
                    <p style="font-size: 12px; color: #666; margin: 10px 0 0 0;">
                        ‚ÑπÔ∏è Your API should return invoices in EFRIS-compatible format
                    </p>
                </div>

                <button type="submit" class="btn btn-primary">Add Client</button>
            </form>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('owner_token');
        let ownerData = null;

        // Check if already logged in
        if (token) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadDashboard();
        }

        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('login_email').value;
            const password = document.getElementById('login_password').value;

            try {
                const formData = new FormData();
                formData.append('username', email);
                formData.append('password', password);

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Check if user is owner/admin
                    if (data.user.role !== 'owner' && data.user.role !== 'admin') {
                        document.getElementById('loginError').innerHTML = '<div class="alert alert-danger">Access denied. Only platform owners can access this dashboard.</div>';
                        return;
                    }

                    token = data.access_token;
                    ownerData = data.user;
                    localStorage.setItem('owner_token', token);
                    
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadDashboard();
                } else {
                    const error = await response.json();
                    document.getElementById('loginError').innerHTML = `<div class="alert alert-danger">${error.detail || 'Login failed'}</div>`;
                }
            } catch (error) {
                document.getElementById('loginError').innerHTML = '<div class="alert alert-danger">Login failed. Please try again.</div>';
            }
        }

        function logout() {
            localStorage.removeItem('owner_token');
            location.reload();
        }

        async function loadDashboard() {
            await Promise.all([
                loadStats(),
                loadPendingClients(),
                loadResellers(),
                loadAllClients(),
                loadActivity()
            ]);
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/owner/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('stat_resellers').textContent = stats.total_resellers || 0;
                    document.getElementById('stat_pending').textContent = stats.pending_clients || 0;
                    document.getElementById('stat_active_clients').textContent = stats.active_clients || 0;
                    document.getElementById('stat_invoices').textContent = stats.invoices_today || 0;
                    document.getElementById('ownerName').textContent = stats.owner_name || 'Owner';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadPendingClients() {
            try {
                const response = await fetch('/api/owner/pending-clients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    const tbody = document.getElementById('pendingList');
                    
                    if (clients.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No pending approvals</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = clients.map(client => `
                        <tr>
                            <td>${client.company_name}</td>
                            <td>${client.tin}</td>
                            <td>${client.email}</td>
                            <td>${client.reseller_name}</td>
                            <td>${new Date(client.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="approveClient(${client.id})">‚úì Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectClient(${client.id})">‚úó Reject</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load pending clients:', error);
            }
        }

        async function loadResellers() {
            try {
                const response = await fetch('/api/owner/resellers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const resellers = await response.json();
                    const tbody = document.getElementById('resellersList');
                    
                    tbody.innerHTML = resellers.map(r => `
                        <tr>
                            <td>${r.full_name}</td>
                            <td>${r.email}</td>
                            <td>${r.phone || 'N/A'}</td>
                            <td>${r.client_count}</td>
                            <td><span class="badge badge-${r.subscription_status}">${r.subscription_status}</span></td>
                            <td><span class="badge badge-${r.status}">${r.status}</span></td>
                            <td>${new Date(r.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="suspendReseller(${r.id})">Suspend</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load resellers:', error);
            }
        }

        async function loadAllClients() {
            try {
                const response = await fetch('/api/owner/clients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    const tbody = document.getElementById('clientsList');
                    
                    tbody.innerHTML = clients.map(c => `
                        <tr>
                            <td>${c.company_name}</td>
                            <td>${c.tin}</td>
                            <td>${c.email}</td>
                            <td>${c.reseller_name || 'Direct'}</td>
                            <td><span class="badge badge-${c.status}">${c.status}</span></td>
                            <td>${new Date(c.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewClientDetails(${c.id})" style="margin-right: 5px;">View</button>
                                ${c.status === 'active' ? 
                                    `<button class="btn btn-warning btn-sm" onclick="suspendClient(${c.id}, '${c.email}')">Suspend</button>` :
                                    c.status === 'suspended' ?
                                    `<button class="btn btn-success btn-sm" onclick="activateClient(${c.id}, '${c.email}')">Activate</button>` :
                                    ''}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load clients:', error);
            }
        }

        async function viewClientDetails(clientId) {
            try {
                const response = await fetch(`/api/owner/clients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const clients = await response.json();
                const client = clients.find(c => c.id === clientId);
                
                if (!client) {
                    alert('Client not found');
                    return;
                }
                
                // Create modal HTML
                const modalHtml = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-top: 0; color: #2c3e50;">üìä Client Details</h3>
                            
                            <div style="margin: 20px 0;">
                                <h4 style="color: #7f8c8d; margin-bottom: 10px;">Company Information</h4>
                                <p><strong>Company:</strong> ${client.company_name}</p>
                                <p><strong>TIN:</strong> ${client.tin}</p>
                                <p><strong>Email:</strong> ${client.email}</p>
                                <p><strong>Status:</strong> <span class="badge badge-${client.status}">${client.status}</span></p>
                                <p><strong>Created:</strong> ${new Date(client.created_at).toLocaleString()}</p>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <h4 style="color: #7f8c8d; margin-bottom: 10px;">Reseller</h4>
                                <p><strong>Managed By:</strong> ${client.reseller_name || 'Direct Client'}</p>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <h4 style="color: #7f8c8d; margin-bottom: 10px;">Quick Actions</h4>
                                <p style="color: #95a5a6;">Login as this client to:</p>
                                <ul style="color: #7f8c8d;">
                                    <li>View EFRIS connection status</li>
                                    <li>See invoice history</li>
                                    <li>Manage ERP integrations</li>
                                    <li>Access full dashboard</li>
                                </ul>
                                <p style="margin-top: 15px;"><strong>Login URL:</strong> <a href="/dashboard" target="_blank" style="color: #3498db;">http://localhost:8001/dashboard</a></p>
                                <p><strong>Email:</strong> ${client.email}</p>
                            </div>
                            
                            <button onclick="this.closest('[style*=fixed]').remove()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px;">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Failed to load client details:', error);
                alert('Failed to load client details');
            }
        }

        async function suspendClient(clientId, email) {
            if (!confirm(`Are you sure you want to SUSPEND ${email}?\n\nThis will:\n- Block their access to the platform\n- Disable all EFRIS operations\n- They won't be able to login`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/owner/suspend-client/${clientId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Client suspended successfully');
                    loadClients();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert(`Failed to suspend client: ${error.detail}`);
                }
            } catch (error) {
                console.error('Failed to suspend client:', error);
                alert('Failed to suspend client');
            }
        }

        async function activateClient(clientId, email) {
            if (!confirm(`Are you sure you want to ACTIVATE ${email}?\n\nThis will:\n- Restore their access to the platform\n- Enable all EFRIS operations\n- They can login again`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/owner/activate-client/${clientId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Client activated successfully');
                    loadClients();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert(`Failed to activate client: ${error.detail}`);
                }
            } catch (error) {
                console.error('Failed to activate client:', error);
                alert('Failed to activate client');
            }
        }

        async function loadActivity() {
            try {
                const response = await fetch('/api/owner/activity', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const activities = await response.json();
                    const feed = document.getElementById('activityFeed');
                    
                    if (activities.length === 0) {
                        feed.innerHTML = '<div class="empty-state">No recent activity</div>';
                        return;
                    }
                    
                    feed.innerHTML = activities.map(a => `
                        <div class="activity-item">
                            <div class="activity-time">${new Date(a.created_at).toLocaleString()}</div>
                            <div class="activity-details">
                                <strong>${a.company_name}</strong> - ${a.activity_type}
                                ${a.document_number ? `<br>Document: ${a.document_number}` : ''}
                                ${a.efris_request_type ? `<br>EFRIS: ${a.efris_request_type} - <span class="badge badge-${a.efris_status}">${a.efris_status}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load activity:', error);
            }
        }

        async function approveClient(clientId) {
            if (!confirm('Approve this client? They will be able to use the platform.')) return;
            
            try {
                const response = await fetch(`/api/owner/approve-client/${clientId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    document.getElementById('pendingAlert').innerHTML = '<div class="alert alert-success">Client approved successfully!</div>';
                    setTimeout(() => document.getElementById('pendingAlert').innerHTML = '', 3000);
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert('Failed to approve client: ' + error.detail);
                }
            } catch (error) {
                alert('Failed to approve client');
            }
        }

        async function rejectClient(clientId) {
            const reason = prompt('Reason for rejection (optional):');
            
            try {
                const response = await fetch(`/api/owner/reject-client/${clientId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    document.getElementById('pendingAlert').innerHTML = '<div class="alert alert-success">Client rejected</div>';
                    setTimeout(() => document.getElementById('pendingAlert').innerHTML = '', 3000);
                    loadDashboard();
                } else {
                    alert('Failed to reject client');
                }
            } catch (error) {
                alert('Failed to reject client');
            }
        }

        function toggleERPFields() {
            const erpType = document.getElementById('add_erp_type').value;
            
            // Hide all ERP fields
            document.getElementById('quickbooks_fields').style.display = 'none';
            document.getElementById('xero_fields').style.display = 'none';
            document.getElementById('zoho_fields').style.display = 'none';
            document.getElementById('sage_fields').style.display = 'none';
            document.getElementById('odoo_fields').style.display = 'none';
            document.getElementById('custom_fields').style.display = 'none';
            
            // Show selected ERP fields
            if (erpType === 'quickbooks') {
                document.getElementById('quickbooks_fields').style.display = 'block';
            } else if (erpType === 'xero') {
                document.getElementById('xero_fields').style.display = 'block';
            } else if (erpType === 'zoho') {
                document.getElementById('zoho_fields').style.display = 'block';
            } else if (erpType === 'sage') {
                document.getElementById('sage_fields').style.display = 'block';
            } else if (erpType === 'odoo') {
                document.getElementById('odoo_fields').style.display = 'block';
            } else if (erpType === 'custom') {
                document.getElementById('custom_fields').style.display = 'block';
            }
        }

        async function addDirectClient(e) {
            e.preventDefault();
            
            // Get selected environment (test or production)
            const isTestMode = document.querySelector('input[name="efris_env"]:checked').value === 'test';
            const erpType = document.getElementById('add_erp_type').value;
            
            const formData = new FormData();
            formData.append('company_name', document.getElementById('add_company_name').value);
            formData.append('email', document.getElementById('add_email').value);
            formData.append('password', document.getElementById('add_password').value);
            formData.append('phone', document.getElementById('add_phone').value);
            formData.append('tin', document.getElementById('add_tin').value);
            formData.append('device_no', document.getElementById('add_device_no').value);
            formData.append('cert_password', document.getElementById('add_cert_password').value);
            formData.append('test_mode', isTestMode);
            formData.append('pfx_file', document.getElementById('add_pfx_file').files[0]);
            formData.append('erp_type', erpType);
            
            // Add ERP-specific credentials
            if (erpType === 'quickbooks') {
                formData.append('qb_realm_id', document.getElementById('add_qb_realm_id').value);
                formData.append('qb_client_id', document.getElementById('add_qb_client_id').value);
                formData.append('qb_client_secret', document.getElementById('add_qb_client_secret').value);
                formData.append('qb_region', document.getElementById('add_qb_region').value);
            } else if (erpType === 'xero') {
                formData.append('xero_tenant_id', document.getElementById('add_xero_tenant_id').value);
                formData.append('xero_client_id', document.getElementById('add_xero_client_id').value);
                formData.append('xero_client_secret', document.getElementById('add_xero_client_secret').value);
            } else if (erpType === 'zoho') {
                formData.append('zoho_org_id', document.getElementById('add_zoho_org_id').value);
                formData.append('zoho_client_id', document.getElementById('add_zoho_client_id').value);
                formData.append('zoho_client_secret', document.getElementById('add_zoho_client_secret').value);
            } else if (erpType === 'sage') {
                formData.append('sage_company_id', document.getElementById('add_sage_company_id').value);
                formData.append('sage_api_key', document.getElementById('add_sage_api_key').value);
                formData.append('sage_api_secret', document.getElementById('add_sage_api_secret').value);
            } else if (erpType === 'odoo') {
                formData.append('odoo_url', document.getElementById('add_odoo_url').value);
                formData.append('odoo_db', document.getElementById('add_odoo_db').value);
                formData.append('odoo_username', document.getElementById('add_odoo_username').value);
                formData.append('odoo_password', document.getElementById('add_odoo_password').value);
            } else if (erpType === 'custom') {
                formData.append('custom_url', document.getElementById('add_custom_url').value);
                formData.append('custom_api_key', document.getElementById('add_custom_api_key').value);
                formData.append('custom_api_secret', document.getElementById('add_custom_api_secret').value || '');
            }
            
            try {
                const response = await fetch('/api/owner/add-client', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message with client login URL
                    const loginUrl = result.client_login_url || 'http://127.0.0.1:8001/client/login';
                    const email = result.client_email;
                    const password = document.getElementById('add_password').value;
                    const environment = isTestMode ? 'üß™ Test/Sandbox' : 'üöÄ Production';
                    const envUrl = isTestMode ? 'efristest.ura.go.ug' : 'efris.ura.go.ug';
                    
                    // ERP configuration message
                    const erpNames = {
                        'none': 'üìù Manual Invoice Entry',
                        'quickbooks': 'üìò QuickBooks Online',
                        'xero': 'üìó Xero',
                        'zoho': 'üìï Zoho Books',
                        'sage': 'üìô Sage',
                        'odoo': 'üü£ Odoo',
                        'custom': 'üîß Custom API'
                    };
                    const erpMessage = result.erp_configured ? 
                        `<p style="margin: 8px 0;"><strong>ERP System:</strong> ${erpNames[erpType] || erpType} (Pre-configured ‚úÖ)</p>` :
                        `<p style="margin: 8px 0;"><strong>ERP System:</strong> ${erpNames['none']}</p>`;
                    
                    document.getElementById('addClientAlert').innerHTML = `
                        <div class="alert alert-success">
                            <h4 style="margin-bottom: 15px;">‚úÖ Client Added Successfully!</h4>
                            <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
                                <p style="margin: 5px 0;"><strong>üìß Send these details to your client:</strong></p>
                                <hr style="margin: 10px 0;">
                                <p style="margin: 8px 0;"><strong>Login URL:</strong> <a href="${loginUrl}" target="_blank" style="color: #007bff;">${loginUrl}</a></p>
                                <p style="margin: 8px 0;"><strong>Email:</strong> ${email}</p>
                                <p style="margin: 8px 0;"><strong>Password:</strong> ${password}</p>
                                <p style="margin: 8px 0;"><strong>EFRIS Environment:</strong> ${environment} (${envUrl})</p>
                                ${erpMessage}
                                <hr style="margin: 10px 0;">
                                <p style="margin: 8px 0; font-size: 12px; color: #666;">
                                    ${result.erp_configured ? 
                                        '‚úÖ Ready to use! Invoices will sync automatically from their ERP system.' :
                                        'üìù Client can manually create invoices or configure ERP later.'}
                                </p>
                                <p style="margin: 8px 0; font-size: 12px; color: #666;">
                                    ‚ö†Ô∏è Important: Have your client bookmark the login URL. This is their dedicated client portal.
                                </p>
                            </div>
                            <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                        </div>
                    `;
                    e.target.reset();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    document.getElementById('addClientAlert').innerHTML = `<div class="alert alert-danger">${error.detail}</div>`;
                }
            } catch (error) {
                document.getElementById('addClientAlert').innerHTML = '<div class="alert alert-danger">Failed to add client</div>';
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (document.getElementById('dashboard').style.display === 'block') {
                loadStats();
                loadActivity();
            }
        }, 30000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Platform Owner Dashboard - EFRIS Integration</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚öôÔ∏è</text></svg>">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 24px;
        }
        
        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-info .name {
            font-weight: bold;
            color: #333;
        }
        
        .user-info .role {
            font-size: 12px;
            color: #667eea;
            background: #f0f0ff;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 4px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card.warning .number {
            color: #ffc107;
        }
        
        .stat-card.success .number {
            color: #28a745;
        }
        
        .stat-card.danger .number {
            color: #dc3545;
        }
        
        .tabs {
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            display: flex;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-active {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-suspended {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-trial {
            background: #cce5ff;
            color: #004085;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
            font-size: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .alert {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .activity-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #999;
        }
        
        .activity-details {
            margin-top: 5px;
            font-size: 14px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .login-container h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }
        
        .login-container .logo {
            text-align: center;
            margin-bottom: 20px;
            font-size: 48px;
        }
        
        #dashboard {
            display: none;
        }
        
        #loginForm {
            display: block;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
            }
            
            .tab {
                font-size: 12px;
                padding: 10px 15px;
            }
            
            table {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px 4px;
            }
            
            /* Stack table on very small screens */
            @media (max-width: 480px) {
                table, thead, tbody, th, td, tr {
                    display: block;
                }
                
                thead tr {
                    display: none;
                }
                
                tr {
                    margin-bottom: 15px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 10px;
                }
                
                td {
                    text-align: right;
                    padding-left: 50%;
                    position: relative;
                    border: none;
                }
                
                td:before {
                    content: attr(data-label);
                    position: absolute;
                    left: 10px;
                    font-weight: bold;
                    text-align: left;
                }
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .modal-content {
                padding: 20px !important;
                margin: 10px !important;
            }
            
            .login-container {
                padding: 20px;
            }
            
            .logo {
                font-size: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="login-container">
        <div class="logo">üëë</div>
        <h2>Platform Owner Login</h2>
        <div id="loginError"></div>
        <form onsubmit="login(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login_email" required placeholder="owner@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login_password" required placeholder="Enter your password">
            </div>
            <div class="form-group">
                <label>2FA Code <small style="color: #999;">(if enabled)</small></label>
                <input type="text" id="login_2fa_code" maxlength="6" placeholder="123456" style="letter-spacing: 5px; text-align: center;">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Login as Owner</button>
        </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container">
        <div class="header">
            <h1>üëë Platform Owner Dashboard</h1>
            <div class="header-right">
                <div class="user-info">
                    <div class="name" id="ownerName">Owner Name</div>
                    <span class="role">PLATFORM OWNER</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Resellers</h3>
                <div class="number" id="stat_resellers">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Pending Clients (Approval Needed)</h3>
                <div class="number" id="stat_pending">0</div>
            </div>
            <div class="stat-card success">
                <h3>Active Clients</h3>
                <div class="number" id="stat_active_clients">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Invoices Today</h3>
                <div class="number" id="stat_invoices">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('pending')">‚è≥ Pending Approvals</button>
            <button class="tab" onclick="switchTab('resellers')">üë• Resellers</button>
            <button class="tab" onclick="switchTab('clients')">üè¢ All Clients</button>
            <button class="tab" onclick="switchTab('activity')">üìä Activity Feed</button>
            <button class="tab" onclick="switchTab('security')">üîê Security</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="switchTab('add')">‚ûï Add Direct Client</button>
        </div>

        <!-- Tab: Pending Approvals -->
        <div id="tab-pending" class="tab-content active">
            <h2>Pending Client Approvals</h2>
            <p style="color: #666; margin-bottom: 20px;">These clients were added by resellers and need your approval to become active.</p>
            <div id="pendingAlert"></div>
            <table id="pendingTable">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>TIN</th>
                        <th>Email</th>
                        <th>Reseller</th>
                        <th>Added On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pendingList"></tbody>
            </table>
        </div>

        <!-- Approval Modal -->
        <div id="approvalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
            <div style="background: white; max-width: 700px; margin: 30px auto; border-radius: 10px; padding: 30px; position: relative;">
                <button onclick="closeApprovalModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                
                <h2 style="margin-top: 0;">‚úÖ Approve Client Referral</h2>
                
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4299e1;">
                    <h4 style="margin: 0 0 10px 0; color: #2d3748;">Referral Details (from Reseller)</h4>
                    <p style="margin: 5px 0;"><strong>Company:</strong> <span id="ref_company_name"></span></p>
                    <p style="margin: 5px 0;"><strong>Client Name:</strong> <span id="ref_client_name"></span></p>
                    <p style="margin: 5px 0;"><strong>Email:</strong> <span id="ref_email"></span></p>
                    <p style="margin: 5px 0;"><strong>Phone:</strong> <span id="ref_phone"></span></p>
                    <p style="margin: 5px 0;"><strong>TIN:</strong> <span id="ref_tin"></span></p>
                    <p style="margin: 5px 0;"><strong>Device Number:</strong> <span id="ref_device_no"></span></p>
                    <p style="margin: 5px 0;"><strong>Reseller:</strong> <span id="ref_reseller"></span></p>
                </div>

                <div id="approvalAlert"></div>

                <form id="approvalForm" onsubmit="submitApproval(event)">
                    <input type="hidden" id="approval_referral_id">
                    
                    <div class="form-group">
                        <label>Client Login Password * <small style="color: #666;">(visible - you'll send this to the client)</small></label>
                        <input type="text" id="approval_password" required minlength="6" placeholder="Client will use this to login">
                    </div>

                    <div class="form-group">
                        <label>Certificate (.pfx file) *</label>
                        <input type="file" id="approval_pfx_file" accept=".pfx" required>
                    </div>

                    <div class="form-group">
                        <label>Certificate Password * <small style="color: #666;">(visible)</small></label>
                        <input type="text" id="approval_cert_password" required placeholder="Password for the .pfx certificate">
                    </div>

                    <div class="form-group">
                        <label style="font-weight: bold; color: #2d3748;">EFRIS Environment *</label>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="radio" name="approval_efris_env" value="production" checked style="margin-right: 10px;">
                                <div>
                                    <strong>üöÄ Production Environment (Default)</strong>
                                    <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">For real invoices. Uses: efris.ura.go.ug</p>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="approval_efris_env" value="test" style="margin-right: 10px;">
                                <div>
                                    <strong>üß™ Test/Sandbox (Demo only)</strong>
                                    <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">Only for public demo endpoints. Uses: efristest.ura.go.ug</p>
                                </div>
                            </label>
                            <p style="margin-top: 10px; font-size: 11px; color: #e53e3e;">‚ö†Ô∏è Most clients should use Production.</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: bold; color: #2d3748;">ERP/Accounting System *</label>
                        <select id="approval_erp_type" onchange="toggleApprovalERPFields()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                            <option value="none">None - Manual Invoice Entry</option>
                            <option value="quickbooks">QuickBooks Online</option>
                            <option value="xero">Xero</option>
                            <option value="zoho">Zoho Books</option>
                            <option value="sage">Sage</option>
                            <option value="odoo">Odoo</option>
                            <option value="custom">Custom API Integration</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
                            üí° Select the accounting system your client uses. Invoices will sync automatically.
                        </p>
                    </div>

                    <!-- QuickBooks Fields -->
                    <div id="approval_quickbooks_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #2d3748;">üìò QuickBooks Configuration</h4>
                        <div class="form-group">
                            <label>Realm ID (Company ID) *</label>
                            <input type="text" id="approval_qb_realm_id" placeholder="e.g., 123145876921234">
                            <p style="font-size: 11px; color: #666; margin: 3px 0 0 0;">Find in QuickBooks: Settings ‚Üí Your Company ‚Üí Company ID</p>
                        </div>
                        <div class="form-group">
                            <label>Client ID *</label>
                            <input type="text" id="approval_qb_client_id" placeholder="From QuickBooks Developer Portal">
                        </div>
                        <div class="form-group">
                            <label>Client Secret *</label>
                            <input type="password" id="approval_qb_client_secret" placeholder="From QuickBooks Developer Portal">
                        </div>
                        <div class="form-group">
                            <label>Region</label>
                            <select id="approval_qb_region" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                                <option value="US">United States</option>
                                <option value="UK">United Kingdom</option>
                                <option value="AU">Australia</option>
                                <option value="CA">Canada</option>
                            </select>
                        </div>
                    </div>

                    <!-- Xero Fields -->
                    <div id="approval_xero_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #2d3748;">üìó Xero Configuration</h4>
                        <div class="form-group">
                            <label>Tenant ID *</label>
                            <input type="text" id="approval_xero_tenant_id" placeholder="Xero Organization ID">
                        </div>
                        <div class="form-group">
                            <label>Client ID *</label>
                            <input type="text" id="approval_xero_client_id" placeholder="From Xero Developer Portal">
                        </div>
                        <div class="form-group">
                            <label>Client Secret *</label>
                            <input type="password" id="approval_xero_client_secret" placeholder="From Xero Developer Portal">
                        </div>
                    </div>

                    <!-- Zoho Fields -->
                    <div id="approval_zoho_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #2d3748;">üìï Zoho Books Configuration</h4>
                        <div class="form-group">
                            <label>Organization ID *</label>
                            <input type="text" id="approval_zoho_org_id" placeholder="Zoho Organization ID">
                        </div>
                        <div class="form-group">
                            <label>Client ID *</label>
                            <input type="text" id="approval_zoho_client_id" placeholder="From Zoho API Console">
                        </div>
                        <div class="form-group">
                            <label>Client Secret *</label>
                            <input type="password" id="approval_zoho_client_secret" placeholder="From Zoho API Console">
                        </div>
                    </div>

                    <!-- Sage Fields -->
                    <div id="approval_sage_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #2d3748;">üìô Sage Configuration</h4>
                        <div class="form-group">
                            <label>Company ID *</label>
                            <input type="text" id="approval_sage_company_id" placeholder="Sage Company ID">
                        </div>
                        <div class="form-group">
                            <label>API Key *</label>
                            <input type="text" id="approval_sage_api_key" placeholder="From Sage Developer Portal">
                        </div>
                        <div class="form-group">
                            <label>API Secret *</label>
                            <input type="password" id="approval_sage_api_secret" placeholder="From Sage Developer Portal">
                        </div>
                    </div>

                    <!-- Odoo Fields -->
                    <div id="approval_odoo_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #2d3748;">üü£ Odoo Configuration</h4>
                        <div class="form-group">
                            <label>Odoo URL *</label>
                            <input type="text" id="approval_odoo_url" placeholder="https://yourcompany.odoo.com">
                        </div>
                        <div class="form-group">
                            <label>Database Name *</label>
                            <input type="text" id="approval_odoo_db" placeholder="Database name">
                        </div>
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" id="approval_odoo_username" placeholder="Odoo username">
                        </div>
                        <div class="form-group">
                            <label>API Key/Password *</label>
                            <input type="password" id="approval_odoo_password" placeholder="API Key or Password">
                        </div>
                    </div>

                    <!-- Custom API Fields -->
                    <div id="approval_custom_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #2d3748;">üîß Custom API Configuration</h4>
                        <div class="form-group">
                            <label>API URL *</label>
                            <input type="text" id="approval_custom_url" placeholder="https://api.yourcompany.com">
                        </div>
                        <div class="form-group">
                            <label>API Key *</label>
                            <input type="text" id="approval_custom_api_key" placeholder="Your API Key">
                        </div>
                        <div class="form-group">
                            <label>API Secret</label>
                            <input type="password" id="approval_custom_api_secret" placeholder="Optional API Secret">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Approve & Create Client Account</button>
                        <button type="button" class="btn btn-secondary" onclick="closeApprovalModal()" style="flex: 0.3;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab: Resellers -->
        <div id="tab-resellers" class="tab-content">
            <h2>All Resellers</h2>
            <table id="resellersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Clients</th>
                        <th>Subscription</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resellersList"></tbody>
            </table>
        </div>

        <!-- Tab: All Clients -->
        <div id="tab-clients" class="tab-content">
            <h2>All Clients</h2>
            <table id="clientsTable">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>TIN</th>
                        <th>Email</th>
                        <th>Reseller</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientsList"></tbody>
            </table>
        </div>

        <!-- Tab: Activity Feed -->
        <div id="tab-activity" class="tab-content">
            <h2>Activity Feed</h2>
            <p style="color: #666; margin-bottom: 20px;">Real-time tracking of invoices and EFRIS operations across all clients.</p>
            <div id="activityFeed"></div>
        </div>

        <!-- Tab: Add Direct Client -->
        <div id="tab-add" class="tab-content">
            <h2>Add Direct Client</h2>
            <p style="color: #666; margin-bottom: 20px;">Add clients directly without going through resellers.</p>
            <div id="addClientAlert"></div>
            <form onsubmit="addDirectClient(event)">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="add_company_name" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="add_email" required>
                </div>
                <div class="form-group">
                    <label>Password * <small style="color: #666;">(visible - you'll send this to the client)</small></label>
                    <input type="text" id="add_password" required minlength="6" placeholder="Client will use this to login">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="add_phone">
                </div>
                <div class="form-group">
                    <label>TIN *</label>
                    <input type="text" id="add_tin" required>
                </div>
                <div class="form-group">
                    <label>Device Number *</label>
                    <input type="text" id="add_device_no" required>
                </div>
                <div class="form-group">
                    <label>Certificate (.pfx file) *</label>
                    <input type="file" id="add_pfx_file" accept=".pfx" required>
                </div>
                <div class="form-group">
                    <label>Certificate Password * <small style="color: #666;">(visible)</small></label>
                    <input type="text" id="add_cert_password" required placeholder="Password for the .pfx certificate">
                </div>
                <div class="form-group">
                    <label style="font-weight: bold; color: #2d3748;">
                        EFRIS Environment *
                    </label>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="radio" name="efris_env" value="production" id="add_prod_mode" checked style="margin-right: 10px;">
                            <div>
                                <strong>üöÄ Production Environment (Default)</strong>
                                <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">
                                    For real invoices. Uses: efris.ura.go.ug
                                </p>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="radio" name="efris_env" value="test" id="add_test_mode" style="margin-right: 10px;">
                            <div>
                                <strong>üß™ Test/Sandbox (Demo only)</strong>
                                <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">
                                    Only for public demo endpoints. Uses: efristest.ura.go.ug
                                </p>
                            </div>
                        </label>
                        <p style="margin-top: 10px; font-size: 11px; color: #e53e3e;">
                            ‚ö†Ô∏è Most clients should use Production. Only use Test for development/training.
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <label style="font-weight: bold; color: #2d3748;">
                        ERP/Accounting System *
                    </label>
                    <select id="add_erp_type" onchange="toggleERPFields()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                        <option value="none">None - Manual Invoice Entry</option>
                        <option value="quickbooks">QuickBooks Online</option>
                        <option value="xero">Xero</option>
                        <option value="zoho">Zoho Books</option>
                        <option value="sage">Sage</option>
                        <option value="odoo">Odoo</option>
                        <option value="custom">Custom API Integration</option>
                    </select>
                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
                        üí° Select the accounting system your client uses. Invoices will sync automatically.
                    </p>
                </div>

                <!-- QuickBooks Fields -->
                <div id="quickbooks_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìò QuickBooks Configuration</h4>
                    <div class="form-group">
                        <label>Realm ID (Company ID) *</label>
                        <input type="text" id="add_qb_realm_id" placeholder="e.g., 123145876921234">
                        <p style="font-size: 11px; color: #666; margin: 3px 0 0 0;">Find in QuickBooks: Settings ‚Üí Your Company ‚Üí Company ID</p>
                    </div>
                    <div class="form-group">
                        <label>Client ID *</label>
                        <input type="text" id="add_qb_client_id" placeholder="From QuickBooks Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>Client Secret *</label>
                        <input type="password" id="add_qb_client_secret" placeholder="From QuickBooks Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <select id="add_qb_region" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                </div>

                <!-- Xero Fields -->
                <div id="xero_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìó Xero Configuration</h4>
                    <div class="form-group">
                        <label>Tenant ID *</label>
                        <input type="text" id="add_xero_tenant_id" placeholder="Xero Organization ID">
                    </div>
                    <div class="form-group">
                        <label>Client ID *</label>
                        <input type="text" id="add_xero_client_id" placeholder="From Xero Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>Client Secret *</label>
                        <input type="password" id="add_xero_client_secret" placeholder="From Xero Developer Portal">
                    </div>
                </div>

                <!-- Zoho Fields -->
                <div id="zoho_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìï Zoho Books Configuration</h4>
                    <div class="form-group">
                        <label>Organization ID *</label>
                        <input type="text" id="add_zoho_org_id" placeholder="Zoho Organization ID">
                    </div>
                    <div class="form-group">
                        <label>Client ID *</label>
                        <input type="text" id="add_zoho_client_id" placeholder="From Zoho API Console">
                    </div>
                    <div class="form-group">
                        <label>Client Secret *</label>
                        <input type="password" id="add_zoho_client_secret" placeholder="From Zoho API Console">
                    </div>
                </div>

                <!-- Sage Fields -->
                <div id="sage_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üìô Sage Configuration</h4>
                    <div class="form-group">
                        <label>Company ID *</label>
                        <input type="text" id="add_sage_company_id" placeholder="Sage Company ID">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="text" id="add_sage_api_key" placeholder="From Sage Developer Portal">
                    </div>
                    <div class="form-group">
                        <label>API Secret *</label>
                        <input type="password" id="add_sage_api_secret" placeholder="From Sage Developer Portal">
                    </div>
                </div>

                <!-- Odoo Fields -->
                <div id="odoo_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üü£ Odoo Configuration</h4>
                    <div class="form-group">
                        <label>Odoo URL *</label>
                        <input type="text" id="add_odoo_url" placeholder="https://yourcompany.odoo.com">
                    </div>
                    <div class="form-group">
                        <label>Database Name *</label>
                        <input type="text" id="add_odoo_db" placeholder="Database name">
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="add_odoo_username" placeholder="Odoo username">
                    </div>
                    <div class="form-group">
                        <label>API Key/Password *</label>
                        <input type="password" id="add_odoo_password" placeholder="API Key or Password">
                    </div>
                </div>

                <!-- Custom API Fields -->
                <div id="custom_fields" style="display: none; background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #2d3748;">üîß Custom API Configuration</h4>
                    <div class="form-group">
                        <label>API URL *</label>
                        <input type="text" id="add_custom_url" placeholder="https://api.yourcompany.com">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="text" id="add_custom_api_key" placeholder="Your API Key">
                    </div>
                    <div class="form-group">
                        <label>API Secret</label>
                        <input type="password" id="add_custom_api_secret" placeholder="Optional API Secret">
                    </div>
                    <p style="font-size: 12px; color: #666; margin: 10px 0 0 0;">
                        ‚ÑπÔ∏è Your API should return invoices in EFRIS-compatible format
                    </p>
                </div>

                <button type="submit" class="btn btn-primary">Add Client</button>
            </form>
        </div>

        <!-- Tab: Settings -->
        <div id="tab-settings" class="tab-content">
            <h2>‚öôÔ∏è System Settings</h2>
            <p style="color: #666; margin-bottom: 20px;">Manage landing page content, contact information, and system configuration.</p>

            <!-- Filter by Category -->
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; margin-right: 10px;">Filter by Category:</label>
                <select id="settings-category-filter" onchange="loadSettingsByCategory(this.value)" style="padding: 8px 15px; border: 1px solid #cbd5e0; border-radius: 5px;">
                    <option value="all">All Settings</option>
                    <option value="contact">üìß Contact Information</option>
                    <option value="social">üîó Social Media</option>
                    <option value="company">üè¢ Company Info</option>
                    <option value="stats">üìä Statistics</option>
                    <option value="features">üéõÔ∏è Feature Flags</option>
                    <option value="pricing">üí∞ Pricing</option>
                    <option value="email">üìÆ Email Config</option>
                    <option value="system">‚öôÔ∏è System</option>
                </select>
                <button class="btn btn-primary" onclick="reloadSettings()" style="margin-left: 10px;">üîÑ Refresh</button>
            </div>

            <!-- Settings Table -->
            <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div id="settings-loading" style="text-align: center; padding: 40px; color: #666;">
                    Loading settings...
                </div>
                <div id="settings-container" style="display: none;">
                    <table id="settings-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f7fafc;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Setting</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Current Value</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Category</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Public</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="settings-tbody">
                            <!-- Settings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Edit Setting Modal (inline, hidden by default) -->
            <div id="edit-setting-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-top: 0; color: #667eea;">‚úèÔ∏è Edit Setting</h3>
                    <div id="edit-setting-alert"></div>
                    
                    <div style="marginBottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Setting Key:</label>
                        <input type="text" id="edit-setting-key" readonly style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 5px; background: #f7fafc;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Description:</label>
                        <p id="edit-setting-description" style="color: #666; font-size: 14px; margin: 0;"></p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Value:</label>
                        <input type="text" id="edit-setting-value" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                        <textarea id="edit-setting-textarea" style="display: none; width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px; min-height: 100px;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn" onclick="closeEditModal()" style="background: #cbd5e0; color: #2d3748;">Cancel</button>
                        <button class="btn btn-primary" onclick="saveSettingValue()">üíæ Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Security -->
        <div id="tab-security" class="tab-content">
            <h2>üîê Security Management</h2>
            <p style="color: #666; margin-bottom: 20px;">Manage two-factor authentication, IP whitelisting, rate limits, and view security audit logs.</p>

            <!-- 2FA Section -->
            <div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-top: 0; color: #667eea;">üì± Two-Factor Authentication (2FA)</h3>
                <div id="twofa-status" style="margin-bottom: 20px;">
                    <p style="color: #666;">Loading 2FA status...</p>
                </div>
                <div id="twofa-controls">
                    <button id="setup2FABtn" class="btn btn-primary" onclick="setup2FA()" style="display:none;">Enable 2FA</button>
                    <button id="disable2FABtn" class="btn btn-danger" onclick="disable2FA()" style="display:none;">Disable 2FA</button>
                </div>
            </div>

            <!-- Client Security Management -->
            <div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-top: 0; color: #667eea;">üè¢ Client Security Settings</h3>
                <p style="color: #666; margin-bottom: 15px;">Manage IP whitelisting and API rate limits for each client.</p>
                <table id="securityClientsTable">
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>TIN</th>
                            <th>IP Whitelist</th>
                            <th>Rate Limit</th>
                            <th>API Calls Today</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="securityClientsList"></tbody>
                </table>
            </div>

            <!-- Security Audit Logs -->
            <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-top: 0; color: #667eea;">üìã Security Audit Logs</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <select id="auditActionFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">All Actions</option>
                        <option value="login">Login</option>
                        <option value="2fa_enabled">2FA Enabled</option>
                        <option value="2fa_disabled">2FA Disabled</option>
                        <option value="ip_whitelist_updated">IP Whitelist Updated</option>
                        <option value="rate_limit_updated">Rate Limit Updated</option>
                        <option value="rate_limit_exceeded">Rate Limit Exceeded</option>
                        <option value="ip_blocked">IP Blocked</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="loadAuditLogs()">üîç Filter</button>
                    <button class="btn btn-warning btn-sm" onclick="exportAuditLogs()">üì• Export CSV</button>
                </div>
                <div id="auditLogsList" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div id="twoFASetupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="background: white; max-width: 500px; margin: 50px auto; border-radius: 10px; padding: 30px; position: relative;">
            <button onclick="close2FASetupModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            <h2 style="margin-top: 0; color: #667eea;">üì± Enable Two-Factor Authentication</h2>
            <div id="twofa-qr-section">
                <p style="color: #666; margin-bottom: 15px;">Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)</p>
                <div style="text-align: center; margin: 20px 0;">
                    <img id="twofa-qr-image" src="" style="max-width: 250px; border: 2px solid #ddd; padding: 10px; border-radius: 10px;">
                </div>
                <p style="background: #f7fafc; padding: 10px; border-radius: 5px; font-family: monospace; text-align: center; word-break: break-all; font-size: 12px;" id="twofa-secret"></p>
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Enter 6-digit code to verify:</label>
                    <input type="text" id="twofa-verify-code" placeholder="123456" maxlength="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 18px; text-align: center; letter-spacing: 5px;">
                </div>
                <button onclick="enable2FAVerify()" class="btn btn-primary" style="width: 100%; margin-top: 15px;">Verify and Enable 2FA</button>
            </div>
        </div>
    </div>

    <!-- 2FA Disable Modal -->
    <div id="twoFADisableModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="background: white; max-width: 400px; margin: 100px auto; border-radius: 10px; padding: 30px; position: relative;">
            <button onclick="close2FADisableModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            <h2 style="margin-top: 0; color: #dc3545;">‚ö†Ô∏è Disable Two-Factor Authentication</h2>
            <p style="color: #666; margin-bottom: 15px;">Enter your password to confirm disabling 2FA:</p>
            <input type="password" id="twofa-disable-password" placeholder="Your password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
            <button onclick="disable2FAConfirm()" class="btn btn-danger" style="width: 100%;">Disable 2FA</button>
        </div>
    </div>

    <!-- IP Whitelist Modal -->
    <div id="ipWhitelistModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="background: white; max-width: 600px; margin: 50px auto; border-radius: 10px; padding: 30px; position: relative;">
            <button onclick="closeIPWhitelistModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            <h2 style="margin-top: 0; color: #667eea;">üåê IP Whitelist</h2>
            <p style="color: #666; margin-bottom: 10px;">Company: <strong id="ip-company-name"></strong></p>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Add allowed IP addresses (one per line). Use * for wildcards (e.g., 192.168.1.*). Leave empty to allow all IPs.</p>
            <textarea id="ip-whitelist-input" rows="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 13px;" placeholder="192.168.1.100&#10;10.0.0.*&#10;203.45.67.89"></textarea>
            <input type="hidden" id="ip-whitelist-company-id">
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="saveIPWhitelist()" class="btn btn-primary" style="flex: 1;">üíæ Save IP Whitelist</button>
                <button onclick="closeIPWhitelistModal()" class="btn" style="flex: 0.3; background: #6c757d; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rate Limit Modal -->
    <div id="rateLimitModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="background: white; max-width: 500px; margin: 100px auto; border-radius: 10px; padding: 30px; position: relative;">
            <button onclick="closeRateLimitModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            <h2 style="margin-top: 0; color: #667eea;">‚ö° API Rate Limit</h2>
            <p style="color: #666; margin-bottom: 10px;">Company: <strong id="rate-company-name"></strong></p>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Set maximum API requests per day (100-100,000).</p>
            <input type="number" id="rate-limit-input" min="100" max="100000" step="100" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; margin-bottom: 15px;" placeholder="1000">
            <input type="hidden" id="rate-limit-company-id">
            <div style="display: flex; gap: 10px;">
                <button onclick="saveRateLimit()" class="btn btn-primary" style="flex: 1;">üíæ Save Rate Limit</button>
                <button onclick="closeRateLimitModal()" class="btn" style="flex: 0.3; background: #6c757d; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div id="editClientModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
        <div style="background: white; max-width: 600px; margin: 30px auto; border-radius: 10px; padding: 30px; position: relative;">
            <button onclick="closeEditClientModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            <h2 style="margin-top: 0; color: #667eea;">‚úèÔ∏è Edit Client</h2>
            
            <div id="editClientAlert"></div>
            
            <form id="editClientForm" onsubmit="submitEditClient(event)">
                <input type="hidden" id="edit_client_id">
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="edit_email" required style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                </div>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="edit_full_name" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                </div>
                
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="edit_phone" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                </div>
                
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="edit_company_name" required style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                </div>
                
                <div class="form-group">
                    <label>TIN *</label>
                    <input type="text" id="edit_tin" required style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                </div>
                
                <div class="form-group">
                    <label>Device Number</label>
                    <input type="text" id="edit_device_no" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 5px;">
                </div>
                
                <div class="form-group">
                    <label style="font-weight: bold; color: #2d3748;">EFRIS Environment</label>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                            <input type="radio" name="edit_efris_mode" value="production" id="edit_mode_production" style="margin-right: 10px;">
                            <div>
                                <strong>üöÄ Production Environment</strong>
                                <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">For real invoices. Uses: efris.ura.go.ug</p>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="edit_efris_mode" value="test" id="edit_mode_test" style="margin-right: 10px;">
                            <div>
                                <strong>üß™ Test/Sandbox</strong>
                                <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">Only for demo/testing. Uses: efristest.ura.go.ug</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Save Changes</button>
                    <button type="button" class="btn" onclick="closeEditClientModal()" style="flex: 0.3; background: #6c757d; color: white;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(registration => {
                        console.log('‚úì Service Worker registered:', registration.scope);
                    })
                    .catch(err => {
                        console.log('‚úó Service Worker registration failed:', err);
                    });
            });
        }
        
        let token = localStorage.getItem('owner_token');
        let ownerData = null;

        // Check if already logged in
        if (token) {
            // Verify token is still valid before showing dashboard
            fetch('/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(response => {
                if (response.ok) {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadDashboard();
                } else {
                    // Token invalid, clear and show login
                    localStorage.removeItem('owner_token');
                    token = null;
                }
            }).catch(error => {
                // Error verifying token, clear and show login
                console.error('Token verification failed:', error);
                localStorage.removeItem('owner_token');
                token = null;
            });
        }

        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('login_email').value;
            const password = document.getElementById('login_password').value;
            const twoFACode = document.getElementById('login_2fa_code').value;

            console.log('Attempting login...');
            document.getElementById('loginError').innerHTML = '<div class="alert alert-info">Logging in...</div>';

            try {
                const formData = new FormData();
                formData.append('username', email);
                formData.append('password', password);
                
                // Build URL with totp_code as query parameter if provided
                let url = '/api/auth/login';
                if (twoFACode) {
                    url += `?totp_code=${encodeURIComponent(twoFACode)}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                console.log('Login response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Login successful, user role:', data.user.role);
                    
                    // Check if user is owner/admin
                    if (data.user.role !== 'owner' && data.user.role !== 'admin') {
                        document.getElementById('loginError').innerHTML = '<div class="alert alert-danger">Access denied. Only platform owners can access this dashboard.</div>';
                        return;
                    }

                    token = data.access_token;
                    ownerData = data.user;
                    localStorage.setItem('owner_token', token);
                    
                    console.log('Switching to dashboard...');
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    console.log('Loading dashboard data...');
                    await loadDashboard();
                    console.log('Dashboard loaded successfully');
                } else {
                    const error = await response.json();
                    console.error('Login failed:', error);
                    // Show specific error for 2FA
                    if (error.detail === '2FA code required') {
                        document.getElementById('loginError').innerHTML = '<div class="alert alert-warning">üì± 2FA is enabled. Please enter your 6-digit authentication code.</div>';
                        document.getElementById('login_2fa_code').focus();
                    } else {
                        document.getElementById('loginError').innerHTML = `<div class="alert alert-danger">${error.detail || 'Login failed'}</div>`;
                    }
                }
            } catch (error) {
                console.error('Login exception:', error);
                document.getElementById('loginError').innerHTML = `<div class="alert alert-danger">Login failed: ${error.message}</div>`;
            }
        }

        function logout() {
            localStorage.removeItem('owner_token');
            location.reload();
        }

        async function loadDashboard() {
            try {
                console.log('Loading dashboard components...');
                await Promise.all([
                    loadStats(),
                    loadPendingClients(),
                    loadResellers(),
                    loadAllClients(),
                    loadActivity()
                ]);
                console.log('All dashboard components loaded');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard data. Please refresh the page.');
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/owner/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('stat_resellers').textContent = stats.total_resellers || 0;
                    document.getElementById('stat_pending').textContent = stats.pending_clients || 0;
                    document.getElementById('stat_active_clients').textContent = stats.active_clients || 0;
                    document.getElementById('stat_invoices').textContent = stats.invoices_today || 0;
                    document.getElementById('ownerName').textContent = stats.owner_name || 'Owner';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadPendingClients() {
            try {
                const response = await fetch('/api/owner/pending-referrals', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const referrals = data.referrals || [];
                    const tbody = document.getElementById('pendingList');
                    
                    if (referrals.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No pending approvals</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = referrals.map(ref => `
                        <tr>
                            <td>${ref.company_name}</td>
                            <td>${ref.tin}</td>
                            <td>${ref.client_email}</td>
                            <td>${ref.reseller_name}</td>
                            <td>${new Date(ref.submitted_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="approveReferral(${ref.id})">‚úì Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectReferral(${ref.id})">‚úó Reject</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load pending referrals:', error);
            }
        }

        async function loadResellers() {
            try {
                const response = await fetch('/api/owner/resellers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const resellers = await response.json();
                    const tbody = document.getElementById('resellersList');
                    
                    tbody.innerHTML = resellers.map(r => `
                        <tr>
                            <td>${r.full_name}</td>
                            <td>${r.email}</td>
                            <td>${r.phone || 'N/A'}</td>
                            <td>${r.client_count}</td>
                            <td><span class="badge badge-${r.subscription_status}">${r.subscription_status}</span></td>
                            <td><span class="badge badge-${r.status}">${r.status}</span></td>
                            <td>${new Date(r.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="suspendReseller(${r.id})">Suspend</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load resellers:', error);
            }
        }

        async function loadAllClients() {
            try {
                const response = await fetch('/api/owner/clients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    const tbody = document.getElementById('clientsList');
                    
                    tbody.innerHTML = clients.map(c => `
                        <tr>
                            <td>${c.company_name}</td>
                            <td>${c.tin}</td>
                            <td>${c.email}</td>
                            <td>${c.reseller_name || 'Direct'}</td>
                            <td><span class="badge badge-${c.status}">${c.status}</span></td>
                            <td>${new Date(c.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewClientDetails(${c.id})" style="margin: 2px;">View</button>
                                <button class="btn btn-sm" onclick="editClient(${c.id})" style="margin: 2px; background: #17a2b8; color: white;">Edit</button>
                                ${c.status === 'active' ? 
                                    `<button class="btn btn-warning btn-sm" onclick="suspendClient(${c.id}, '${c.email}')" style="margin: 2px;">Suspend</button>` :
                                    c.status === 'suspended' ?
                                    `<button class="btn btn-success btn-sm" onclick="activateClient(${c.id}, '${c.email}')" style="margin: 2px;">Unsuspend</button>` :
                                    ''}
                                <button class="btn btn-danger btn-sm" onclick="deleteClient(${c.id}, '${c.email}', '${c.company_name}')" style="margin: 2px;">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load clients:', error);
            }
        }

        async function viewClientDetails(clientId) {
            try {
                const response = await fetch(`/api/owner/clients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const clients = await response.json();
                const client = clients.find(c => c.id === clientId);
                
                if (!client) {
                    alert('Client not found');
                    return;
                }
                
                // Build API Credentials section (only for Custom ERP)
                let apiCredentialsHtml = '';
                if (client.api_credentials) {
                    const lastUsed = client.api_credentials.api_last_used 
                        ? new Date(client.api_credentials.api_last_used).toLocaleString() 
                        : 'Never';
                    const statusBadge = client.api_credentials.api_enabled 
                        ? '<span class="badge badge-success">‚úÖ Active</span>' 
                        : '<span class="badge badge-danger">‚ùå Disabled</span>';
                    
                    apiCredentialsHtml = `
                        <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">üîå API Integration (Custom ERP)</h4>
                            
                            <div style="margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>Status:</strong> ${statusBadge} <small style="color: #7f8c8d;">Last used: ${lastUsed}</small></p>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">API Key:</label>
                                <div style="display: flex; gap: 5px;">
                                    <input type="text" id="apiKeyInput" value="${client.api_credentials.api_key}" readonly 
                                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;">
                                    <button onclick="copyToClipboard('apiKeyInput')" 
                                            style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">API Secret:</label>
                                <div style="display: flex; gap: 5px;">
                                    <input type="password" id="apiSecretInput" value="${client.api_credentials.api_secret}" readonly 
                                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;">
                                    <button onclick="toggleSecretVisibility()" 
                                            style="background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                        <span id="toggleIcon">üëÅÔ∏è</span>
                                    </button>
                                    <button onclick="copyToClipboard('apiSecretInput')" 
                                            style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">API Endpoint:</label>
                                <code style="display: block; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    ${client.api_credentials.api_endpoint}
                                </code>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button onclick="regenerateAPIKey(${client.company.id})" 
                                        style="flex: 1; background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    üîÑ Regenerate Credentials
                                </button>
                                <button onclick="window.open('/DEVELOPER_PACKAGE/README.md', '_blank')" 
                                        style="flex: 1; background: #9b59b6; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    üìö Documentation
                                </button>
                            </div>
                            
                            <p style="margin-top: 10px; color: #7f8c8d; font-size: 13px;">
                                üí° <strong>Tip:</strong> Give these credentials to the custom ERP developers. See documentation for integration guide.
                            </p>
                        </div>
                    `;
                }
                
                // Create modal HTML
                const modalHtml = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-top: 0; color: #2c3e50;">üìä Client Details</h3>
                            
                            <div style="margin: 20px 0;">
                                <h4 style="color: #7f8c8d; margin-bottom: 10px;">Company Information</h4>
                                <p><strong>Company:</strong> ${client.company_name}</p>
                                <p><strong>TIN:</strong> ${client.tin}</p>
                                <p><strong>Email:</strong> ${client.email}</p>
                                <p><strong>Status:</strong> <span class="badge badge-${client.status}">${client.status}</span></p>
                                <p><strong>Created:</strong> ${new Date(client.created_at).toLocaleString()}</p>
                                ${client.company ? `<p><strong>ERP Type:</strong> ${client.company.erp_type === 'custom' ? 'üîå Custom API' : client.company.erp_type || 'Manual Entry'}</p>` : ''}
                            </div>
                            
                            ${apiCredentialsHtml}
                            
                            <div style="margin: 20px 0;">
                                <h4 style="color: #7f8c8d; margin-bottom: 10px;">Reseller</h4>
                                <p><strong>Managed By:</strong> ${client.reseller_name || 'Direct Client'}</p>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <h4 style="color: #7f8c8d; margin-bottom: 10px;">Quick Actions</h4>
                                
                                <button onclick="showEditERPModal(${client.company.id}, '${client.company.erp_type || 'none'}', '${client.company_name}')" 
                                        style="background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin-bottom: 15px;">
                                    ‚úèÔ∏è Edit ERP Configuration
                                </button>
                                
                                <p style="color: #95a5a6;">Login as this client to:</p>
                                <ul style="color: #7f8c8d;">
                                    <li>View EFRIS connection status</li>
                                    <li>See invoice history</li>
                                    <li>Manage ERP integrations</li>
                                    <li>Access full dashboard</li>
                                </ul>
                                <p style="margin-top: 15px;"><strong>Login URL:</strong> <a href="/client/login" target="_blank" style="color: #3498db;">https://efrisintegration.nafacademy.com/client/login</a></p>
                                <p><strong>Email:</strong> ${client.email}</p>
                            </div>
                            
                            <button onclick="this.closest('[style*=fixed]').remove()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px;">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Failed to load client details:', error);
                alert('Failed to load client details');
            }
        }

        // Helper function: Copy text to clipboard
        function copyToClipboard(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            input.setSelectionRange(0, 99999); // For mobile
            
            navigator.clipboard.writeText(input.value).then(() => {
                // Show temporary success message
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì Copied!';
                btn.style.background = '#27ae60';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#3498db';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // Helper function: Toggle API Secret visibility
        function toggleSecretVisibility() {
            const input = document.getElementById('apiSecretInput');
            const icon = document.getElementById('toggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
            }
        }

        // Helper function: Regenerate API credentials
        async function regenerateAPIKey(companyId) {
            if (!confirm('‚ö†Ô∏è WARNING: Regenerating credentials will:\n\n' +
                        '‚Ä¢ Invalidate the current API key\n' +
                        '‚Ä¢ Break any ERP systems using the old key\n' +
                        '‚Ä¢ Require updating all ERP configurations\n\n' +
                        'Only do this if credentials were compromised!\n\n' +
                        'Are you sure you want to continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/owner/regenerate-api-key/${companyId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ New credentials generated!\n\n` +
                          `New API Key: ${result.api_key}\n\n` +
                          `New API Secret: ${result.api_secret}\n\n` +
                          `‚ö†Ô∏è Copy these now and give to ERP developers. Old credentials are now invalid.`);
                    
                    // Reload client details to show new credentials
                    document.querySelector('[style*=fixed]').remove();
                    loadAllClients();
                } else {
                    const error = await response.json();
                    alert('Failed to regenerate credentials: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showEditERPModal(companyId, currentErpType, companyName) {
            // Close any existing modals
            const existingModals = document.querySelectorAll('[id^="editErpModal"]');
            existingModals.forEach(modal => modal.remove());
            
            const modalHtml = `
                <div id="editErpModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h3 style="margin-top: 0; color: #2c3e50;">‚úèÔ∏è Edit ERP Configuration</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">Company: <strong>${companyName}</strong></p>
                        <p style="color: #e67e22; background: #fef5e7; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
                            ‚ö†Ô∏è Changing ERP type will clear existing ERP credentials. Make sure you have the new credentials ready.
                        </p>
                        
                        <form id="editErpForm" onsubmit="editClientERP(event, ${companyId})">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">New ERP System:</label>
                                <select id="edit_erp_type" name="erp_type" onchange="toggleEditErpFields()" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="none" ${currentErpType === 'none' ? 'selected' : ''}>üìù Manual Entry (No ERP)</option>
                                    <option value="quickbooks" ${currentErpType === 'quickbooks' ? 'selected' : ''}>üìò QuickBooks Online</option>
                                    <option value="xero" ${currentErpType === 'xero' ? 'selected' : ''}>üìó Xero</option>
                                    <option value="zoho" ${currentErpType === 'zoho' ? 'selected' : ''}>üìï Zoho Books</option>
                                    <option value="sage" ${currentErpType === 'sage' ? 'selected' : ''}>üìô Sage</option>
                                    <option value="odoo" ${currentErpType === 'odoo' ? 'selected' : ''}>üü£ Odoo</option>
                                    <option value="custom" ${currentErpType === 'custom' ? 'selected' : ''}>üîß Custom API</option>
                                </select>
                            </div>
                            
                            <!-- QuickBooks Fields -->
                            <div id="edit_qb_fields" style="display: none;">
                                <h4 style="color: #0077c5; margin: 15px 0 10px;">üìò QuickBooks Online</h4>
                                <input type="text" id="edit_qb_realm_id" placeholder="Realm ID (Company ID)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <input type="text" id="edit_qb_client_id" placeholder="Client ID" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <input type="text" id="edit_qb_client_secret" placeholder="Client Secret" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <select id="edit_qb_region" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="US">üá∫üá∏ United States</option>
                                    <option value="UK">üá¨üáß United Kingdom</option>
                                    <option value="AU">üá¶üá∫ Australia</option>
                                    <option value="CA">üá®üá¶ Canada</option>
                                </select>
                            </div>
                            
                            <!-- Custom API Fields -->
                            <div id="edit_custom_fields" style="display: none;">
                                <h4 style="color: #e74c3c; margin: 15px 0 10px;">üîß Custom API</h4>
                                <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 10px;">API credentials will be generated automatically. These are for YOUR custom ERP to connect to this EFRIS API.</p>
                                <input type="text" id="edit_custom_url" placeholder="Custom ERP API URL (optional)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <input type="text" id="edit_custom_api_key" placeholder="Custom ERP API Key (optional)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <input type="text" id="edit_custom_api_secret" placeholder="Custom ERP API Secret (optional)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div id="editErpAlert"></div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" onclick="document.getElementById('editErpModal').remove()" style="flex: 1; background: #95a5a6; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px;">Cancel</button>
                                <button type="submit" style="flex: 1; background: #f39c12; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">üíæ Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            toggleEditErpFields(); // Show appropriate fields based on current selection
        }

        function toggleEditErpFields() {
            const erpType = document.getElementById('edit_erp_type').value;
            
            // Hide all ERP-specific fields
            document.getElementById('edit_qb_fields').style.display = 'none';
            document.getElementById('edit_custom_fields').style.display = 'none';
            
            // Show selected ERP fields
            if (erpType === 'quickbooks') {
                document.getElementById('edit_qb_fields').style.display = 'block';
            } else if (erpType === 'custom') {
                document.getElementById('edit_custom_fields').style.display = 'block';
            }
            // Add other ERP types as needed (xero, zoho, etc.)
        }

        async function editClientERP(event, companyId) {
            event.preventDefault();
            
            const formData = new FormData();
            const erpType = document.getElementById('edit_erp_type').value;
            formData.append('erp_type', erpType);
            
            // Add ERP-specific credentials
            if (erpType === 'quickbooks') {
                formData.append('qb_realm_id', document.getElementById('edit_qb_realm_id').value);
                formData.append('qb_client_id', document.getElementById('edit_qb_client_id').value);
                formData.append('qb_client_secret', document.getElementById('edit_qb_client_secret').value);
                formData.append('qb_region', document.getElementById('edit_qb_region').value);
            } else if (erpType === 'custom') {
                formData.append('custom_url', document.getElementById('edit_custom_url').value || '');
                formData.append('custom_api_key', document.getElementById('edit_custom_api_key').value || '');
                formData.append('custom_api_secret', document.getElementById('edit_custom_api_secret').value || '');
            }
            
            try {
                const response = await fetch(`/api/owner/clients/${companyId}/erp`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Build success message
                    let successMessage = `‚úÖ ERP Configuration Updated!\n\n`;
                    successMessage += `Changed from: ${result.old_erp_type || 'none'}\n`;
                    successMessage += `Changed to: ${result.erp_type}\n`;
                    
                    // If switched to Custom ERP, show API credentials
                    if (result.api_credentials) {
                        successMessage += `\nüîë API Credentials:\n`;
                        successMessage += `API Key: ${result.api_credentials.api_key}\n`;
                        successMessage += `API Secret: ${result.api_credentials.api_secret}\n`;
                        successMessage += `Endpoint: ${result.api_credentials.api_endpoint}\n\n`;
                        
                        if (result.api_credentials.newly_generated) {
                            successMessage += `‚ö†Ô∏è These credentials were just generated. Save them securely!\n`;
                        } else {
                            successMessage += `‚ÑπÔ∏è Using existing API credentials. View in Client Details modal.\n`;
                        }
                    }
                    
                    alert(successMessage);
                    
                    // Close modals and reload
                    document.getElementById('editErpModal').remove();
                    document.querySelector('[style*=fixed]')?.remove(); // Close client details modal
                    loadAllClients();
                } else {
                    const error = await response.json();
                    document.getElementById('editErpAlert').innerHTML = `<div class="alert alert-danger">${error.detail || 'Failed to update ERP configuration'}</div>`;
                }
            } catch (error) {
                console.error('Exception:', error);
                document.getElementById('editErpAlert').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function suspendClient(clientId, email) {
            if (!confirm(`Are you sure you want to SUSPEND ${email}?\n\nThis will:\n- Block their access to the platform\n- Disable all EFRIS operations\n- They won't be able to login`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/owner/suspend-client/${clientId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Client suspended successfully');
                    loadAllClients();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert(`Failed to suspend client: ${error.detail}`);
                }
            } catch (error) {
                console.error('Failed to suspend client:', error);
                alert('Failed to suspend client');
            }
        }

        async function activateClient(clientId, email) {
            if (!confirm(`Are you sure you want to UNSUSPEND (activate) ${email}?\n\nThis will:\n- Restore their access to the platform\n- Enable all EFRIS operations\n- They can login again`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/owner/activate-client/${clientId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Client unsuspended successfully');
                    loadAllClients();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert(`Failed to unsuspend client: ${error.detail}`);
                }
            } catch (error) {
                console.error('Failed to unsuspend client:', error);
                alert('Failed to unsuspend client');
            }
        }

        async function deleteClient(clientId, email, companyName) {
            if (!confirm(`‚ö†Ô∏è DANGER: Delete ${email} (${companyName})?\n\nThis will PERMANENTLY delete:\n- Client account and company\n- All invoices, products, and stock data\n- All purchase orders and credit notes\n- All audit logs and activity\n\n‚ùå THIS CANNOT BE UNDONE!\n\nType the company name to confirm.`)) {
                return;
            }
            
            const confirmName = prompt(`Type the company name "${companyName}" to confirm deletion:`);
            if (confirmName !== companyName) {
                alert('Company name does not match. Deletion cancelled.');
                return;
            }
            
            try {
                const response = await fetch(`/api/owner/delete-client/${clientId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Client permanently deleted');
                    loadAllClients();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete client: ${error.detail}`);
                }
            } catch (error) {
                console.error('Failed to delete client:', error);
                alert('Failed to delete client');
            }
        }

        async function editClient(clientId) {
            try {
                const response = await fetch(`/api/owner/clients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const clients = await response.json();
                const client = clients.find(c => c.id === clientId);
                
                if (!client) {
                    alert('Client not found');
                    return;
                }
                
                // Populate form
                document.getElementById('edit_client_id').value = client.id;
                document.getElementById('edit_email').value = client.email || '';
                document.getElementById('edit_full_name').value = client.full_name || '';
                document.getElementById('edit_phone').value = client.phone || '';
                document.getElementById('edit_company_name').value = client.company_name || '';
                document.getElementById('edit_tin').value = client.tin || '';
                document.getElementById('edit_device_no').value = client.company?.device_no || '';
                
                // Set EFRIS mode radio button - efris_test_mode is in company object
                if (client.company?.efris_test_mode) {
                    document.getElementById('edit_mode_test').checked = true;
                } else {
                    document.getElementById('edit_mode_production').checked = true;
                }
                
                // Show modal
                document.getElementById('editClientModal').style.display = 'block';
            } catch (error) {
                console.error('Failed to load client details:', error);
                alert('Failed to load client details');
            }
        }

        function closeEditClientModal() {
            document.getElementById('editClientModal').style.display = 'none';
            document.getElementById('editClientAlert').innerHTML = '';
        }

        async function submitEditClient(e) {
            e.preventDefault();
            
            const clientId = document.getElementById('edit_client_id').value;
            const formData = new FormData();
            formData.append('email', document.getElementById('edit_email').value);
            formData.append('full_name', document.getElementById('edit_full_name').value);
            formData.append('phone', document.getElementById('edit_phone').value);
            formData.append('company_name', document.getElementById('edit_company_name').value);
            formData.append('tin', document.getElementById('edit_tin').value);
            formData.append('device_no', document.getElementById('edit_device_no').value);
            
            const isTestMode = document.getElementById('edit_mode_test').checked;
            formData.append('efris_test_mode', isTestMode ? 'true' : 'false');
            
            try {
                const response = await fetch(`/api/owner/edit-client/${clientId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Client updated successfully!\n\nEFRIS Mode: ${isTestMode ? 'Test/Sandbox üß™' : 'Production üöÄ'}`);
                    closeEditClientModal();
                    loadAllClients();
                } else {
                    const error = await response.json();
                    document.getElementById('editClientAlert').innerHTML = `
                        <div style="padding: 15px; background: #fee; border-left: 4px solid #e53e3e; border-radius: 5px; margin-bottom: 15px;">
                            ‚ùå ${error.detail}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to update client:', error);
                document.getElementById('editClientAlert').innerHTML = `
                    <div style="padding: 15px; background: #fee; border-left: 4px solid #e53e3e; border-radius: 5px; margin-bottom: 15px;">
                        ‚ùå Failed to update client. Please try again.
                    </div>
                `;
            }
        }

        async function loadActivity() {
            try {
                const response = await fetch('/api/owner/activity', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const activities = await response.json();
                    const feed = document.getElementById('activityFeed');
                    
                    if (activities.length === 0) {
                        feed.innerHTML = '<div class="empty-state">No recent activity</div>';
                        return;
                    }
                    
                    feed.innerHTML = activities.map(a => `
                        <div class="activity-item">
                            <div class="activity-time">${new Date(a.created_at).toLocaleString()}</div>
                            <div class="activity-details">
                                <strong>${a.company_name}</strong> - ${a.activity_type}
                                ${a.document_number ? `<br>Document: ${a.document_number}` : ''}
                                ${a.efris_request_type ? `<br>EFRIS: ${a.efris_request_type} - <span class="badge badge-${a.efris_status}">${a.efris_status}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load activity:', error);
            }
        }

        async function approveClient(clientId) {
            if (!confirm('Approve this client? They will be able to use the platform.')) return;
            
            try {
                const response = await fetch(`/api/owner/approve-client/${clientId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    document.getElementById('pendingAlert').innerHTML = '<div class="alert alert-success">Client approved successfully!</div>';
                    setTimeout(() => document.getElementById('pendingAlert').innerHTML = '', 3000);
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert('Failed to approve client: ' + error.detail);
                }
            } catch (error) {
                alert('Failed to approve client');
            }
        }

        async function rejectClient(clientId) {
            const reason = prompt('Reason for rejection (optional):');
            
            try {
                const response = await fetch(`/api/owner/reject-client/${clientId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    document.getElementById('pendingAlert').innerHTML = '<div class="alert alert-success">Client rejected</div>';
                    setTimeout(() => document.getElementById('pendingAlert').innerHTML = '', 3000);
                    loadDashboard();
                } else {
                    alert('Failed to reject client');
                }
            } catch (error) {
                alert('Failed to reject client');
            }
        }

        let selectedReferralId = null;
        let currentReferralData = null;

        function approveReferral(referralId) {
            // Find the referral data
            const response = fetch('/api/owner/pending-referrals', {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(res => res.json()).then(data => {
                const referral = data.referrals.find(r => r.id === referralId);
                if (!referral) {
                    alert('Referral not found');
                    return;
                }
                
                // Populate modal with referral details
                currentReferralData = referral;
                document.getElementById('approval_referral_id').value = referralId;
                document.getElementById('ref_company_name').textContent = referral.company_name;
                document.getElementById('ref_client_name').textContent = referral.client_name;
                document.getElementById('ref_email').textContent = referral.client_email;
                document.getElementById('ref_phone').textContent = referral.client_phone || 'N/A';
                document.getElementById('ref_tin').textContent = referral.tin;
                document.getElementById('ref_device_no').textContent = referral.device_no || 'N/A';
                document.getElementById('ref_reseller').textContent = referral.reseller_name;
                
                // Show modal
                document.getElementById('approvalModal').style.display = 'block';
            }).catch(error => {
                console.error('Failed to load referral:', error);
                alert('Failed to load referral details');
            });
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').style.display = 'none';
            document.getElementById('approvalForm').reset();
            document.getElementById('approvalAlert').innerHTML = '';
        }

        async function submitApproval(event) {
            event.preventDefault();
            
            const referralId = document.getElementById('approval_referral_id').value;
            const password = document.getElementById('approval_password').value;
            const certPassword = document.getElementById('approval_cert_password').value;
            const testMode = document.querySelector('input[name="approval_efris_env"]:checked').value === 'test';
            const pfxFile = document.getElementById('approval_pfx_file').files[0];
            const erpType = document.getElementById('approval_erp_type').value;
            
            if (!pfxFile) {
                alert('Please select a certificate file');
                return;
            }
            
            const formData = new FormData();
            formData.append('password', password);
            formData.append('cert_password', certPassword);
            formData.append('test_mode', testMode);
            formData.append('pfx_file', pfxFile);
            formData.append('erp_type', erpType);
            
            // Add ERP-specific credentials
            if (erpType === 'quickbooks') {
                formData.append('qb_realm_id', document.getElementById('approval_qb_realm_id').value);
                formData.append('qb_client_id', document.getElementById('approval_qb_client_id').value);
                formData.append('qb_client_secret', document.getElementById('approval_qb_client_secret').value);
                formData.append('qb_region', document.getElementById('approval_qb_region').value);
            } else if (erpType === 'xero') {
                formData.append('xero_tenant_id', document.getElementById('approval_xero_tenant_id').value);
                formData.append('xero_client_id', document.getElementById('approval_xero_client_id').value);
                formData.append('xero_client_secret', document.getElementById('approval_xero_client_secret').value);
            } else if (erpType === 'zoho') {
                formData.append('zoho_org_id', document.getElementById('approval_zoho_org_id').value);
                formData.append('zoho_client_id', document.getElementById('approval_zoho_client_id').value);
                formData.append('zoho_client_secret', document.getElementById('approval_zoho_client_secret').value);
            } else if (erpType === 'sage') {
                formData.append('sage_company_id', document.getElementById('approval_sage_company_id').value);
                formData.append('sage_api_key', document.getElementById('approval_sage_api_key').value);
                formData.append('sage_api_secret', document.getElementById('approval_sage_api_secret').value);
            } else if (erpType === 'odoo') {
                formData.append('odoo_url', document.getElementById('approval_odoo_url').value);
                formData.append('odoo_db', document.getElementById('approval_odoo_db').value);
                formData.append('odoo_username', document.getElementById('approval_odoo_username').value);
                formData.append('odoo_password', document.getElementById('approval_odoo_password').value);
            } else if (erpType === 'custom') {
                formData.append('custom_url', document.getElementById('approval_custom_url').value);
                formData.append('custom_api_key', document.getElementById('approval_custom_api_key').value);
                formData.append('custom_api_secret', document.getElementById('approval_custom_api_secret').value || '');
            }
            
            try {
                const response = await fetch(`/api/owner/approve-referral/${referralId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const erpNames = {
                        'none': 'Manual Entry',
                        'quickbooks': 'QuickBooks Online',
                        'xero': 'Xero',
                        'zoho': 'Zoho Books',
                        'sage': 'Sage',
                        'odoo': 'Odoo',
                        'custom': 'Custom API'
                    };
                    const erpMsg = result.erp_configured ? ` ERP: ${erpNames[erpType]}` : '';
                    
                    let successMsg = `<div class="alert alert-success">‚úÖ Client approved successfully! Account created.${erpMsg}`;
                    
                    // Show API credentials if Custom ERP
                    if (result.api_credentials) {
                        successMsg += `
                            <hr>
                            <h4>üîë API Credentials for Custom ERP Developers:</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace;">
                                <p><strong>API Key:</strong><br/>
                                <input type="text" value="${result.api_credentials.api_key}" readonly 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;"
                                       onclick="this.select()" />
                                </p>
                                <p><strong>API Secret:</strong><br/>
                                <input type="text" value="${result.api_credentials.api_secret}" readonly 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;"
                                       onclick="this.select()" />
                                </p>
                                <p><strong>API Endpoint:</strong><br/>
                                <code>${result.api_credentials.api_endpoint}</code>
                                </p>
                                <p><strong>üìö Documentation:</strong> ${result.api_credentials.documentation}</p>
                            </div>
                            <p style="margin-top: 10px;"><small>‚ö†Ô∏è Copy these credentials now! Give them to the ERP development team.</small></p>
                        `;
                    }
                    
                    successMsg += '</div>';
                    document.getElementById('approvalAlert').innerHTML = successMsg;
                    
                    // Don't auto-close if API credentials shown - give time to copy
                    const autoCloseDelay = result.api_credentials ? 30000 : 2000;
                    setTimeout(() => {
                        closeApprovalModal();
                        loadDashboard();
                    }, autoCloseDelay);
                } else {
                    const error = await response.json();
                    document.getElementById('approvalAlert').innerHTML = 
                        `<div class="alert alert-danger">Failed: ${error.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                document.getElementById('approvalAlert').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function rejectReferral(referralId) {
            const reason = prompt('Reason for rejection:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/owner/reject-referral/${referralId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    document.getElementById('pendingAlert').innerHTML = '<div class="alert alert-success">Referral rejected</div>';
                    setTimeout(() => document.getElementById('pendingAlert').innerHTML = '', 3000);
                    loadDashboard();
                } else {
                    alert('Failed to reject referral');
                }
            } catch (error) {
                alert('Failed to reject referral');
            }
        }

        function toggleERPFields() {
            const erpType = document.getElementById('add_erp_type').value;
            
            // Hide all ERP fields
            document.getElementById('quickbooks_fields').style.display = 'none';
            document.getElementById('xero_fields').style.display = 'none';
            document.getElementById('zoho_fields').style.display = 'none';
            document.getElementById('sage_fields').style.display = 'none';
            document.getElementById('odoo_fields').style.display = 'none';
            document.getElementById('custom_fields').style.display = 'none';
            
            // Show selected ERP fields
            if (erpType === 'quickbooks') {
                document.getElementById('quickbooks_fields').style.display = 'block';
            } else if (erpType === 'xero') {
                document.getElementById('xero_fields').style.display = 'block';
            } else if (erpType === 'zoho') {
                document.getElementById('zoho_fields').style.display = 'block';
            } else if (erpType === 'sage') {
                document.getElementById('sage_fields').style.display = 'block';
            } else if (erpType === 'odoo') {
                document.getElementById('odoo_fields').style.display = 'block';
            } else if (erpType === 'custom') {
                document.getElementById('custom_fields').style.display = 'block';
            }
        }

        function toggleApprovalERPFields() {
            const erpType = document.getElementById('approval_erp_type').value;
            
            // Hide all approval ERP fields
            document.getElementById('approval_quickbooks_fields').style.display = 'none';
            document.getElementById('approval_xero_fields').style.display = 'none';
            document.getElementById('approval_zoho_fields').style.display = 'none';
            document.getElementById('approval_sage_fields').style.display = 'none';
            document.getElementById('approval_odoo_fields').style.display = 'none';
            document.getElementById('approval_custom_fields').style.display = 'none';
            
            // Show selected ERP fields
            if (erpType === 'quickbooks') {
                document.getElementById('approval_quickbooks_fields').style.display = 'block';
            } else if (erpType === 'xero') {
                document.getElementById('approval_xero_fields').style.display = 'block';
            } else if (erpType === 'zoho') {
                document.getElementById('approval_zoho_fields').style.display = 'block';
            } else if (erpType === 'sage') {
                document.getElementById('approval_sage_fields').style.display = 'block';
            } else if (erpType === 'odoo') {
                document.getElementById('approval_odoo_fields').style.display = 'block';
            } else if (erpType === 'custom') {
                document.getElementById('approval_custom_fields').style.display = 'block';
            }
        }

        async function addDirectClient(e) {
            e.preventDefault();
            
            // Get selected environment (test or production)
            const isTestMode = document.querySelector('input[name="efris_env"]:checked').value === 'test';
            const erpType = document.getElementById('add_erp_type').value;
            
            const formData = new FormData();
            formData.append('company_name', document.getElementById('add_company_name').value);
            formData.append('email', document.getElementById('add_email').value);
            formData.append('password', document.getElementById('add_password').value);
            formData.append('phone', document.getElementById('add_phone').value);
            formData.append('tin', document.getElementById('add_tin').value);
            formData.append('device_no', document.getElementById('add_device_no').value);
            formData.append('cert_password', document.getElementById('add_cert_password').value);
            formData.append('test_mode', isTestMode);
            formData.append('pfx_file', document.getElementById('add_pfx_file').files[0]);
            formData.append('erp_type', erpType);
            
            // Add ERP-specific credentials
            if (erpType === 'quickbooks') {
                formData.append('qb_realm_id', document.getElementById('add_qb_realm_id').value);
                formData.append('qb_client_id', document.getElementById('add_qb_client_id').value);
                formData.append('qb_client_secret', document.getElementById('add_qb_client_secret').value);
                formData.append('qb_region', document.getElementById('add_qb_region').value);
            } else if (erpType === 'xero') {
                formData.append('xero_tenant_id', document.getElementById('add_xero_tenant_id').value);
                formData.append('xero_client_id', document.getElementById('add_xero_client_id').value);
                formData.append('xero_client_secret', document.getElementById('add_xero_client_secret').value);
            } else if (erpType === 'zoho') {
                formData.append('zoho_org_id', document.getElementById('add_zoho_org_id').value);
                formData.append('zoho_client_id', document.getElementById('add_zoho_client_id').value);
                formData.append('zoho_client_secret', document.getElementById('add_zoho_client_secret').value);
            } else if (erpType === 'sage') {
                formData.append('sage_company_id', document.getElementById('add_sage_company_id').value);
                formData.append('sage_api_key', document.getElementById('add_sage_api_key').value);
                formData.append('sage_api_secret', document.getElementById('add_sage_api_secret').value);
            } else if (erpType === 'odoo') {
                formData.append('odoo_url', document.getElementById('add_odoo_url').value);
                formData.append('odoo_db', document.getElementById('add_odoo_db').value);
                formData.append('odoo_username', document.getElementById('add_odoo_username').value);
                formData.append('odoo_password', document.getElementById('add_odoo_password').value);
            } else if (erpType === 'custom') {
                formData.append('custom_url', document.getElementById('add_custom_url').value);
                formData.append('custom_api_key', document.getElementById('add_custom_api_key').value);
                formData.append('custom_api_secret', document.getElementById('add_custom_api_secret').value || '');
            }
            
            try {
                console.log('Attempting to add client...', { token: token ? 'present' : 'missing' });
                
                const response = await fetch('/api/owner/add-client', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Success:', result);
                    
                    // Show success message with client login URL
                    const loginUrl = result.client_login_url || 'https://efrisintegration.nafacademy.com/client/login';
                    const email = result.client_email;
                    const password = document.getElementById('add_password').value;
                    const environment = isTestMode ? 'üß™ Test/Sandbox' : 'üöÄ Production';
                    const envUrl = isTestMode ? 'efristest.ura.go.ug' : 'efris.ura.go.ug';
                    
                    // ERP configuration message
                    const erpNames = {
                        'none': 'üìù Manual Invoice Entry',
                        'quickbooks': 'üìò QuickBooks Online',
                        'xero': 'üìó Xero',
                        'zoho': 'üìï Zoho Books',
                        'sage': 'üìô Sage',
                        'odoo': 'üü£ Odoo',
                        'custom': 'üîß Custom API'
                    };
                    const erpMessage = result.erp_configured ? 
                        `<p style="margin: 8px 0;"><strong>ERP System:</strong> ${erpNames[erpType] || erpType} (Pre-configured ‚úÖ)</p>` :
                        `<p style="margin: 8px 0;"><strong>ERP System:</strong> ${erpNames['none']}</p>`;
                    
                    // API credentials section for Custom ERP
                    let apiCredentialsHtml = '';
                    if (result.api_credentials) {
                        apiCredentialsHtml = `
                            <hr style="margin: 10px 0;">
                            <p style="margin: 8px 0;"><strong>üîë API Credentials (for Custom ERP):</strong></p>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 8px 0;">
                                <p style="margin: 5px 0; font-family: monospace; font-size: 11px;"><strong>API Key:</strong> ${result.api_credentials.api_key}</p>
                                <p style="margin: 5px 0; font-family: monospace; font-size: 11px;"><strong>API Secret:</strong> ${result.api_credentials.api_secret}</p>
                                <p style="margin: 5px 0; font-family: monospace; font-size: 11px;"><strong>Endpoint:</strong> ${result.api_credentials.api_endpoint}</p>
                                <p style="margin: 8px 0; font-size: 11px; color: #856404; background: #fff3cd; padding: 8px; border-radius: 4px;">
                                    ‚ö†Ô∏è <strong>Important:</strong> Save these credentials securely! You can view them later in the Client Details modal.
                                </p>
                            </div>
                        `;
                    }
                    
                    document.getElementById('addClientAlert').innerHTML = `
                        <div class="alert alert-success">
                            <h4 style="margin-bottom: 15px;">‚úÖ Client Added Successfully!</h4>
                            <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
                                <p style="margin: 5px 0;"><strong>üìß Send these details to your client:</strong></p>
                                <hr style="margin: 10px 0;">
                                <p style="margin: 8px 0;"><strong>Login URL:</strong> <a href="${loginUrl}" target="_blank" style="color: #007bff;">${loginUrl}</a></p>
                                <p style="margin: 8px 0;"><strong>Email:</strong> ${email}</p>
                                <p style="margin: 8px 0;"><strong>Password:</strong> ${password}</p>
                                <p style="margin: 8px 0;"><strong>EFRIS Environment:</strong> ${environment} (${envUrl})</p>
                                ${erpMessage}
                                ${apiCredentialsHtml}
                                <hr style="margin: 10px 0;">
                                <p style="margin: 8px 0; font-size: 12px; color: #666;">
                                    ${result.erp_configured ? 
                                        '‚úÖ Ready to use! Invoices will sync automatically from their ERP system.' :
                                        'üìù Client can manually create invoices or configure ERP later.'}
                                </p>
                                <p style="margin: 8px 0; font-size: 12px; color: #666;">
                                    ‚ö†Ô∏è Important: Have your client bookmark the login URL. This is their dedicated client portal.
                                </p>
                            </div>
                            <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                        </div>
                    `;
                    e.target.reset();
                    loadDashboard();
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    try {
                        const error = JSON.parse(errorText);
                        document.getElementById('addClientAlert').innerHTML = `<div class="alert alert-danger">${error.detail || 'Failed to add client'}</div>`;
                    } catch {
                        document.getElementById('addClientAlert').innerHTML = `<div class="alert alert-danger">Failed to add client (Status: ${response.status})</div>`;
                    }
                }
            } catch (error) {
                console.error('Exception:', error);
                document.getElementById('addClientAlert').innerHTML = `<div class="alert alert-danger">Failed to add client: ${error.message}</div>`;
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Load security data when security tab is opened
            if (tabName === 'security') {
                check2FAStatus();
                loadSecurityClients();
                loadAuditLogs();
            }
            
            // Load settings when settings tab is opened
            if (tabName === 'settings') {
                loadAllSettings();
            }
        }

        // ========== 2FA FUNCTIONS ==========
        
        async function check2FAStatus() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await response.json();
                
                const statusDiv = document.getElementById('twofa-status');
                if (user.totp_enabled) {
                    statusDiv.innerHTML = `
                        <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 5px;">
                            <strong style="color: #155724;">‚úÖ 2FA is ENABLED</strong>
                            <p style="color: #155724; margin: 5px 0 0 0; font-size: 14px;">Your account is protected with two-factor authentication.</p>
                        </div>`;
                    document.getElementById('setup2FABtn').style.display = 'none';
                    document.getElementById('disable2FABtn').style.display = 'inline-block';
                } else {
                    statusDiv.innerHTML = `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px;">
                            <strong style="color: #856404;">‚ö†Ô∏è 2FA is DISABLED</strong>
                            <p style="color: #856404; margin: 5px 0 0 0; font-size: 14px;">Enable 2FA to add an extra layer of security to your account.</p>
                        </div>`;
                    document.getElementById('setup2FABtn').style.display = 'inline-block';
                    document.getElementById('disable2FABtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking 2FA status:', error);
            }
        }

        async function setup2FA() {
            try {
                const response = await fetch('/api/auth/2fa/setup', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('twofa-qr-image').src = data.qr_code;
                    document.getElementById('twofa-secret').textContent = `Secret Key: ${data.secret}`;
                    document.getElementById('twoFASetupModal').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Failed to setup 2FA: ' + error.detail);
                }
            } catch (error) {
                alert('Error setting up 2FA: ' + error.message);
            }
        }

        async function enable2FAVerify() {
            const code = document.getElementById('twofa-verify-code').value;
            if (code.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }

            try {
                const response = await fetch(`/api/auth/2fa/enable?totp_code=${code}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('‚úÖ 2FA enabled successfully!');
                    close2FASetupModal();
                    check2FAStatus();
                } else {
                    const error = await response.json();
                    alert('Invalid code: ' + error.detail);
                }
            } catch (error) {
                alert('Error enabling 2FA: ' + error.message);
            }
        }

        function close2FASetupModal() {
            document.getElementById('twoFASetupModal').style.display = 'none';
            document.getElementById('twofa-verify-code').value = '';
        }

        function disable2FA() {
            document.getElementById('twoFADisableModal').style.display = 'block';
        }

        async function disable2FAConfirm() {
            const password = document.getElementById('twofa-disable-password').value;
            if (!password) {
                alert('Please enter your password');
                return;
            }

            try {
                const response = await fetch(`/api/auth/2fa/disable?password=${encodeURIComponent(password)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('‚úÖ 2FA disabled successfully');
                    close2FADisableModal();
                    check2FAStatus();
                } else {
                    const error = await response.json();
                    alert('Failed to disable 2FA: ' + error.detail);
                }
            } catch (error) {
                alert('Error disabling 2FA: ' + error.message);
            }
        }

        function close2FADisableModal() {
            document.getElementById('twoFADisableModal').style.display = 'none';
            document.getElementById('twofa-disable-password').value = '';
        }

        // ========== CLIENT SECURITY MANAGEMENT ==========

        async function loadSecurityClients() {
            try {
                const response = await fetch('/api/owner/clients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const clients = await response.json();
                
                const tbody = document.getElementById('securityClientsList');
                tbody.innerHTML = '';
                
                clients.forEach(client => {
                    const company = client.company;
                    const allowedIps = company.allowed_ips ? JSON.parse(company.allowed_ips) : [];
                    const ipCount = allowedIps.length;
                    const ipDisplay = ipCount === 0 ? 'üåê All IPs' : `${ipCount} IP(s)`;
                    
                    const row = `
                        <tr>
                            <td>${company.name}</td>
                            <td>${company.tin}</td>
                            <td>${ipDisplay}</td>
                            <td>${company.api_rate_limit || 1000} req/day</td>
                            <td>${company.api_calls_today || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="openIPWhitelistModal(${company.id}, '${company.name.replace(/'/g, "\\'")}', ${JSON.stringify(allowedIps).replace(/"/g, '&quot;')})">üåê IP Whitelist</button>
                                <button class="btn btn-sm btn-warning" onclick="openRateLimitModal(${company.id}, '${company.name.replace(/'/g, "\\'")}', ${company.api_rate_limit || 1000})">‚ö° Rate Limit</button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading security clients:', error);
            }
        }

        function openIPWhitelistModal(companyId, companyName, allowedIps) {
            document.getElementById('ip-company-name').textContent = companyName;
            document.getElementById('ip-whitelist-company-id').value = companyId;
            document.getElementById('ip-whitelist-input').value = allowedIps.join('\n');
            document.getElementById('ipWhitelistModal').style.display = 'block';
        }

        function closeIPWhitelistModal() {
            document.getElementById('ipWhitelistModal').style.display = 'none';
        }

        async function saveIPWhitelist() {
            const companyId = document.getElementById('ip-whitelist-company-id').value;
            const ipsText = document.getElementById('ip-whitelist-input').value;
            const allowedIps = ipsText.split('\n').map(ip => ip.trim()).filter(ip => ip.length > 0);

            try {
                const response = await fetch(`/api/owner/clients/${companyId}/ip-whitelist`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(allowedIps)
                });

                if (response.ok) {
                    alert('‚úÖ IP whitelist updated successfully');
                    closeIPWhitelistModal();
                    loadSecurityClients();
                } else {
                    const error = await response.json();
                    alert('Failed to update IP whitelist: ' + error.detail);
                }
            } catch (error) {
                alert('Error updating IP whitelist: ' + error.message);
            }
        }

        function openRateLimitModal(companyId, companyName, currentLimit) {
            document.getElementById('rate-company-name').textContent = companyName;
            document.getElementById('rate-limit-company-id').value = companyId;
            document.getElementById('rate-limit-input').value = currentLimit;
            document.getElementById('rateLimitModal').style.display = 'block';
        }

        function closeRateLimitModal() {
            document.getElementById('rateLimitModal').style.display = 'none';
        }

        async function saveRateLimit() {
            const companyId = document.getElementById('rate-limit-company-id').value;
            const rateLimit = parseInt(document.getElementById('rate-limit-input').value);

            if (rateLimit < 100 || rateLimit > 100000) {
                alert('Rate limit must be between 100 and 100,000');
                return;
            }

            try {
                const response = await fetch(`/api/owner/clients/${companyId}/rate-limit?rate_limit=${rateLimit}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('‚úÖ Rate limit updated successfully');
                    closeRateLimitModal();
                    loadSecurityClients();
                } else {
                    const error = await response.json();
                    alert('Failed to update rate limit: ' + error.detail);
                }
            } catch (error) {
                alert('Error updating rate limit: ' + error.message);
            }
        }

        // ========== AUDIT LOGS ==========

        async function loadAuditLogs() {
            const action = document.getElementById('auditActionFilter').value;
            try {
                let url = '/api/owner/audit-logs?limit=100';
                if (action) url += `&action=${action}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('auditLogsList');
                if (data.logs.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No audit logs found</p>';
                    return;
                }
                
                container.innerHTML = data.logs.map(log => {
                    const actionColors = {
                        'login': '#28a745',
                        '2fa_enabled': '#007bff',
                        '2fa_disabled': '#ffc107',
                        'ip_whitelist_updated': '#17a2b8',
                        'rate_limit_updated': '#6f42c1',
                        'rate_limit_exceeded': '#dc3545',
                        'ip_blocked': '#dc3545'
                    };
                    const color = actionColors[log.action] || '#6c757d';
                    
                    return `
                        <div style="border-left: 4px solid ${color}; background: #f8f9fa; padding: 12px; margin-bottom: 10px; border-radius: 5px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong style="color: ${color};">${log.action.toUpperCase().replace(/_/g, ' ')}</strong>
                                    <p style="margin: 5px 0; color: #666; font-size: 14px;">${log.details}</p>
                                    <small style="color: #999;">üë§ ${log.user_email}${log.company_name ? ' ‚Ä¢ üè¢ ' + log.company_name : ''}</small>
                                </div>
                                <small style="color: #999; white-space: nowrap;">${new Date(log.timestamp).toLocaleString()}</small>
                            </div>
                        </div>`;
                }).join('');
            } catch (error) {
                console.error('Error loading audit logs:', error);
            }
        }

        async function exportAuditLogs() {
            const action = document.getElementById('auditActionFilter').value;
            let url = '/api/owner/audit-logs?limit=1000';
            if (action) url += `&action=${action}`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // Convert to CSV
                const headers = ['Timestamp', 'Action', 'User', 'Company', 'Details'];
                const rows = data.logs.map(log => [
                    new Date(log.timestamp).toISOString(),
                    log.action,
                    log.user_email,
                    log.company_name || '',
                    log.details
                ]);
                
                const csv = [headers, ...rows].map(row => 
                    row.map(cell => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(',')
                ).join('\n');
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url_obj = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url_obj;
                a.download = `audit_logs_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url_obj);
            } catch (error) {
                alert('Error exporting audit logs: ' + error.message);
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (document.getElementById('dashboard').style.display === 'block') {
                loadStats();
                loadActivity();
            }
        }, 30000);

        // ========== SETTINGS MANAGEMENT FUNCTIONS ==========
        
        let allSettingsData = [];
        
        async function loadAllSettings() {
            try {
                document.getElementById('settings-loading').style.display = 'block';
                document.getElementById('settings-container').style.display = 'none';
                
                const response = await fetch('/api/settings/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load settings');
                
                allSettingsData = await response.json();
                renderSettingsTable(allSettingsData);
                
                document.getElementById('settings-loading').style.display = 'none';
                document.getElementById('settings-container').style.display = 'block';
            } catch (error) {
                document.getElementById('settings-loading').innerHTML = `
                    <div style="color: #dc3545; padding: 20px;">
                        <strong>Error loading settings:</strong> ${error.message}
                    </div>`;
            }
        }
        
        function renderSettingsTable(settings) {
            const tbody = document.getElementById('settings-tbody');
            tbody.innerHTML = '';
            
            if (settings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No settings found</td></tr>';
                return;
            }
            
            settings.forEach(setting => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e2e8f0';
                
                // Setting Key
                const keyCell = document.createElement('td');
                keyCell.style.padding = '12px';
                keyCell.innerHTML = `
                    <div style="font-weight: bold; color: #2d3748;">${setting.setting_key}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">${setting.description || ''}</div>
                `;
                row.appendChild(keyCell);
                
                // Current Value
                const valueCell = document.createElement('td');
                valueCell.style.padding = '12px';
                let displayValue = setting.setting_value || '<em style="color: #999;">Empty</em>';
                if (setting.setting_type === 'password') {
                    displayValue = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                } else if (displayValue.length > 50) {
                    displayValue = displayValue.substring(0, 47) + '...';
                }
                valueCell.innerHTML = `<code style="background: #f7fafc; padding: 4px 8px; border-radius: 4px; font-size: 13px;">${displayValue}</code>`;
                row.appendChild(valueCell);
                
                // Category
                const categoryCell = document.createElement('td');
                categoryCell.style.padding = '12px';
                const categoryColors = {
                    'contact': '#667eea',
                    'social': '#48bb78',
                    'company': '#ed8936',
                    'stats': '#f56565',
                    'features': '#9f7aea',
                    'pricing': '#38b2ac',
                    'email': '#ecc94b',
                    'system': '#4299e1'
                };
                const bgColor = categoryColors[setting.category] || '#cbd5e0';
                categoryCell.innerHTML = `<span style="background: ${bgColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${setting.category}</span>`;
                row.appendChild(categoryCell);
                
                // Public Badge
                const publicCell = document.createElement('td');
                publicCell.style.padding = '12px';
                publicCell.innerHTML = setting.is_public ? 
                    '<span style="background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">PUBLIC</span>' :
                    '<span style="background: #f8d7da; color: #721c24; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">PRIVATE</span>';
                row.appendChild(publicCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.style.padding = '12px';
                actionsCell.style.textAlign = 'center';
                actionsCell.innerHTML = `<button class="btn btn-primary" onclick='editSetting(${JSON.stringify(setting)})' style="font-size: 12px; padding: 6px 12px;">‚úèÔ∏è Edit</button>`;
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }
        
        function loadSettingsByCategory(category) {
            if (category === 'all') {
                renderSettingsTable(allSettingsData);
            } else {
                const filtered = allSettingsData.filter(s => s.category === category);
                renderSettingsTable(filtered);
            }
        }
        
        function reloadSettings() {
            loadAllSettings();
        }
        
        function editSetting(setting) {
            document.getElementById('edit-setting-key').value = setting.setting_key;
            document.getElementById('edit-setting-description').textContent = setting.description || '';
            
            const inputField = document.getElementById('edit-setting-value');
            const textareaField = document.getElementById('edit-setting-textarea');
            
            if (setting.setting_type === 'textarea') {
                inputField.style.display = 'none';
                textareaField.style.display = 'block';
                textareaField.value = setting.setting_value || '';
            } else {
                inputField.style.display = 'block';
                textareaField.style.display = 'none';
                inputField.type = setting.setting_type === 'password' ? 'text' : 'text'; // Show even passwords for editing
                inputField.value = setting.setting_value || '';
            }
            
            document.getElementById('edit-setting-modal').style.display = 'flex';
        }
        
        function closeEditModal() {
            document.getElementById('edit-setting-modal').style.display = 'none';
            document.getElementById('edit-setting-alert').innerHTML = '';
        }
        
        async function saveSettingValue() {
            const key = document.getElementById('edit-setting-key').value;
            const inputField = document.getElementById('edit-setting-value');
            const textareaField = document.getElementById('edit-setting-textarea');
            const value = inputField.style.display === 'none' ? textareaField.value : inputField.value;
            const alertDiv = document.getElementById('edit-setting-alert');
            
            try {
                const response = await fetch(`/api/settings/${key}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ setting_value: value })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alertDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 15px;">‚úÖ Setting updated successfully!</div>';
                    
                    // Reload settings after 1 second
                    setTimeout(() => {
                        closeEditModal();
                        loadAllSettings();
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px;">‚ùå Error: ${result.detail || 'Failed to update setting'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px;">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
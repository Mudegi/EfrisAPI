<!DOCTYPE html>
<html>
<head>
    <title>EFRIS Multi-Tenant Control Panel</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 3rem;
            width: 100%;
            max-width: 440px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }

        .error-message.show {
            display: block;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: none;
        }

        .dashboard-container.active {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 1.5rem;
            background: #34495e;
            border-bottom: 2px solid #2c3e50;
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }



        .nav-menu {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #95a5a6;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 0.875rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            font-size: 0.95rem;
            color: #ecf0f1;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-left-color: #667eea;
            color: white;
        }

        .nav-icon {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Sidebar Footer - Minimal */
        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
            font-size: 0.75rem;
            color: #95a5a6;
            text-align: center;
        }

        /* Status Dot */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #95a5a6;
        }

        .status-dot.connected {
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .topbar h2 {
            color: #2c3e50;
            font-size: 1.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .topbar-center {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            justify-content: center;
        }

        .topbar-company {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .topbar-company select {
            padding: 0.625rem 1rem;
            background: #f8f9fa;
            color: #2c3e50;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 200px;
        }

        .topbar-company select:focus {
            outline: none;
            border-color: #667eea;
        }

        .topbar-qb-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #856404;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .topbar-qb-status:hover {
            background: #ffc107;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }

        .topbar-qb-status.connected {
            background: #e8f5e9;
            border-color: #27ae60;
            color: #27ae60;
            cursor: default;
        }

        .topbar-qb-status.connected:hover {
            transform: none;
            box-shadow: none;
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .topbar-user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .topbar-user:hover {
            background: #e9ecef;
        }

        .topbar-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
        }

        .topbar-user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .btn-icon {
            padding: 0.625rem;
            background: white;
            color: #e74c3c;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .btn-icon:hover {
            background: #e74c3c;
            color: white;
            transform: translateY(-2px);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue { background: #e3f2fd; }
        .stat-icon.green { background: #e8f5e9; }
        .stat-icon.orange { background: #fff3e0; }
        .stat-icon.purple { background: #f3e5f5; }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: #2ecc71;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h3 {
            color: #2c3e50;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8f9fa;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            color: #34495e;
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.375rem 0.875rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Text Utilities */
        .text-success {
            color: #28a745 !important;
            font-weight: 600;
        }

        .text-muted {
            color: #6c757d !important;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
            min-width: 300px;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid #2ecc71;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-message {
            color: #2c3e50;
            font-size: 0.9rem;
            flex: 1;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .dashboard-container.active {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
            }
            
            .sidebar-header {
                display: none;
            }
            
            .nav-menu {
                display: flex;
                flex-direction: row;
                padding: 0;
            }
            
            .nav-section {
                display: flex;
                margin: 0;
            }
            
            .nav-section-title {
                display: none;
            }
            
            .nav-item {
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .nav-item.active {
                border-bottom-color: #667eea;
            }
            
            .sidebar-footer {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .topbar {
                padding: 0.75rem 1rem;
                flex-wrap: wrap;
            }
            
            .topbar h2 {
                font-size: 1.25rem;
            }
            
            .topbar-center {
                order: 3;
                width: 100%;
                margin-top: 0.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.75rem;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
            }
            
            .tab {
                font-size: 0.85rem;
                padding: 0.75rem 1rem;
                white-space: nowrap;
            }
            
            .card {
                padding: 1rem;
            }
            
            .card-header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            table th, table td {
                padding: 0.5rem 0.25rem;
            }
            
            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.85rem;
            }
            
            .modal-overlay {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            .login-box {
                padding: 2rem 1.5rem;
            }
            
            .login-header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <h1>üñ•Ô∏è Taxpayer Control Panel</h1>
                <p>EFRIS Integration - Submit Invoices & Manage Products</p>
            </div>

            <div class="error-message" id="loginError"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        placeholder="your-email@company.com"
                        required
                        autocomplete="email"
                    >
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        placeholder="Enter your password"
                        required
                        autocomplete="current-password"
                    >
                </div>

                <button type="submit" class="btn-primary" id="loginBtn">
                    Sign In to Control Panel
                </button>
            </form>
            
            <p style="text-align: center; margin-top: 1.5rem; color: #7f8c8d; font-size: 0.9rem;">
                Are you a reseller/agent? <a href="/reseller" style="color: #667eea; font-weight: 600;">Go to Reseller Portal</a>
            </p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-container" id="dashboardScreen">
        <div class="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <h1>ÔøΩ EFRIS Manager</h1>
            </div>

            <!-- Navigation Menu -->
            <div class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <div class="nav-item active" onclick="switchTab('overview')" data-tab="overview">
                        <span class="nav-icon">üìä</span>
                        <span>Overview</span>
                    </div>
                </div>

                <div class="nav-section" id="erpRecordsSection">
                    <div class="nav-section-title" id="erpNavTitle">üìò QuickBooks Records</div>
                    <div class="nav-item" onclick="switchTab('qb-items')" data-tab="qb-items">
                        <span class="nav-icon">üì¶</span>
                        <span>Items</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('qb-invoices')" data-tab="qb-invoices">
                        <span class="nav-icon">üìÑ</span>
                        <span>Invoices</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('qb-purchase-orders')" data-tab="qb-purchase-orders">
                        <span class="nav-icon">üìã</span>
                        <span>Purchase Orders</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('qb-credit-memos')" data-tab="qb-credit-memos">
                        <span class="nav-icon">üìù</span>
                        <span>Credit Memos</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">üá∫üá¨ EFRIS Records</div>
                    <div class="nav-item" onclick="switchTab('products')" data-tab="products">
                        <span class="nav-icon">üì¶</span>
                        <span>Products</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('invoices')" data-tab="invoices">
                        <span class="nav-icon">üìÑ</span>
                        <span>Invoices</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('excise-codes')" data-tab="excise-codes">
                        <span class="nav-icon">üè∑Ô∏è</span>
                        <span>Excise Codes</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('purchase-orders')" data-tab="purchase-orders">
                        <span class="nav-icon">üìã</span>
                        <span>Purchase Orders</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('credit-memos')" data-tab="credit-memos">
                        <span class="nav-icon">üìù</span>
                        <span>Credit Notes</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('settings')" data-tab="settings">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </div>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                v2.0 ‚Ä¢ Multi-Tenant
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="topbar">
                <h2 id="pageTitle">Dashboard</h2>
                
                <div class="topbar-center">
                    <div class="topbar-company">
                        <span style="font-size: 0.85rem; color: #7f8c8d;">üè¢</span>
                        <select id="companySelect" onchange="switchCompany()">
                            <option value="">Loading companies...</option>
                        </select>
                    </div>
                    
                    <div class="topbar-qb-status" id="topbarERPStatus" onclick="handleERPStatusClick()" title="Click to connect ERP">
                        <div class="status-dot" id="erpStatusDot"></div>
                        <span id="erpStatusText">üîó Click to Connect ERP</span>
                    </div>
                </div>
                
                <div class="topbar-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <span>üîÑ</span> Refresh
                    </button>
                    
                    <div class="topbar-user" onclick="toggleUserMenu()">
                        <div class="topbar-avatar" id="userAvatar">A</div>
                        <span class="topbar-user-name" id="userName">Loading...</span>
                    </div>
                    
                    <button class="btn-icon" onclick="handleLogout()" title="Sign Out">
                        üö™
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- ERP Connection Banner -->
                <div id="erpConnectionBanner" style="display: none; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; font-size: 1.2rem;">‚ö†Ô∏è <span id="erpConnectionBannerText">Connect Your Accounting Software</span></h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;" id="erpConnectionSubtext">Connect QuickBooks, Xero, or Zoho to automatically sync invoices and products</p>
                        </div>
                        <button onclick="handleERPConnect()" id="erpConnectButton" style="background: white; color: #f5576c; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                            Connect Now ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- ERP Connected Success Banner -->
                <div id="erpConnectedBanner" style="display: none; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; font-size: 1.2rem;"><span id="erpConnectedIcon">‚úÖ</span> <span id="connectedERPName">QuickBooks</span> Connected</h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">Last synced: <span id="lastSyncTime">Just now</span></p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="syncERPData()" id="erpSyncButton" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;">
                                üîÑ Sync Now
                            </button>
                            <button onclick="disconnectERP()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;">
                                Disconnect
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Overview Tab -->
                <div class="tab-content active" id="overview-tab">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue">üì¶</div>
                            </div>
                            <div class="stat-label">Total Products</div>
                            <div class="stat-value" id="totalProducts">-</div>
                            <div class="stat-trend">‚Üó Active in system</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green">üìÑ</div>
                            </div>
                            <div class="stat-label">Total Invoices</div>
                            <div class="stat-value" id="totalInvoices">-</div>
                            <div class="stat-trend">‚Üó Processed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon orange">‚úÖ</div>
                            </div>
                            <div class="stat-label">EFRIS Synced</div>
                            <div class="stat-value" id="syncedItems">-</div>
                            <div class="stat-trend">‚Üó Synchronized</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon purple">üè¢</div>
                            </div>
                            <div class="stat-label">Company Status</div>
                            <div class="stat-value" style="font-size: 1.2rem;">
                                <span class="badge badge-success" id="companyStatus">Active</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Company Information</h3>
                        </div>
                        <div class="card-body" id="companyInfo">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading company information...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QB Items Tab -->
                <div class="tab-content" id="qb-items-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>QuickBooks Items</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" id="qbItemsSearch" placeholder="üîç Search items..." style="padding:0.5rem 1rem; border:2px solid #e0e0e0; border-radius:6px; font-size:0.9rem; width:250px;" oninput="searchQBItems(this.value)" />
                                <button class="btn btn-primary" onclick="importFromQuickBooks('items')">üì• Import from QuickBooks</button>
                            </div>
                        </div>
                        <div class="card-body" id="qbItemsContent">
                            <p style="color: #7f8c8d;">No items imported yet. Click "Import from QuickBooks" to fetch and save items.</p>
                        </div>
                    </div>
                </div>

                <!-- QB Invoices Tab -->
                <div class="tab-content" id="qb-invoices-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>QuickBooks Invoices</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" id="qbInvoicesSearch" placeholder="üîç Search invoices..." style="padding:0.5rem 1rem; border:2px solid #e0e0e0; border-radius:6px; font-size:0.9rem; width:250px;" oninput="searchQBInvoices(this.value)" onkeypress="if(event.key==='Enter'){searchQBInvoices(this.value)}" />
                                <button class="btn btn-primary" onclick="importFromQuickBooks('invoices')">üì• Import from QuickBooks</button>
                                <button class="btn btn-secondary" onclick="syncQBInvoicesWithEFRIS()">üîÑ Sync with EFRIS</button>
                            </div>
                        </div>
                        <div class="card-body" id="qbInvoicesContent">
                            <p style="color: #7f8c8d;">No invoices imported yet. Click "Import from QuickBooks" to fetch and save invoices.</p>
                        </div>
                    </div>
                </div>

                <!-- QB Purchase Orders Tab -->
                <div class="tab-content" id="qb-purchase-orders-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>QuickBooks Purchase Orders</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" id="qbPurchaseOrdersSearch" placeholder="üîç Search purchase orders..." style="padding:0.5rem 1rem; border:2px solid #e0e0e0; border-radius:6px; font-size:0.9rem; width:250px;" oninput="searchQBPurchaseOrders(this.value)" onkeypress="if(event.key==='Enter'){searchQBPurchaseOrders(this.value)}" />
                                <button class="btn btn-primary" onclick="importFromQuickBooks('purchase-orders')">üì• Import from QuickBooks</button>
                            </div>
                        </div>
                        <div class="card-body" id="qbPurchaseOrdersContent">
                            <p style="color: #7f8c8d;">No purchase orders imported yet. Click "Import from QuickBooks" to fetch and save.</p>
                        </div>
                    </div>
                </div>

                <!-- QB Credit Memos Tab -->
                <div class="tab-content" id="qb-credit-memos-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>QuickBooks Credit Memos</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" id="qbCreditMemosSearch" placeholder="üîç Search credit memos..." style="padding:0.5rem 1rem; border:2px solid #e0e0e0; border-radius:6px; font-size:0.9rem; width:250px;" oninput="searchQBCreditMemos(this.value)" onkeypress="if(event.key==='Enter'){searchQBCreditMemos(this.value)}" />
                                <button class="btn btn-primary" onclick="importFromQuickBooks('credit-memos')">üì• Import from QuickBooks</button>
                            </div>
                        </div>
                        <div class="card-body" id="qbCreditMemosContent">
                            <p style="color: #7f8c8d;">No credit memos imported yet. Click "Import from QuickBooks" to fetch and save.</p>
                        </div>
                    </div>
                </div>

                <!-- Products Tab -->
                <div class="tab-content" id="products-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>Products & Services</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" id="productsSearch" placeholder="üîç Search products..." style="padding:0.5rem 1rem; border:2px solid #e0e0e0; border-radius:6px; font-size:0.9rem; width:250px;" oninput="searchProducts(this.value)" onkeypress="if(event.key==='Enter'){searchProducts(this.value)}" />
                                <button class="btn btn-secondary" onclick="importFromEFRIS('products')">üì• Import from EFRIS</button>
                                <button class="btn btn-secondary" onclick="refreshStockLevels()">üîÑ Refresh Stock</button>
                                <button class="btn btn-success" onclick="syncProductsToEFRIS()">‚úÖ Sync to EFRIS</button>
                            </div>
                        </div>
                        <div class="card-body" id="productsContent">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading products...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoices Tab -->
                <div class="tab-content" id="invoices-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>Invoice Management</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" id="invoicesSearch" placeholder="üîç Search invoices..." style="padding:0.5rem 1rem; border:2px solid #e0e0e0; border-radius:6px; font-size:0.9rem; width:250px;" oninput="searchInvoices(this.value)" onkeypress="if(event.key==='Enter'){searchInvoices(this.value)}" />
                                <button class="btn btn-secondary" onclick="importFromEFRIS('invoices')">üì• Import from EFRIS</button>
                                <button class="btn btn-success" onclick="syncInvoicesToEFRIS()">‚úÖ Sync to EFRIS</button>
                            </div>
                        </div>
                        <div class="card-body" id="invoicesContent">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading invoices...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Excise Codes Tab -->
                <div class="tab-content" id="excise-codes-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>üè∑Ô∏è Excise Duty Codes</h3>
                            <div style="display:flex; gap:0.5rem;">
                                <button class="btn btn-warning" onclick="refreshExciseCodesTab()" title="Query fresh excise codes from EFRIS">
                                    üîÑ Refresh from EFRIS
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="exciseCodesContent">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading excise codes...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchase Orders Tab -->
                <div class="tab-content" id="purchase-orders-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>Purchase Orders</h3>
                            <div style="display:flex; gap:0.5rem;">
                                <button class="btn btn-secondary" onclick="importFromEFRIS('purchase-orders')">üì• Import from EFRIS</button>
                                <button class="btn btn-success" onclick="syncPurchaseOrdersToEFRIS()">‚úÖ Sync to EFRIS</button>
                            </div>
                        </div>
                        <div class="card-body" id="purchaseOrdersContent">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <p>No purchase orders found. Import from QuickBooks to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Credit Memos Tab -->
                <div class="tab-content" id="credit-memos-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>Credit Memos</h3>
                            <div style="display:flex; gap:0.5rem;">
                                <button class="btn btn-secondary" onclick="importFromEFRIS('credit-memos')">üì• Import from EFRIS</button>
                                <button class="btn btn-success" onclick="syncCreditMemosToEFRIS()">‚úÖ Sync to EFRIS</button>
                            </div>
                        </div>
                        <div class="card-body" id="creditMemosContent">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <p>No credit memos found. Import from QuickBooks to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-content" id="settings-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3>Company Settings</h3>
                        </div>
                        <div class="card-body" id="settingsContent">
                            <!-- QuickBooks Connection Section -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                                <h4 style="margin: 0 0 15px 0; color: #2c3e50; display: flex; align-items: center;">
                                    <span style="margin-right: 10px;">üìò</span>
                                    QuickBooks Integration
                                </h4>
                                
                                <!-- QB Connection Status -->
                                <div id="qbConnectionStatus" style="margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                        <span id="qbStatusBadge" style="background: #95a5a6; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-right: 15px;">
                                            ‚è≥ Checking...
                                        </span>
                                        <span id="qbStatusText" style="font-weight: 600;">Checking QuickBooks connection...</span>
                                    </div>
                                    
                                    <div id="qbCompanyInfo" style="display: none; background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div>
                                                <label style="font-weight: 600; color: #34495e;">Company Name:</label>
                                                <span id="qbCompanyName" style="display: block; color: #2c3e50; margin-top: 5px;"></span>
                                            </div>
                                            <div>
                                                <label style="font-weight: 600; color: #34495e;">QB Region:</label>
                                                <span id="qbRegion" style="display: block; color: #2c3e50; margin-top: 5px;"></span>
                                            </div>
                                            <div>
                                                <label style="font-weight: 600; color: #34495e;">Realm ID:</label>
                                                <span id="qbRealmId" style="display: block; color: #7f8c8d; font-family: monospace; margin-top: 5px;"></span>
                                            </div>
                                            <div>
                                                <label style="font-weight: 600; color: #34495e;">Connected Since:</label>
                                                <span id="qbConnectedSince" style="display: block; color: #7f8c8d; margin-top: 5px;"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- QB Actions -->
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <button id="connectQBBtn" onclick="connectQuickBooks()" 
                                            style="padding: 12px 24px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                                        <span style="margin-right: 8px;">üîó</span>
                                        Connect QuickBooks
                                    </button>
                                    
                                    <button id="connectNewQBBtn" onclick="connectNewQuickBooksSandbox()" 
                                            style="padding: 12px 24px; background: #f39c12; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                                        <span style="margin-right: 8px;">üîÑ</span>
                                        Connect New QB Sandbox
                                    </button>
                                    
                                    <button id="switchQBBtn" onclick="switchQuickBooksCompany()" 
                                            style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                                        <span style="margin-right: 8px;">üîÑ</span>
                                        Switch QB Company (Same Instance)
                                    </button>
                                    
                                    <button id="disconnectQBBtn" onclick="disconnectQuickBooks()" 
                                            style="padding: 12px 24px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                                        <span style="margin-right: 8px;">üîå</span>
                                        Disconnect QuickBooks
                                    </button>
                                    
                                    <button id="refreshQBBtn" onclick="refreshQuickBooksStatus()" 
                                            style="padding: 12px 24px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        <span style="margin-right: 8px;">‚Üª</span>
                                        Refresh Status
                                    </button>
                                </div>
                            </div>
                            
                            <!-- EFRIS Settings Section -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #9b59b6;">
                                <h4 style="margin: 0 0 15px 0; color: #2c3e50; display: flex; align-items: center;">
                                    <span style="margin-right: 10px;">üá∫üá¨</span>
                                    EFRIS Configuration
                                </h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">TIN:</label>
                                        <span id="efrisTIN" style="display: block; color: #2c3e50; margin-top: 5px; font-family: monospace;">Loading...</span>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">Device Number:</label>
                                        <span id="efrisDevice" style="display: block; color: #2c3e50; margin-top: 5px; font-family: monospace;">Loading...</span>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">Environment:</label>
                                        <span id="efrisEnv" style="display: block; color: #2c3e50; margin-top: 5px;">Loading...</span>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">Certificate:</label>
                                        <span id="efrisCert" style="display: block; color: #2c3e50; margin-top: 5px;">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Company Information Section -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #f39c12;">
                                <h4 style="margin: 0 0 15px 0; color: #2c3e50; display: flex; align-items: center;">
                                    <span style="margin-right: 10px;">üè¢</span>
                                    Company Information
                                </h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">Company ID:</label>
                                        <span id="companyId" style="display: block; color: #2c3e50; margin-top: 5px; font-family: monospace;"></span>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">Company Name:</label>
                                        <span id="companyName" style="display: block; color: #2c3e50; margin-top: 5px;"></span>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">Created:</label>
                                        <span id="companyCreated" style="display: block; color: #7f8c8d; margin-top: 5px;"></span>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #34495e;">Last Updated:</label>
                                        <span id="companyUpdated" style="display: block; color: #7f8c8d; margin-top: 5px;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Invoice Modal -->
    <div id="editInvoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 1200px; width: 95%; max-height: 95vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); margin: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #3498db; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #2c3e50;">üìù Review & Submit Invoice to EFRIS</h2>
                <button onclick="closeInvoiceModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #7f8c8d;">&times;</button>
            </div>

            <!-- Basic Information Section -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">Basic Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">Invoice Number</label>
                        <input type="text" id="invoiceNumber" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #e9ecef;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">Customer</label>
                        <input type="text" id="invoiceCustomer" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #e9ecef;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">Invoice Date *</label>
                        <input type="date" id="invoiceDate" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">Buyer Type *</label>
                        <select id="invoiceBuyerType" required onchange="toggleCustomerTIN()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="1">Individual (No TIN required)</option>
                            <option value="0">Business (TIN required)</option>
                            <option value="2">Foreign</option>
                            <option value="3">Tax Exempt Organization</option>
                        </select>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #34495e;">
                            Customer TIN <span id="tinRequired" style="color: red; display: none;">*</span>
                        </label>
                        <input type="text" id="invoiceCustomerTIN" placeholder="Optional for Individual, Required for Business" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <small style="color: #7f8c8d;">Leave empty if customer is Individual</small>
                    </div>
                </div>
            </div>

            <!-- Line Items Section -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">Line Items</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #3498db; color: white;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Item</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Qty</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Unit Price</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Discount</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Tax Rate</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Excise</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceItemsBody" style="font-size: 14px;">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Invoice Summary Section -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">Invoice Summary</h3>
                <div style="background: white; padding: 25px; border-radius: 8px; border: 2px solid #dee2e6;">
                    <table style="width: 100%; max-width: 500px; margin: 0 auto; font-size: 16px;">
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 10px; font-weight: 500;">Subtotal:</td>
                            <td style="padding: 10px; text-align: right;">UGX <span id="summarySubtotal">0.00</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 10px; color: #dc3545; font-weight: 500;">Total Discount:</td>
                            <td style="padding: 10px; text-align: right; color: #dc3545; font-weight: 500;">-UGX <span id="summaryDiscount">0.00</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 10px; color: #e83e8c; font-weight: 500;">Total Excise Duty:</td>
                            <td style="padding: 10px; text-align: right; color: #e83e8c; font-weight: 500;">UGX <span id="summaryExcise">0.00</span></td>
                        </tr>
                        <tr style="border-bottom: 2px solid #495057;">
                            <td style="padding: 10px; color: #28a745; font-weight: 500;">Total VAT:</td>
                            <td style="padding: 10px; text-align: right; color: #28a745; font-weight: 500;">UGX <span id="summaryVAT">0.00</span></td>
                        </tr>
                        <tr style="background: #28a745; color: white;">
                            <td style="padding: 15px; font-size: 20px; font-weight: bold;">GRAND TOTAL:</td>
                            <td style="padding: 15px; text-align: right; font-size: 20px; font-weight: bold;">UGX <span id="summaryGrandTotal">0.00</span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                <button onclick="closeInvoiceModal()" style="padding: 12px 25px; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">
                    Cancel
                </button>
                <button onclick="submitInvoiceToEFRIS()" id="submitInvoiceBtn" style="padding: 12px 25px; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">
                    üíæ Save & Submit to EFRIS
                </button>
            </div>
        </div>
    </div>

    <!-- View Purchase Order Modal -->
    <div id="viewPOModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50;" id="poModalTitle">Purchase Order Details</h3>
                <button onclick="closePOModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d;">&times;</button>
            </div>
            
            <div id="poModalContent" style="font-size: 14px;">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Edit Item for EFRIS Modal -->
    <div id="editItemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50;">Edit Item for EFRIS Registration</h3>
                <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d;">&times;</button>
            </div>
            
            <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong id="editItemName" style="font-size: 18px; color: #2c3e50;"></strong>
                <p id="editItemTypeDisplay" style="margin: 5px 0 0 0; color: #7f8c8d;"></p>
            </div>

            <form id="editItemForm" onsubmit="saveItemMetadata(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">
                        Product Code (from QuickBooks)
                        <span style="font-weight: normal; color: #7f8c8d; font-size: 12px;">- Auto-populated</span>
                    </label>
                    <input type="text" id="editProductCode" class="form-input" placeholder="e.g., PROD001" required readonly
                           style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 14px; background: #ecf0f1; cursor: not-allowed;">
                    <small style="color: #7f8c8d;">
                        üìå From QuickBooks Description field (or Product/Service Name if empty)
                    </small>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">
                        UNSPSC / Commodity Code
                        <span style="font-weight: normal; color: #7f8c8d; font-size: 12px;">- From SKU field</span>
                    </label>
                    <input type="text" id="editCommodityCode" class="form-input" placeholder="e.g., 50202306" required 
                           style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 14px;">
                    <small style="color: #7f8c8d;">UNSPSC classification code from QuickBooks SKU field</small>
                </div>

                <div id="unitOfMeasureField" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">Unit of Measure</label>
                    
                    <!-- Searchable Unit of Measure Dropdown -->
                    <div style="position: relative;">
                        <input type="text" 
                               id="editUnitOfMeasureSearch" 
                               class="form-input" 
                               placeholder="Search units of measure..."
                               style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 14px;"
                               onkeyup="filterUnitsOfMeasure()"
                               onfocus="showUnitDropdown()"
                               onblur="hideUnitDropdown()">
                        
                        <!-- Hidden select for form submission -->
                        <select id="editUnitOfMeasure" style="display: none;" required>
                            <option value="">Loading units...</option>
                        </select>
                        
                        <!-- Dropdown list -->
                        <div id="unitDropdown" 
                             style="display: none; position: absolute; top: 100%; left: 0; right: 0; 
                                    background: white; border: 1px solid #bdc3c7; border-top: none; 
                                    border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; 
                                    z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="padding: 8px; color: #7f8c8d; font-style: italic;">Loading...</div>
                        </div>
                    </div>
                    
                    <small style="color: #7f8c8d;">Search and select the unit of measure for this item</small>
                </div>

                <input type="hidden" id="editItemType" value="">

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="editHasExcise" onchange="toggleExciseFields()" 
                               style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #2c3e50;">Item has Excise Duty</span>
                    </label>
                </div>

                <div id="exciseFields" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff9e6; border-radius: 8px; border: 1px solid #f39c12;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">Excise Duty Code</label>
                    <select id="editExciseDutyCode" class="form-input" 
                            style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 14px;">
                        <option value="">Select excise code...</option>
                        <option value="LED050000">LED050000 - Beer (5%)</option>
                        <option value="LED100000">LED100000 - Spirits (10%)</option>
                        <option value="LED150000">LED150000 - Cigarettes (15%)</option>
                        <option value="LED190100">LED190100 - Soft Drinks (19.01%)</option>
                        <option value="LED200000">LED200000 - Wines (20%)</option>
                    </select>
                    <small style="color: #e67e22; display: block; margin-top: 5px;">‚ö†Ô∏è Select the appropriate excise duty code for this item</small>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #e8f8f5; border-radius: 8px; border: 1px solid #16a085;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="editIsZeroRated" 
                                   style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: bold; color: #2c3e50;">Zero-Rated (0% VAT)</span>
                        </label>
                        <small style="color: #16a085; display: block; margin-left: 28px; margin-top: 4px;">
                            ‚úì Applies 0% VAT (e.g., exports, certain food items)
                        </small>
                    </div>
                    
                    <div>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="editIsExempt" 
                                   style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: bold; color: #2c3e50;">Tax Exempt</span>
                        </label>
                        <small style="color: #16a085; display: block; margin-left: 28px; margin-top: 4px;">
                            ‚úì Completely exempt from VAT (e.g., medical supplies, education)
                        </small>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" name="action" value="save_and_register" class="btn" style="flex: 1; background: #27ae60; color: white; padding: 12px;">
                        üíæ Save & Register to EFRIS
                    </button>
                    <button type="button" onclick="closeEditModal()" class="btn" style="flex: 1; background: #95a5a6; color: white; padding: 12px;">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">‚úì</span>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <script>
        // ===========================
        // PWA Service Worker Registration
        // ===========================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(registration => {
                        console.log('‚úì Service Worker registered:', registration.scope);
                    })
                    .catch(err => {
                        console.log('‚úó Service Worker registration failed:', err);
                    });
            });
        }
        
        // Configuration
        const API_BASE = 'http://localhost:8001';
        
        // State
        let authToken = null;
        let currentUser = null;
        let currentCompany = null;
        let companies = [];
        let qbConnected = false;
        
        // ERP Configuration - Dynamically loaded based on company.erp_type
        const ERP_CONFIGS = {
            QUICKBOOKS: {
                name: "QuickBooks",
                icon: "üìò",
                color: "#2ca01c",
                navTitle: "QuickBooks Records",
                connectText: "Connect QuickBooks",
                syncButtonText: "Import from QuickBooks",
                authUrl: "/api/quickbooks/auth",
                supportsOAuth: true
            },
            XERO: {
                name: "Xero",
                icon: "üìä",
                color: "#13B5EA",
                navTitle: "Xero Records",
                connectText: "Connect Xero",
                syncButtonText: "Import from Xero",
                authUrl: "/api/xero/auth",
                supportsOAuth: true
            },
            ZOHO: {
                name: "Zoho Books",
                icon: "üìó",
                color: "#e42527",
                navTitle: "Zoho Records",
                connectText: "Connect Zoho Books",
                syncButtonText: "Import from Zoho",
                authUrl: "/api/zoho/auth",
                supportsOAuth: true
            },
            CUSTOM: {
                name: "Your ERP",
                icon: "üîå",
                color: "#7f8c8d",
                navTitle: "ERP Records",
                connectText: "Configure ERP Connection",
                syncButtonText: "Import from ERP",
                authUrl: null,
                supportsOAuth: false
            },
            NONE: {
                name: "No ERP",
                icon: "‚öôÔ∏è",
                color: "#95a5a6",
                navTitle: "Manual Entry",
                connectText: "Connect Accounting Software",
                syncButtonText: "Add Manually",
                authUrl: null,
                supportsOAuth: false
            }
        };
        
        let currentERPConfig = ERP_CONFIGS.NONE;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            checkAuth();
            
            // Setup login form handler
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                console.log('Login form found, attaching event listener');
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleLogin(e);
                    return false;
                });
            } else {
                console.error('Login form not found!');
            }
        });

        // ========== AUTHENTICATION ==========

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (token) {
                authToken = token;
                loadDashboard();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').classList.remove('active');
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').classList.add('active');
        }

        async function handleLogin(event) {
            event.preventDefault();
            event.stopPropagation();
            
            console.log('Login form submitted');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.classList.remove('show');

            try {
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                console.log('Sending POST request to login endpoint');
                
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                console.log('Login response:', response.status);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Login failed');
                }

                const data = await response.json();
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);

                console.log('Login successful, loading dashboard');
                loadDashboard();
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message || 'An error occurred during login';
                errorDiv.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
            
            return false;
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentCompanyId');
            authToken = null;
            currentUser = null;
            currentCompany = null;
            companies = [];
            showLogin();
            showToast('Signed out successfully', 'success');
        }

        // ========== DASHBOARD LOADING ==========

        async function loadDashboard() {
            console.log('[loadDashboard] Starting dashboard load...');
            try {
                console.log('[loadDashboard] Step 1: Loading user info...');
                await loadUserInfo();
                
                console.log('[loadDashboard] Step 2: Loading companies...');
                await loadCompanies();
                
                console.log('[loadDashboard] Step 3: Showing dashboard...');
                showDashboard();
                
                console.log('[loadDashboard] Step 4: Checking QuickBooks status...');
                checkQuickBooksStatus();
                
                if (currentCompany) {
                    console.log('[loadDashboard] Step 5: Loading company data...');
                    await loadCompanyData();
                } else {
                    console.log('[loadDashboard] No current company, skipping company data load');
                }
                
                console.log('[loadDashboard] ‚úì Dashboard loaded successfully');
            } catch (error) {
                console.error('[loadDashboard] Failed to load dashboard:', error);
                console.error('[loadDashboard] Error stack:', error.stack);
                showToast(`Failed to load dashboard: ${error.message}`, 'error');
                handleLogout();
            }
        }

        async function loadUserInfo() {
            const response = await fetch(`${API_BASE}/api/auth/me`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load user info');
            }

            currentUser = await response.json();
            
            document.getElementById('userName').textContent = currentUser.full_name || currentUser.email;
            
            const initial = currentUser.full_name 
                ? currentUser.full_name.charAt(0).toUpperCase()
                : currentUser.email.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = initial;
            
            console.log(`[User Info] Role: ${currentUser.role}, Name: ${currentUser.full_name}`);
        }

        function toggleUserMenu() {
            // Optional: Add dropdown menu for user actions
            // For now, just show user info
            const userName = currentUser?.full_name || currentUser?.email || 'User';
            const userEmail = currentUser?.email || '';
            showToast(`Logged in as ${userName} (${userEmail})`, 'success');
        }

        async function loadCompanies() {
            const response = await fetch(`${API_BASE}/api/companies`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load companies');
            }

            companies = await response.json();
            
            const select = document.getElementById('companySelect');
            const companySelector = document.querySelector('.topbar-company');
            
            if (companies.length === 0) {
                select.innerHTML = '<option value="">No companies available</option>';
                return;
            }

            // Auto-select the first (and typically only) company for clients
            currentCompany = companies[0];
            localStorage.setItem('currentCompanyId', companies[0].id);
            
            // Update ERP configuration based on company's erp_type
            updateERPConfig();
            
            // Hide company selector since clients only have one company
            if (companySelector) {
                companySelector.style.display = 'none';
            }
            
            // Update page title to show company name
            document.getElementById('pageTitle').textContent = `${currentCompany.name} Dashboard`;
            
            console.log(`[Auto-selected] Company: ${currentCompany.name} (${currentCompany.tin})`);
            console.log(`[ERP Type] ${currentCompany.erp_type || 'none'}`);
            showToast(`Welcome to ${currentCompany.name}!`, 'success');
        }

        async function switchCompany() {
            const select = document.getElementById('companySelect');
            const companyId = select.value;
            
            if (!companyId) return;

            currentCompany = companies.find(c => c.id == companyId);
            localStorage.setItem('currentCompanyId', companyId);
            
            // Update ERP configuration based on company's erp_type
            updateERPConfig();
            
            showToast(`Switched to ${currentCompany.name}`, 'success');
            await loadCompanyData();
        }
        
        // ========== ERP CONFIGURATION ==========
        
        function updateERPConfig() {
            if (!currentCompany) return;
            
            // Determine ERP type from company data
            const erpType = (currentCompany.erp_type || 'NONE').toUpperCase();
            currentERPConfig = ERP_CONFIGS[erpType] || ERP_CONFIGS.NONE;
            
            console.log(`[updateERPConfig] Company ${currentCompany.name} uses ${currentERPConfig.name}`);
            
            // Update sidebar navigation title
            const navTitle = document.getElementById('erpNavTitle');
            if (navTitle) {
                navTitle.textContent = `${currentERPConfig.icon} ${currentERPConfig.navTitle}`;
            }
            
            // Update top bar ERP status
            const statusText = document.getElementById('erpStatusText');
            if (statusText) {
                statusText.textContent = `${currentERPConfig.icon} ${currentERPConfig.connectText}`;
            }
            
            // Update connection banner
            const bannerText = document.getElementById('erpConnectionBannerText');
            if (bannerText) {
                if (erpType === 'NONE') {
                    bannerText.textContent = 'Connect Your Accounting Software';
                } else {
                    bannerText.textContent = `Connect ${currentERPConfig.name}`;
                }
            }
            
            const subtext = document.getElementById('erpConnectionSubtext');
            if (subtext) {
                if (erpType === 'NONE') {
                    subtext.textContent = 'Connect QuickBooks, Xero, or Zoho to automatically sync invoices and products';
                } else {
                    subtext.textContent = `Sync your ${currentERPConfig.name} invoices and products automatically to EFRIS`;
                }
            }
            
            // Update connected banner
            const connectedName = document.getElementById('connectedERPName');
            if (connectedName) {
                connectedName.textContent = currentERPConfig.name;
            }
            
            const connectedIcon = document.getElementById('erpConnectedIcon');
            if (connectedIcon) {
                connectedIcon.textContent = `${currentERPConfig.icon}`;
            }
            
            // Update button colors to match ERP
            const banner = document.getElementById('erpConnectionBanner');
            if (banner) {
                banner.style.background = `linear-gradient(135deg, ${currentERPConfig.color} 0%, ${shadeColor(currentERPConfig.color, -20)} 100%)`;
            }
            
            const connectedBanner = document.getElementById('erpConnectedBanner');
            if (connectedBanner) {
                connectedBanner.style.background = `linear-gradient(135deg, #11998e 0%, #38ef7d 100%)`;
            }
            
            // Update sync button text in all places
            const syncButtons = document.querySelectorAll('[id*="importFrom"], [id*="syncButton"]');
            syncButtons.forEach(btn => {
                if (btn.textContent.includes('Import from') || btn.textContent.includes('Sync')) {
                    btn.textContent = btn.textContent.replace(/QuickBooks|Xero|Zoho|ERP/, currentERPConfig.name);
                }
            });
            
            console.log(`[updateERPConfig] ‚úì UI updated for ${currentERPConfig.name}`);
        }
        
        // Helper function to darken/lighten a color
        function shadeColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }
        
        function handleERPConnect() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            if (currentERPConfig.supportsOAuth && currentERPConfig.authUrl) {
                // OAuth flow - open popup
                const width = 600;
                const height = 700;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                const authUrl = `${API_BASE}${currentERPConfig.authUrl}?company_id=${currentCompany.id}`;
                window.open(authUrl, 'ERPAuth', `width=${width},height=${height},left=${left},top=${top}`);
                
                showToast(`Opening ${currentERPConfig.name} authentication...`, 'info');
            } else {
                // Manual configuration (API key, etc.)
                showManualERPConfig();
            }
        }
        
        function showManualERPConfig() {
            showToast(`Manual ERP configuration for ${currentERPConfig.name} - Coming soon!`, 'info');
            // TODO: Show modal with API key/credentials input
        }
        
        function handleERPStatusClick() {
            handleERPConnect();
        }

        async function loadCompanyData() {
            if (!currentCompany) {
                console.log('[loadCompanyData] No current company selected');
                return;
            }

            console.log(`[loadCompanyData] Loading data for company: ${currentCompany.name} (ID: ${currentCompany.id})`);
            
            // Update ERP configuration first
            updateERPConfig();

            try {
                console.log('[loadCompanyData] Step 1: Loading company details...');
                await loadCompanyDetails();
                
                console.log('[loadCompanyData] Step 2: Loading products...');
                await loadProducts();
                
                console.log('[loadCompanyData] Step 3: Loading invoices...');
                await loadInvoices();
                
                // Load EFRIS data from database
                console.log('[loadCompanyData] Step 4: Loading EFRIS products...');
                await loadEFRISData('products');
                
                console.log('[loadCompanyData] Step 5: Loading EFRIS invoices...');
                await loadEFRISData('invoices');
                
                console.log('[loadCompanyData] Step 6: Updating stats...');
                updateStats();
                
                console.log('[loadCompanyData] ‚úì All data loaded successfully');
            } catch (error) {
                console.error('[loadCompanyData] Error:', error);
                console.error('[loadCompanyData] Stack:', error.stack);
                showToast(`Failed to load company data: ${error.message}`, 'error');
            }
        }

        async function loadCompanyDetails() {
            const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load company details');
            }

            const company = await response.json();
            
            const infoDiv = document.getElementById('companyInfo');
            infoDiv.innerHTML = `
                <table class="data-table">
                    <tr>
                        <td style="width: 200px; font-weight: 600;">Company Name</td>
                        <td>${company.name}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: 600;">TIN</td>
                        <td>${company.tin}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: 600;">Address</td>
                        <td>${company.address || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: 600;">Phone</td>
                        <td>${company.phone || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: 600;">Email</td>
                        <td>${company.email || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: 600;">Device Number</td>
                        <td>${company.device_number || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: 600;">Status</td>
                        <td><span class="badge badge-success">Active</span></td>
                    </tr>
                </table>
            `;
        }

        async function loadProducts() {
            const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/products`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load products');
            }

            const products = await response.json();
            displayProducts(products);
        }

        async function loadInvoices() {
            const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/invoices`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load invoices');
            }

            const invoices = await response.json();
            displayInvoices(invoices);
        }

        function updateStats() {
            const productsDiv = document.getElementById('productsContent');
            const invoicesDiv = document.getElementById('invoicesContent');
            
            const productRows = productsDiv.querySelectorAll('tbody tr').length;
            const invoiceRows = invoicesDiv.querySelectorAll('tbody tr').length;
            const syncedCount = productsDiv.querySelectorAll('.badge-success').length + 
                              invoicesDiv.querySelectorAll('.badge-success').length;
            
            document.getElementById('totalProducts').textContent = productRows || '0';
            document.getElementById('totalInvoices').textContent = invoiceRows || '0';
            document.getElementById('syncedItems').textContent = syncedCount || '0';
        }

        // ========== UI FUNCTIONS ==========

        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.tab === tabName) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            const titles = {
                overview: 'Dashboard',
                'qb-items': 'QuickBooks Items',
                'qb-invoices': 'QuickBooks Invoices',
                'qb-purchase-orders': 'QuickBooks Purchase Orders',
                'qb-credit-memos': 'QuickBooks Credit Memos',
                products: 'EFRIS Products & Services',
                invoices: 'EFRIS Invoice Management',
                'excise-codes': 'EFRIS Excise Duty Codes',
                'purchase-orders': 'EFRIS Purchase Orders',
                'credit-memos': 'EFRIS Credit Memos',
                settings: 'EFRIS Settings'
            };
            document.getElementById('pageTitle').textContent = titles[tabName];

            // Load data from database when navigating to QB tabs
            if (tabName === 'qb-items') {
                loadQBData('items');
            } else if (tabName === 'qb-invoices') {
                loadQBData('invoices');
            } else if (tabName === 'qb-purchase-orders') {
                loadQBData('purchase-orders');
            } else if (tabName === 'qb-credit-memos') {
                loadQBData('credit-memos');
            } else if (tabName === 'products') {
                populateExciseCodes();
            } else if (tabName === 'excise-codes') {
                loadExciseCodes();
            } else if (tabName === 'settings') {
                loadSettingsData();
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const messageEl = document.getElementById('toastMessage');
            const iconEl = document.getElementById('toastIcon');
            
            toast.className = `toast ${type}`;
            messageEl.textContent = message;
            iconEl.textContent = type === 'success' ? '‚úì' : '‚úó';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        async function refreshData() {
            showToast('Refreshing data...', 'success');
            await loadCompanyData();
            showToast('Data refreshed', 'success');
        }

        // ========== QUICKBOOKS INTEGRATION ==========

        async function checkQuickBooksStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/quickbooks/status`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                
                // Only mark as connected if we have valid access token
                qbConnected = (data.connected && data.access_token) || false;
                updateQuickBooksStatus(qbConnected, data.companyName);
            } catch (error) {
                console.error('QuickBooks check failed:', error);
                updateQuickBooksStatus(false);
            }
        }

        function handleQBStatusClick() {
            const topbarStatus = document.getElementById('topbarQBStatus');
            if (!topbarStatus.classList.contains('connected')) {
                connectQuickBooks();
            }
        }

        function updateQuickBooksStatus(connected, companyName = '') {
            const dot = document.getElementById('qbStatusDot');
            const text = document.getElementById('qbStatusText');
            const topbarStatus = document.getElementById('topbarQBStatus');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = `‚úì QB: ${companyName || 'Connected'}`;
                topbarStatus.classList.add('connected');
                topbarStatus.style.cursor = 'default';
                topbarStatus.title = `Connected to ${companyName || 'QuickBooks'}`;
            } else {
                dot.classList.remove('connected');
                text.textContent = 'üîó Click to Connect QuickBooks';
                topbarStatus.classList.remove('connected');
                topbarStatus.style.cursor = 'pointer';
                topbarStatus.title = 'Click to connect QuickBooks';
            }
        }

        async function connectQuickBooks() {
            try {
                const response = await fetch(`${API_BASE}/api/quickbooks/auth`);
                const data = await response.json();
                
                if (data.authUrl) {
                    window.open(data.authUrl, '_blank', 'width=800,height=600');
                    showToast('Opening QuickBooks authorization...', 'success');
                    
                    const pollInterval = setInterval(async () => {
                        await checkQuickBooksStatus();
                        if (qbConnected) {
                            clearInterval(pollInterval);
                            showToast('Successfully connected to QuickBooks!', 'success');
                        }
                    }, 3000);
                    
                    setTimeout(() => clearInterval(pollInterval), 120000);
                } else {
                    showToast('Failed to initiate QuickBooks connection', 'error');
                }
            } catch (error) {
                console.error('QuickBooks connection error:', error);
                showToast('Error connecting to QuickBooks', 'error');
            }
        }

        async function importFromQuickBooks(type) {
            if (!qbConnected) {
                showToast('Please connect to QuickBooks first', 'error');
                handleQBStatusClick();
                return;
            }

            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            const endpoints = {
                'items': `/api/companies/${currentCompany.id}/qb-items/import`,
                'invoices': `/api/companies/${currentCompany.id}/qb-invoices/import`,
                'purchase-orders': `/api/companies/${currentCompany.id}/qb-purchase-orders/import`,
                'credit-memos': `/api/companies/${currentCompany.id}/qb-credit-memos/import`
            };

            const names = {
                'items': 'items',
                'invoices': 'invoices',
                'purchase-orders': 'purchase orders',
                'credit-memos': 'credit memos'
            };

            try {
                showToast(`Importing ${names[type]} from QuickBooks...`, 'success');
                const response = await fetch(`${API_BASE}${endpoints[type]}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`Failed to import ${names[type]}`);

                const data = await response.json();
                showToast(data.message || `Imported ${data.count || 0} ${names[type]}`, 'success');
                
                // Load the saved data from database
                await loadQBData(type);
            } catch (error) {
                console.error(`Import error:`, error);
                showToast(`Failed to import ${names[type]}`, 'error');
            }
        }

        async function loadQBData(type) {
            if (!currentCompany) return;

            const endpoints = {
                'items': `/api/companies/${currentCompany.id}/qb-items`,
                'invoices': `/api/companies/${currentCompany.id}/qb-invoices`,
                'purchase-orders': `/api/companies/${currentCompany.id}/qb-purchase-orders`,
                'credit-memos': `/api/companies/${currentCompany.id}/qb-credit-memos`
            };

            try {
                const response = await fetch(`${API_BASE}${endpoints[type]}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load data');

                const data = await response.json();
                
                // Display in the current tab
                if (type === 'items') {
                    displayQBItems(data.items || []);
                } else if (type === 'invoices') {
                    displayQBInvoicesInTab(data.invoices || []);
                } else if (type === 'purchase-orders') {
                    // API now returns array directly, not wrapped in purchase_orders property
                    displayQBPurchaseOrders(Array.isArray(data) ? data : (data.purchase_orders || []));
                } else if (type === 'credit-memos') {
                    displayQBCreditMemos(data.credit_memos || []);
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function displayQBItems(items) {
            const content = document.getElementById('qbItemsContent');
            if (!items || items.length === 0) {
                content.innerHTML = '<p style="color: #7f8c8d;">No items found.</p>';
                return;
            }

            const pendingItems = items.filter(item => item.EfrisStatus === 'Pending');
            const registeredCount = items.filter(item => item.EfrisStatus === 'Registered').length;

            content.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="color: #2ecc71; font-weight: bold;">‚úì ${registeredCount} Registered</span>
                        <span style="margin-left: 20px; color: #f39c12; font-weight: bold;">‚ö† ${pendingItems.length} Pending</span>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Description (Product Code)</th>
                            <th>Price</th>
                            <th>EFRIS Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td><strong>${item.Name || ''}</strong></td>
                                <td><span class="badge badge-info">${item.Type || 'Item'}</span></td>
                                <td>${item.Description || '-'}</td>
                                <td>UGX ${parseFloat(item.UnitPrice || 0).toLocaleString()}</td>
                                <td><span class="badge ${item.EfrisStatus === 'Registered' ? 'badge-success' : 'badge-warning'}">${item.EfrisStatus || 'Pending'}</span></td>
                                <td>
                                    ${item.EfrisStatus === 'Pending' ? 
                                        `<button class="btn btn-sm" onclick='editItemForEFRIS(${JSON.stringify(item).replace(/'/g, "&apos;")})' style="background: #9b59b6; color: white;">Edit & Register</button>` :
                                        `<button class="btn btn-sm" onclick="viewProduct('${item.Id}')">View</button>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function toggleSelectAllItems(checkbox) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        async function registerSelectedToEFRIS() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('Please select items to register', 'error');
                return;
            }

            const itemIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (!confirm(`Register ${itemIds.length} item(s) to EFRIS?`)) {
                return;
            }

            try {
                showToast(`Registering ${itemIds.length} items to EFRIS...`, 'success');
                
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-items/register-to-efris`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        item_ids: itemIds,
                        default_category_id: "50202306"
                    })
                });

                if (!response.ok) throw new Error('Failed to register items');

                const data = await response.json();
                console.log('Registration response:', data);
                
                if (data.success_count > 0) {
                    showToast(`‚úì Successfully registered ${data.success_count} item(s) to EFRIS!`, 'success');
                }
                
                if (data.failed_count > 0) {
                    showToast(`‚ö† ${data.failed_count} item(s) failed to register`, 'error');
                    console.error('Failed items:', data.failed_items);
                }
                
                // Reload items to show updated status
                await loadQBData('items');
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Failed to register items to EFRIS', 'error');
            }
        }

        async function registerSingleItemToEFRIS(item, skipConfirm = false) {
            if (!skipConfirm && !confirm(`Register "${item.Name}" to EFRIS?`)) {
                return;
            }

            try {
                showToast(`Registering "${item.Name}" to EFRIS...`, 'success');
                
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-items/register-to-efris`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        item_ids: [item.Id],
                        default_category_id: "50202306"
                    })
                });

                if (!response.ok) throw new Error('Failed to register item');

                const data = await response.json();
                console.log('Registration response:', data);
                
                if (data.success_count > 0) {
                    showToast(`‚úì Successfully registered "${item.Name}" to EFRIS!`, 'success');
                    // Reload items to show updated status
                    await loadQBData('items');
                } else {
                    showToast(`Failed to register: ${data.failed_items[0]?.error || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Failed to register item to EFRIS', 'error');
            }
        }

        let currentEditingItem = null;
        let unitsOfMeasure = [];

        async function loadUnitsOfMeasure() {
            if (unitsOfMeasure.length > 0) return unitsOfMeasure; // Already loaded
            
            try {
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/code-list?code_type=103`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch units');

                const result = await response.json();
                
                // Extract units from decrypted content
                // T115 returns system dictionary with rateUnit field containing units of measure
                if (result.data && result.data.decrypted_content) {
                    const content = result.data.decrypted_content;
                    
                    // Try to get rateUnit array (T115 response format)
                    if (content.rateUnit && Array.isArray(content.rateUnit)) {
                        unitsOfMeasure = content.rateUnit.map(unit => ({
                            code: unit.value || unit.code,
                            name: unit.name || unit.description
                        }));
                        console.log('Loaded units of measure from rateUnit:', unitsOfMeasure);
                        return unitsOfMeasure;
                    }
                }
                
                // Fallback to default units
                console.warn('Using fallback units of measure');
                unitsOfMeasure = [
                    { code: '101', name: 'Each (Unit)' },
                    { code: '102', name: 'Per Stick' },
                    { code: '103', name: 'Per Litre' },
                    { code: '104', name: 'Kilogram' },
                    { code: '105', name: 'Meter' },
                    { code: '106', name: 'Piece' },
                    { code: '107', name: 'Bag' },
                    { code: '108', name: 'Box' },
                    { code: '109', name: 'Dozen' },
                    { code: '110', name: 'Packet' }
                ];
                return unitsOfMeasure;
            } catch (error) {
                console.error('Failed to load units of measure:', error);
                // Return default units as fallback
                return [
                    { code: '101', name: 'Each (Unit)' },
                    { code: '102', name: 'Per Stick' },
                    { code: '103', name: 'Per Litre' },
                    { code: '104', name: 'Kilogram' },
                    { code: '105', name: 'Meter' },
                    { code: '106', name: 'Piece' },
                    { code: '107', name: 'Bag' },
                    { code: '108', name: 'Box' },
                    { code: '109', name: 'Dozen' },
                    { code: '110', name: 'Packet' }
                ];
            }
        }

        // ========== SEARCHABLE UNIT OF MEASURE DROPDOWN ==========
        
        let allUnits = [];
        let filteredUnits = [];
        let selectedUnit = null;
        let dropdownTimeout = null;

        async function initializeUnitsDropdown() {
            allUnits = await loadUnitsOfMeasure();
            filteredUnits = [...allUnits];
            populateUnitDropdown(filteredUnits);
        }

        function populateUnitDropdown(units) {
            const dropdown = document.getElementById('unitDropdown');
            if (!dropdown) return;

            if (units.length === 0) {
                dropdown.innerHTML = '<div style="padding: 8px; color: #7f8c8d; font-style: italic;">No units found</div>';
                return;
            }

            dropdown.innerHTML = units.map(unit => 
                `<div class="unit-option" 
                      data-code="${unit.code}" 
                      data-name="${unit.name}"
                      onmousedown="selectUnit('${unit.code}', '${unit.name.replace(/'/g, "\\'")}')"
                      style="padding: 10px; cursor: pointer; border-bottom: 1px solid #ecf0f1;">
                    <strong>${unit.code}</strong> - ${unit.name}
                </div>`
            ).join('');
        }

        function filterUnitsOfMeasure() {
            const searchInput = document.getElementById('editUnitOfMeasureSearch');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredUnits = [...allUnits];
            } else {
                filteredUnits = allUnits.filter(unit => 
                    unit.code.toLowerCase().includes(searchTerm) ||
                    unit.name.toLowerCase().includes(searchTerm)
                );
            }
            
            populateUnitDropdown(filteredUnits);
            showUnitDropdown();
        }

        function selectUnit(code, name) {
            const searchInput = document.getElementById('editUnitOfMeasureSearch');
            const hiddenSelect = document.getElementById('editUnitOfMeasure');
            
            // Update display
            searchInput.value = `${code} - ${name}`;
            
            // Update hidden select for form submission
            hiddenSelect.innerHTML = `<option value="${code}" selected>${name}</option>`;
            hiddenSelect.value = code;
            
            // Store selection
            selectedUnit = { code, name };
            
            // Hide dropdown
            hideUnitDropdown();
        }

        function showUnitDropdown() {
            clearTimeout(dropdownTimeout);
            const dropdown = document.getElementById('unitDropdown');
            if (dropdown && allUnits.length > 0) {
                dropdown.style.display = 'block';
            }
        }

        function hideUnitDropdown() {
            dropdownTimeout = setTimeout(() => {
                const dropdown = document.getElementById('unitDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 150); // Delay to allow click events
        }

        // Add CSS for hover effect
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .unit-option:hover {
                    background-color: #ecf0f1 !important;
                }
                .unit-option:active {
                    background-color: #d5dbdb !important;
                }
            `;
            document.head.appendChild(style);
        });

        async function editItemForEFRIS(item) {
            currentEditingItem = item;
            
            const isService = item.Type === 'Service';
            
            // Populate modal
            document.getElementById('editItemName').textContent = item.Name || 'Unknown Item';
            const typeDisplay = isService ? 'üîß Service' : 'üì¶ Product';
            document.getElementById('editItemTypeDisplay').textContent = `${typeDisplay} | Price: UGX ${parseFloat(item.UnitPrice || 0).toLocaleString()}`;
            
            // Store item type
            document.getElementById('editItemType').value = item.Type || 'Item';
            
            // Set product code (Description from QBO, fallback to Name)
            const productCode = item.Description || item.Name || '';
            document.getElementById('editProductCode').value = productCode;
            document.getElementById('editProductCode').readOnly = true; // Make it read-only since it comes from QBO
            
            // Set UNSPSC code (SKU from QBO)
            document.getElementById('editCommodityCode').value = item.Sku || '50202306';
            
            // Handle unit of measure based on type
            const unitField = document.getElementById('unitOfMeasureField');
            const unitSelect = document.getElementById('editUnitOfMeasure');
            const unitSearchInput = document.getElementById('editUnitOfMeasureSearch');
            
            if (isService) {
                // For services, hide the unit field and set a default service unit
                unitField.style.display = 'none';
                unitSelect.required = false;
                
                // Set default service unit for hidden select
                unitSelect.innerHTML = '<option value="102" selected>Per Stick</option>';
                unitSelect.value = '102';
                
                // Clear search input
                if (unitSearchInput) unitSearchInput.value = '';
            } else {
                // For goods, show and populate searchable units of measure
                unitField.style.display = 'block';
                unitSelect.required = true;
                
                // Initialize the searchable dropdown
                await initializeUnitsDropdown();
                
                // Set default unit for goods (Each - Unit)
                const defaultUnit = allUnits.find(unit => unit.code === '101');
                if (defaultUnit) {
                    selectUnit(defaultUnit.code, defaultUnit.name);
                } else {
                    // Fallback
                    unitSearchInput.value = '';
                    unitSelect.innerHTML = '<option value="">Select unit...</option>';
                }
            }
            
            // Load excise fields from existing data (don't reset if item has excise info)
            const hasExcise = item.HasExcise || false;
            document.getElementById('editHasExcise').checked = hasExcise;
            document.getElementById('editExciseDutyCode').value = item.ExciseDutyCode || '';
            document.getElementById('exciseFields').style.display = hasExcise ? 'block' : 'none';
            
            // Load zero-rated and exempt fields from existing data
            // CRITICAL: These must be preserved to distinguish between Zero-rated (02) and Exempt (03) in EFRIS
            document.getElementById('editIsZeroRated').checked = item.IsZeroRated || false;
            document.getElementById('editIsExempt').checked = item.IsExempt || false;
            
            console.log('[Edit Item] Tax flags loaded - IsZeroRated:', item.IsZeroRated, 'IsExempt:', item.IsExempt);
            
            // Populate excise codes dropdown from database
            populateExciseCodes();
            
            // Show modal
            document.getElementById('editItemModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editItemModal').style.display = 'none';
            currentEditingItem = null;
        }

        function toggleExciseFields() {
            const hasExcise = document.getElementById('editHasExcise').checked;
            document.getElementById('exciseFields').style.display = hasExcise ? 'block' : 'none';
            
            if (hasExcise) {
                document.getElementById('editExciseDutyCode').required = true;
            } else {
                document.getElementById('editExciseDutyCode').required = false;
            }
        }

        async function saveItemMetadata(event) {
            event.preventDefault();
            
            if (!currentEditingItem) return;
            
            // Save reference before modal closes
            const itemToRegister = currentEditingItem;
            
            const isService = document.getElementById('editItemType').value === 'Service';
            const unitValue = isService ? '102' : document.getElementById('editUnitOfMeasure').value;
            
            const metadata = {
                efris_product_code: document.getElementById('editProductCode').value,
                efris_commodity_code: document.getElementById('editCommodityCode').value,
                efris_unit_of_measure: unitValue,
                has_excise: document.getElementById('editHasExcise').checked,
                excise_duty_code: document.getElementById('editHasExcise').checked ? 
                                 document.getElementById('editExciseDutyCode').value : null,
                is_zero_rated: document.getElementById('editIsZeroRated').checked,
                is_exempt: document.getElementById('editIsExempt').checked
            };
            
            try {
                showToast('Saving EFRIS metadata...', 'success');
                
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-items/${itemToRegister.Id}/efris-metadata`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });

                if (!response.ok) throw new Error('Failed to save metadata');

                const data = await response.json();
                showToast('‚úì EFRIS metadata saved!', 'success');
                
                // Close modal before registration
                closeEditModal();
                
                // Always register to EFRIS immediately after saving (skip confirm dialog)
                showToast('Registering to EFRIS...', 'success');
                await registerSingleItemToEFRIS(itemToRegister, true);
                
            } catch (error) {
                console.error('Save metadata error:', error);
                showToast('Failed to save EFRIS metadata', 'error');
            }
        }

        let currentEditingInvoice = null;

        function displayQBInvoicesInTab(invoices) {
            const content = document.getElementById('qbInvoicesContent');
            if (!invoices || invoices.length === 0) {
                content.innerHTML = '<p style="color: #7f8c8d;">No invoices found.</p>';
                return;
            }

            // Count statuses
            const successCount = invoices.filter(i => i.EfrisStatus === 'success').length;
            const failedCount = invoices.filter(i => i.EfrisStatus === 'failed').length;
            const draftCount = invoices.filter(i => !i.EfrisStatus || i.EfrisStatus === 'draft').length;

            content.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 15px; color: #7f8c8d;">
                        <span><strong>${invoices.length}</strong> total</span>
                        <span style="color: #2ecc71;">‚úì ${successCount} fiscalized</span>
                        <span style="color: #e74c3c;">${failedCount > 0 ? `‚úó ${failedCount} failed` : ''}</span>
                        <span style="color: #95a5a6;">üìù ${draftCount} draft</span>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>EFRIS Status</th>
                            <th>FDN</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(inv => {
                            const status = inv.EfrisStatus || 'draft';
                            const statusColors = {
                                'draft': '#95a5a6',
                                'pending': '#f39c12',
                                'submitted': '#3498db',
                                'success': '#27ae60',
                                'failed': '#e74c3c'
                            };
                            const statusLabels = {
                                'draft': 'üìù Draft',
                                'pending': '‚è≥ Pending',
                                'submitted': 'üì§ Submitted',
                                'success': '‚úÖ Fiscalized',
                                'failed': '‚ùå Failed'
                            };
                            const statusColor = statusColors[status.toLowerCase()] || '#95a5a6';
                            const statusLabel = statusLabels[status.toLowerCase()] || status.toUpperCase();
                            const fdn = inv.EfrisFDN || '-';
                            const isSuccess = status.toLowerCase() === 'success';
                            
                            return `
                            <tr style="${isSuccess ? 'background: #f0fff0;' : ''}">
                                <td><strong>${inv.DocNumber || ''}</strong></td>
                                <td>${inv.CustomerRef?.name || '-'}</td>
                                <td>${inv.TxnDate || '-'}</td>
                                <td>UGX ${parseFloat(inv.TotalAmt || 0).toLocaleString()}</td>
                                <td><span class="badge" style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px;">${statusLabel}</span></td>
                                <td style="font-family: monospace; font-size: 12px; color: ${fdn !== '-' ? '#27ae60' : '#bdc3c7'};">${fdn}</td>
                                <td>
                                    ${isSuccess 
                                        ? `<button class="btn btn-sm" style="background: #27ae60; color: white;" onclick="viewEfrisInvoice('${inv.Id}')">üßæ View</button>`
                                        : `<button class="btn btn-sm btn-primary" onclick="editInvoiceForEFRIS('${inv.Id}')">‚úèÔ∏è Edit & Submit</button>`
                                    }
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // View EFRIS Invoice function
        async function viewEfrisInvoice(invoiceId) {
            try {
                showToast('Loading EFRIS invoice...', 'success');
                
                // Fetch the stored EFRIS invoice data
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/efris-invoice/${invoiceId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load EFRIS invoice');
                
                const result = await response.json();
                if (result.efris_invoice) {
                    showEfrisInvoiceModal(result.efris_invoice, result.fdn, result.antifake_code);
                } else {
                    showToast('EFRIS invoice data not available', 'error');
                }
            } catch (error) {
                console.error('Error loading EFRIS invoice:', error);
                showToast('Failed to load EFRIS invoice', 'error');
            }
        }

        // Invoice Edit & Submit Functions
        async function editInvoiceForEFRIS(invoiceId) {
            try {
                showToast('Loading invoice details...', 'success');
                
                // Fetch full invoice details from QuickBooks via API
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-invoice/${invoiceId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load invoice');

                const invoice = await response.json();
                currentEditingInvoice = invoice;
                
                // Populate modal
                document.getElementById('invoiceNumber').value = currentEditingInvoice.DocNumber || '';
                document.getElementById('invoiceCustomer').value = currentEditingInvoice.CustomerRef?.name || '';
                document.getElementById('invoiceDate').value = currentEditingInvoice.TxnDate || '';
                document.getElementById('invoiceBuyerType').value = currentEditingInvoice.BuyerType || '1';
                document.getElementById('invoiceCustomerTIN').value = currentEditingInvoice.BuyerTin || '';
                
                toggleCustomerTIN();
                
                // Populate line items
                await populateInvoiceLineItems(currentEditingInvoice);
                
                // Calculate and display summary
                calculateInvoiceSummary();
                
                // Show modal
                document.getElementById('editInvoiceModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading invoice:', error);
                showToast('Failed to load invoice details', 'error');
            }
        }

        async function populateInvoiceLineItems(invoice) {
            const tbody = document.getElementById('invoiceItemsBody');
            tbody.innerHTML = '';
            
            console.log('Full invoice data:', invoice);
            
            const lineItems = invoice.Line || [];
            
            // First pass: Check for invoice-level discounts (DiscountLineDetail)
            const discountLines = lineItems.filter(l => l.DetailType === 'DiscountLineDetail');
            let invoiceLevelDiscountAmount = 0;
            let invoiceLevelDiscountPercent = 0;
            
            if (discountLines.length > 0) {
                for (const discLine of discountLines) {
                    const discDetail = discLine.DiscountLineDetail || {};
                    const discAmt = Math.abs(parseFloat(discLine.Amount || 0));
                    invoiceLevelDiscountAmount += discAmt;
                    
                    if (discDetail.PercentBased && discDetail.DiscountPercent) {
                        invoiceLevelDiscountPercent = parseFloat(discDetail.DiscountPercent || 0);
                    }
                }
                console.log(`Invoice-level discount: ${invoiceLevelDiscountPercent}% (UGX ${invoiceLevelDiscountAmount})`);
            }
            
            // Calculate subtotal before discount (for proportional distribution)
            const subtotalBeforeDiscount = lineItems
                .filter(l => l.DetailType === 'SalesItemLineDetail')
                .reduce((sum, l) => sum + parseFloat(l.Amount || 0), 0);
            
            if (invoiceLevelDiscountAmount > 0 && invoiceLevelDiscountPercent === 0 && subtotalBeforeDiscount > 0) {
                invoiceLevelDiscountPercent = (invoiceLevelDiscountAmount / subtotalBeforeDiscount) * 100;
                console.log(`Calculated invoice discount percent: ${invoiceLevelDiscountPercent}%`);
            }
            
            for (const line of lineItems) {
                console.log('Line item:', line);
                
                if (line.DetailType === 'SalesItemLineDetail') {
                    const detail = line.SalesItemLineDetail || {};
                    const itemRef = detail.ItemRef || {};
                    
                    // Get enriched item details if available
                    const itemDetails = detail.ItemDetails || {};
                    
                    const quantity = detail.Qty || 1;
                    const unitPrice = detail.UnitPrice || 0;
                    const amount = line.Amount || 0;
                    
                    console.log('Item:', itemRef.name, 'Qty:', quantity, 'Price:', unitPrice, 'Amount:', amount);
                    console.log('DiscountRate:', detail.DiscountRate, 'DiscountAmt:', detail.DiscountAmt);
                    
                    // Calculate discount - check for line-level discount first
                    let discountPercent = 0;
                    let discountAmount = 0;
                    
                    if (detail.DiscountRate) {
                        // Line-level percentage discount
                        discountPercent = detail.DiscountRate;
                        discountAmount = (unitPrice * quantity * discountPercent) / 100;
                    } else if (detail.DiscountAmt) {
                        // Line-level fixed discount
                        discountAmount = detail.DiscountAmt;
                        discountPercent = (discountAmount / (unitPrice * quantity)) * 100;
                    } else if (invoiceLevelDiscountPercent > 0) {
                        // Apply invoice-level discount proportionally
                        discountPercent = invoiceLevelDiscountPercent;
                        discountAmount = (amount * invoiceLevelDiscountPercent) / 100;
                    }
                    
                    console.log('Final discount - Percent:', discountPercent, 'Amount:', discountAmount);
                    
                    // Get tax rate from backend (already determined from QuickBooks)
                    let taxRate = itemDetails.TaxRate !== undefined ? itemDetails.TaxRate : 0.18;
                    const taxCodeName = (detail.TaxCodeRef?.name || '').toUpperCase();
                    if (taxCodeName.includes('EXEMPT') || taxCodeName.includes('ZERO')) {
                        taxRate = 0;
                    }
                    
                    // Determine tax category and badge
                    // Priority 1: Use IsExempt/IsZeroRated from backend (saved in database by user)
                    // Priority 2: Fall back to QuickBooks TaxCodeRef name detection
                    let taxBadge = '';
                    let taxBgColor = '#28a745';
                    
                    // Check backend flags first (these are saved values from control panel)
                    const isExemptFromDB = itemDetails.IsExempt || false;
                    const isZeroRatedFromDB = itemDetails.IsZeroRated || false;
                    
                    console.log(`[Tax Badge] Item: ${itemDetails.Name}, IsExempt=${isExemptFromDB}, IsZeroRated=${isZeroRatedFromDB}, TaxCodeName=${taxCodeName}`);
                    
                    if (isExemptFromDB) {
                        // User explicitly marked as Exempt in control panel
                        taxBadge = 'EXEMPT';
                        taxBgColor = '#fd7e14';  // Orange for exempt
                        taxRate = 0;
                    } else if (isZeroRatedFromDB) {
                        // User explicitly marked as Zero-rated in control panel
                        taxBadge = '0% Zero';
                        taxBgColor = '#17a2b8';  // Cyan for zero-rated
                        taxRate = 0;
                    } else if (taxRate === 0) {
                        // Fall back to QB TaxCodeName detection for 0% items
                        if (taxCodeName.includes('EXEMPT')) {
                            taxBadge = 'EXEMPT';
                            taxBgColor = '#fd7e14';
                        } else {
                            taxBadge = '0% Zero';
                            taxBgColor = '#17a2b8';
                        }
                    } else {
                        const isDeemedVAT = itemDetails.IsDeemedVAT || false;
                        taxBadge = isDeemedVAT ? `${(taxRate * 100).toFixed(0)}% Deemed` : `${(taxRate * 100).toFixed(0)}%`;
                        taxBgColor = isDeemedVAT ? '#6f42c1' : '#28a745';
                    }
                    
                    // Get excise info and extract base price from QB price
                    const hasExcise = itemDetails.HasExcise || false;
                    const exciseCode = itemDetails.ExciseDutyCode || '';
                    const exciseRate = itemDetails.ExciseRate || '0';
                    const exciseRule = itemDetails.ExciseRule || '2';
                    
                    // Extract base price from QB price (QB price includes excise)
                    let baseUnitPrice = unitPrice;
                    let exciseTax = 0;
                    let exciseDisplay = '-';
                    
                    if (hasExcise && exciseCode && exciseRate) {
                        try {
                            const rate = parseFloat(exciseRate);
                            
                            if (exciseRule === '1') {
                                // Percentage-based: QB price = base √ó (1 + rate/100)
                                // So: base = QB price / (1 + rate/100)
                                baseUnitPrice = unitPrice / (1 + rate / 100);
                                exciseTax = (baseUnitPrice * quantity) * (rate / 100);
                                exciseDisplay = `[${exciseCode}] ${rate}% on ${Math.round(baseUnitPrice).toLocaleString()} = UGX ${Math.round(exciseTax).toLocaleString()}`;
                            } else {
                                // Fixed-rate: QB price = base + rate
                                // So: base = QB price - rate
                                baseUnitPrice = unitPrice - rate;
                                exciseTax = rate * quantity;
                                exciseDisplay = `[${exciseCode}] UGX ${Math.round(rate).toLocaleString()} √ó ${quantity} = UGX ${Math.round(exciseTax).toLocaleString()}`;
                            }
                        } catch (e) {
                            console.error('Excise calculation error:', e);
                            baseUnitPrice = unitPrice;
                        }
                    }
                    
                    // Create row
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #dee2e6';
                    row.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <strong>${itemRef.name || 'Item'}</strong>
                            ${itemDetails.Description ? `<br><small style="color: #7f8c8d;">${itemDetails.Description}</small>` : ''}
                        </td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${quantity}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">UGX ${unitPrice.toLocaleString()}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                            ${discountAmount > 0 ? `
                                <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                    ${discountPercent > 0 ? `${discountPercent.toFixed(1)}%` : 'FIXED'}
                                </span><br>
                                <small style="color: #dc3545;">-UGX ${discountAmount.toLocaleString()}</small>
                            ` : '-'}
                        </td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                            <span style="background: ${taxBgColor}; color: white; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                ${taxBadge}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
                            ${exciseDisplay}
                        </td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd; font-weight: 600;">
                            UGX ${amount.toLocaleString()}
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            }
        }

        function calculateInvoiceSummary() {
            if (!currentEditingInvoice) return;
            
            let subtotal = 0;
            let totalDiscount = 0;
            let totalExcise = 0;
            let totalVAT = 0;
            
            const lineItems = currentEditingInvoice.Line || [];
            
            // First pass: Check for invoice-level discounts (DiscountLineDetail)
            const discountLines = lineItems.filter(l => l.DetailType === 'DiscountLineDetail');
            let invoiceLevelDiscountAmount = 0;
            
            if (discountLines.length > 0) {
                for (const discLine of discountLines) {
                    const discAmt = Math.abs(parseFloat(discLine.Amount || 0));
                    invoiceLevelDiscountAmount += discAmt;
                }
                totalDiscount = invoiceLevelDiscountAmount;
            }
            
            for (const line of lineItems) {
                if (line.DetailType === 'SalesItemLineDetail') {
                    const detail = line.SalesItemLineDetail || {};
                    const itemDetails = detail.ItemDetails || {};
                    
                    const quantity = detail.Qty || 1;
                    const qbUnitPrice = detail.UnitPrice || 0;
                    
                    // Extract base price from QB price if item has excise
                    let baseUnitPrice = qbUnitPrice;
                    let lineExcise = 0;
                    
                    if (itemDetails.HasExcise) {
                        const exciseRate = parseFloat(itemDetails.ExciseRate || 0);
                        const exciseRule = itemDetails.ExciseRule || '2';
                        
                        if (exciseRule === '1') {
                            // Percentage: QB price = base √ó (1 + rate/100)
                            baseUnitPrice = qbUnitPrice / (1 + exciseRate / 100);
                            lineExcise = (baseUnitPrice * quantity) * (exciseRate / 100);
                        } else {
                            // Fixed-rate: QB price = base + rate
                            baseUnitPrice = qbUnitPrice - exciseRate;
                            lineExcise = exciseRate * quantity;
                        }
                        
                        totalExcise += lineExcise;
                    }
                    
                    const lineTotal = baseUnitPrice * quantity;  // Use base price for subtotal
                    
                    // Add to subtotal (before discount, excise excluded)
                    subtotal += lineTotal;
                    
                    // Check for line-level discount
                    let lineDiscount = 0;
                    if (detail.DiscountRate) {
                        lineDiscount = (lineTotal * detail.DiscountRate) / 100;
                        totalDiscount += lineDiscount;
                    } else if (detail.DiscountAmt) {
                        lineDiscount = detail.DiscountAmt;
                        totalDiscount += lineDiscount;
                    }
                    
                    // Calculate VAT for this line based on its tax category
                    const lineNetAmount = lineTotal - lineDiscount;
                    const lineTaxableAmount = lineNetAmount + lineExcise;
                    
                    // Determine tax rate based on item details
                    let lineTaxRate = 0;
                    
                    // Check if item is Exempt or Zero-rated
                    if (itemDetails.IsExempt) {
                        lineTaxRate = 0; // Exempt - no VAT
                        console.log(`  Line ${line.Id || ''} - EXEMPT: No VAT`);
                    } else if (itemDetails.IsZeroRated) {
                        lineTaxRate = 0; // Zero-rated - no VAT
                        console.log(`  Line ${line.Id || ''} - ZERO-RATED: No VAT`);
                    } else {
                        // Standard rate - check TaxRate or default to 18%
                        lineTaxRate = parseFloat(itemDetails.TaxRate || detail.TaxRate || 0.18);
                        console.log(`  Line ${line.Id || ''} - STANDARD: ${lineTaxRate * 100}% VAT`);
                    }
                    
                    const lineVAT = lineTaxableAmount * lineTaxRate;
                    totalVAT += lineVAT;
                }
            }
            
            // Calculate totals
            const netAmount = subtotal - totalDiscount;
            const taxableAmount = netAmount + totalExcise;
            const grandTotal = netAmount + totalExcise + totalVAT;
            
            console.log('Summary Calculation:');
            console.log('  Subtotal (base):', subtotal);
            console.log('  Discount:', totalDiscount);
            console.log('  Net Amount:', netAmount);
            console.log('  Excise:', totalExcise);
            console.log('  Taxable (net + excise):', taxableAmount);
            console.log('  VAT (calculated per line):', totalVAT);
            console.log('  Grand Total:', grandTotal);
            
            // Update summary display
            document.getElementById('summarySubtotal').textContent = subtotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryDiscount').textContent = totalDiscount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryExcise').textContent = totalExcise.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryVAT').textContent = totalVAT.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryGrandTotal').textContent = grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function toggleCustomerTIN() {
            const buyerType = document.getElementById('invoiceBuyerType').value;
            const tinRequired = document.getElementById('tinRequired');
            const tinInput = document.getElementById('invoiceCustomerTIN');
            
            if (buyerType === '0') {
                // Business - TIN required
                tinRequired.style.display = 'inline';
                tinInput.required = true;
                tinInput.placeholder = 'Required for Business customers';
            } else {
                // Individual, Foreign, Tax Exempt - TIN optional
                tinRequired.style.display = 'none';
                tinInput.required = false;
                tinInput.placeholder = 'Optional';
            }
        }

        function closeInvoiceModal() {
            document.getElementById('editInvoiceModal').style.display = 'none';
            currentEditingInvoice = null;
        }

        function showEfrisInvoiceModal(efrisInvoice, fdn, antifakeCode) {
            const basic = efrisInvoice.basicInformation || {};
            const seller = efrisInvoice.sellerDetails || {};
            const buyer = efrisInvoice.buyerDetails || {};
            const goods = efrisInvoice.goodsDetails || [];
            const summary = efrisInvoice.summary || {};
            const taxDetails = efrisInvoice.taxDetails || [];
            
            const goodsRows = goods.map((item, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${item.item || item.goodsName || '-'}</td>
                    <td>${item.itemCode || '-'}</td>
                    <td style="text-align: right;">${parseFloat(item.qty || 0).toLocaleString()}</td>
                    <td style="text-align: right;">${parseFloat(item.unitPrice || 0).toLocaleString()}</td>
                    <td style="text-align: right;">${parseFloat(item.total || 0).toLocaleString()}</td>
                    <td style="text-align: right;">${parseFloat(item.tax || 0).toLocaleString()}</td>
                </tr>
            `).join('');
            
            const modalHtml = `
                <div id="efrisInvoiceModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1001;">
                    <div style="background: white; padding: 0; border-radius: 10px; max-width: 850px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h2 style="margin: 0; font-size: 24px;">üßæ EFRIS Fiscal Invoice</h2>
                                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Uganda Revenue Authority</p>
                                </div>
                                <button onclick="closeEfrisInvoiceModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px 12px; border-radius: 5px;">&times;</button>
                            </div>
                        </div>
                        
                        <!-- Invoice Info Bar -->
                        <div style="background: #f0f8ff; padding: 15px 20px; border-bottom: 2px solid #1e3a5f; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <strong style="color: #1e3a5f;">FDN (Fiscal Document Number)</strong><br>
                                <span style="font-size: 22px; font-weight: bold; color: #2c5282;">${fdn || basic.invoiceNo || '-'}</span>
                            </div>
                            <div>
                                <strong style="color: #1e3a5f;">Invoice ID</strong><br>
                                <span style="font-size: 14px; color: #555;">${basic.invoiceId || '-'}</span>
                            </div>
                            <div>
                                <strong style="color: #1e3a5f;">Antifake Code</strong><br>
                                <span style="font-size: 14px; color: #555;">${antifakeCode || basic.antifakeCode || '-'}</span>
                            </div>
                            <div>
                                <strong style="color: #1e3a5f;">Issue Date</strong><br>
                                <span style="font-size: 14px; color: #555;">${basic.issuedDate || '-'}</span>
                            </div>
                        </div>
                        
                        <!-- Seller & Buyer -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h4 style="margin: 0 0 10px 0; color: #28a745;">üì¶ Seller Details</h4>
                                <p style="margin: 5px 0;"><strong>TIN:</strong> ${seller.tin || '-'}</p>
                                <p style="margin: 5px 0;"><strong>Name:</strong> ${seller.legalName || seller.businessName || '-'}</p>
                                <p style="margin: 5px 0;"><strong>Address:</strong> ${seller.address || '-'}</p>
                                <p style="margin: 5px 0;"><strong>Phone:</strong> ${seller.mobilePhone || '-'}</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
                                <h4 style="margin: 0 0 10px 0; color: #007bff;">üõí Buyer Details</h4>
                                <p style="margin: 5px 0;"><strong>TIN:</strong> ${buyer.buyerTin || 'N/A (Individual)'}</p>
                                <p style="margin: 5px 0;"><strong>Name:</strong> ${buyer.buyerLegalName || buyer.buyerBusinessName || '-'}</p>
                                <p style="margin: 5px 0;"><strong>Address:</strong> ${buyer.buyerAddress || '-'}</p>
                                <p style="margin: 5px 0;"><strong>Phone:</strong> ${buyer.buyerMobilePhone || '-'}</p>
                            </div>
                        </div>
                        
                        <!-- Goods Table -->
                        <div style="padding: 0 20px 20px 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìã Items / Services</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #2c5282; color: white;">
                                        <th style="padding: 10px; text-align: left;">#</th>
                                        <th style="padding: 10px; text-align: left;">Item</th>
                                        <th style="padding: 10px; text-align: left;">Code</th>
                                        <th style="padding: 10px; text-align: right;">Qty</th>
                                        <th style="padding: 10px; text-align: right;">Unit Price</th>
                                        <th style="padding: 10px; text-align: right;">Total</th>
                                        <th style="padding: 10px; text-align: right;">VAT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${goodsRows}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary -->
                        <div style="background: #f8f9fa; padding: 20px; margin: 0 20px 20px 20px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                                <div>
                                    <div style="color: #7f8c8d; font-size: 12px;">Net Amount</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #2c3e50;">UGX ${parseFloat(summary.netAmount || 0).toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="color: #7f8c8d; font-size: 12px;">VAT (18%)</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #e67e22;">UGX ${parseFloat(summary.taxAmount || 0).toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="color: #7f8c8d; font-size: 12px;">Items</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #2c3e50;">${summary.itemCount || goods.length}</div>
                                </div>
                                <div style="background: #28a745; padding: 10px; border-radius: 8px;">
                                    <div style="color: white; font-size: 12px;">GROSS TOTAL</div>
                                    <div style="font-size: 22px; font-weight: bold; color: white;">UGX ${parseFloat(summary.grossAmount || 0).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div style="padding: 15px 20px; background: #f0f0f0; border-radius: 0 0 10px 10px; text-align: center;">
                            <button onclick="closeEfrisInvoiceModal()" style="padding: 10px 30px; background: #2c5282; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                ‚úì Close
                            </button>
                            <button onclick="printEfrisInvoice()" style="padding: 10px 30px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 10px;">
                                üñ®Ô∏è Print
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existing = document.getElementById('efrisInvoiceModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeEfrisInvoiceModal() {
            const modal = document.getElementById('efrisInvoiceModal');
            if (modal) modal.remove();
        }
        
        function printEfrisInvoice() {
            const modal = document.getElementById('efrisInvoiceModal');
            if (modal) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>EFRIS Invoice</title></head><body>');
                printWindow.document.write(modal.innerHTML);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            }
        }

        async function submitInvoiceToEFRIS() {
            if (!currentEditingInvoice) return;
            
            const buyerType = document.getElementById('invoiceBuyerType').value;
            const customerTIN = document.getElementById('invoiceCustomerTIN').value.trim();
            
            // Validate TIN for business customers
            if (buyerType === '0' && !customerTIN) {
                showToast('Customer TIN is required for Business customers', 'error');
                return;
            }
            
            if (!confirm(`Submit invoice ${currentEditingInvoice.DocNumber} to EFRIS?`)) {
                return;
            }
            
            try {
                const submitBtn = document.getElementById('submitInvoiceBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Submitting...';
                
                showToast('Submitting invoice to EFRIS...', 'success');
                
                // Prepare invoice data with updated fields (tax categories auto-detected from QuickBooks)
                const invoiceData = {
                    ...currentEditingInvoice,
                    BuyerType: buyerType,
                    BuyerTin: customerTIN,
                    TxnDate: document.getElementById('invoiceDate').value
                };
                
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/invoices/submit-to-efris`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        invoice_id: currentEditingInvoice.Id,
                        invoice_data: invoiceData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Submission failed');
                }

                const result = await response.json();
                
                if (result.success) {
                    showToast(`‚úÖ Invoice submitted successfully! FDN: ${result.fdn || 'N/A'}`, 'success');
                    closeInvoiceModal();
                    // Show EFRIS invoice details
                    if (result.efris_invoice) {
                        showEfrisInvoiceModal(result.efris_invoice, result.fdn, result.antifake_code);
                    }
                    // Reload invoices to show updated status
                    await loadQBData('invoices');
                } else {
                    showToast(`‚ùå Submission failed: ${result.error || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showToast(`Failed to submit invoice: ${error.message}`, 'error');
            } finally {
                const submitBtn = document.getElementById('submitInvoiceBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Save & Submit to EFRIS';
            }
        }

        async function syncQBInvoicesWithEFRIS() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            try {
                showToast('Syncing invoices with EFRIS...', 'success');
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-invoices/sync-efris`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Failed to sync with EFRIS');

                const data = await response.json();
                showToast(data.message || `Synced ${data.synced_count || 0} invoices`, 'success');
                
                // Reload invoices to show updated statuses
                await loadQBData('invoices');
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Failed to sync with EFRIS', 'error');
            }
        }

        function displayQBPurchaseOrders(pos) {
            const content = document.getElementById('qbPurchaseOrdersContent');
            if (!pos || pos.length === 0) {
                content.innerHTML = '<p style="color: #7f8c8d;">No purchase orders found.</p>';
                return;
            }

            // Count by status
            const pendingCount = pos.filter(po => !po.efris_status || po.efris_status === 'pending').length;
            const sentCount = pos.filter(po => po.efris_status === 'sent').length;
            const failedCount = pos.filter(po => po.efris_status === 'failed').length;

            content.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <button class="btn btn-success" onclick="sendSelectedPOsToEFRIS()">‚úÖ Send Selected to EFRIS</button>
                    </div>
                    <div style="color: #7f8c8d; display: flex; gap: 15px;">
                        <span><strong>${pos.length}</strong> total</span>
                        <span style="color: #f39c12;">‚è≥ ${pendingCount} pending</span>
                        <span style="color: #2ecc71;">‚úì ${sentCount} sent</span>
                        ${failedCount > 0 ? `<span style="color: #e74c3c;">‚úó ${failedCount} failed</span>` : ''}
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" onchange="toggleSelectAllPOs(this)"></th>
                            <th>PO #</th>
                            <th>Vendor</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>EFRIS Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pos.map(po => {
                            // Handle both old format (direct qb data) and new format (db record)
                            const docNumber = po.doc_number || po.DocNumber || po.qb_doc_number || '';
                            const vendorName = po.vendor_name || po.VendorRef?.name || po.qb_vendor_name || '-';
                            const txnDate = po.txn_date || po.TxnDate || po.qb_txn_date || '-';
                            const totalAmt = po.total_amt || po.TotalAmt || po.qb_total_amt || 0;
                            const poId = po.id || po.Id || '';
                            const efrisStatus = po.efris_status || 'pending';
                            
                            // Status badge styling
                            let statusBadge = '';
                            if (efrisStatus === 'sent') {
                                statusBadge = '<span class="badge badge-success" title="Successfully sent to EFRIS">‚úì Sent</span>';
                            } else if (efrisStatus === 'failed') {
                                const errorMsg = po.efris_error || 'Unknown error';
                                statusBadge = `<span class="badge badge-danger" title="${errorMsg}" style="cursor: help;">‚úó Failed</span>`;
                            } else {
                                statusBadge = '<span class="badge badge-warning">‚è≥ Pending</span>';
                            }
                            
                            // Disable checkbox if already sent
                            const checkboxDisabled = efrisStatus === 'sent' ? 'disabled' : '';
                            
                            return `
                            <tr style="${efrisStatus === 'sent' ? 'opacity: 0.7;' : ''}">
                                <td><input type="checkbox" class="po-checkbox" value="${poId}" ${checkboxDisabled}></td>
                                <td><strong>${docNumber}</strong></td>
                                <td>${vendorName}</td>
                                <td>${txnDate}</td>
                                <td>UGX ${parseFloat(totalAmt).toLocaleString()}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick='viewPurchaseOrder(${JSON.stringify(po).replace(/'/g, "&apos;")})'>üëÅÔ∏è View</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayQBCreditMemos(cms) {
            const content = document.getElementById('qbCreditMemosContent');
            if (!cms || cms.length === 0) {
                content.innerHTML = '<p style="color: #7f8c8d;">No credit memos found.</p>';
                return;
            }

            content.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Credit Memo #</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cms.map(cm => `
                            <tr>
                                <td><strong>${cm.DocNumber || ''}</strong></td>
                                <td>${cm.CustomerRef?.name || '-'}</td>
                                <td>${cm.TxnDate || '-'}</td>
                                <td>UGX ${cm.TotalAmt || '0'}</td>
                                <td><span class="badge badge-success">Imported</span></td>
                                <td>
                                    <button class="btn btn-sm" onclick="viewCreditMemo('${cm.Id}')">View</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function importFromEFRIS(type) {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            try {
                showToast(`Importing ${type} from EFRIS...`, 'success');
                
                if (type === 'products') {
                    // Import and save goods from EFRIS to database
                    const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/efris-goods/import?page_size=50`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (!response.ok) throw new Error('Failed to import products from EFRIS');

                    const data = await response.json();
                    console.log('EFRIS Products Import Response:', data);
                    const goodsList = data?.records || [];
                    showToast(data.message || `Imported ${goodsList.length} products from EFRIS`, 'success');
                    
                    // Load from database and display
                    await loadEFRISData('products');
                    
                } else if (type === 'invoices') {
                    // Import and save invoices from EFRIS to database
                    const queryParams = {
                        pageNo: "1",
                        pageSize: "50"
                    };
                    
                    const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/efris-invoices/import`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(queryParams)
                    });

                    if (!response.ok) throw new Error('Failed to import invoices from EFRIS');

                    const data = await response.json();
                    console.log('EFRIS Invoices Import Response:', data);
                    const invoiceList = data?.records || [];
                    showToast(data.message || `Imported ${invoiceList.length} invoices from EFRIS`, 'success');
                    
                    // Load from database and display
                    await loadEFRISData('invoices');
                    
                } else {
                    showToast(`${type} import not yet implemented`, 'error');
                }
                
            } catch (error) {
                console.error(`Import error:`, error);
                showToast(`Failed to import ${type} from EFRIS`, 'error');
            }
        }

        async function refreshStockLevels() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            try {
                showToast('Refreshing stock levels from EFRIS...', 'info');
                
                // Re-import goods to get updated stock levels
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/efris-goods/import?page_size=50`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to refresh stock levels');

                const data = await response.json();
                showToast('Stock levels updated successfully', 'success');
                
                // Reload and display updated data
                await loadEFRISData('products');
                
            } catch (error) {
                console.error('Refresh stock error:', error);
                showToast('Failed to refresh stock levels', 'error');
            }
        }

        async function loadEFRISData(type) {
            if (!currentCompany) return;

            const endpoints = {
                'products': `/api/companies/${currentCompany.id}/efris-goods`,
                'invoices': `/api/companies/${currentCompany.id}/efris-invoices`
            };

            try {
                const response = await fetch(`${API_BASE}${endpoints[type]}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load EFRIS data');

                const data = await response.json();
                
                // Display in the current tab
                if (type === 'products') {
                    displayEFRISProducts(data || []);
                } else if (type === 'invoices') {
                    displayEFRISInvoices(data || []);
                }
            } catch (error) {
                console.error(`Load EFRIS error:`, error);
                // If no data, show empty state
                if (type === 'products') {
                    displayEFRISProducts([]);
                } else if (type === 'invoices') {
                    displayEFRISInvoices([]);
                }
            }
        }

        function displayEFRISProducts(products) {
            const content = document.getElementById('productsContent');
            if (!products || products.length === 0) {
                content.innerHTML = '<p style="color: #7f8c8d;">No products found in EFRIS.</p>';
                return;
            }

            content.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product Code</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Unit Price</th>
                            <th>Stock</th>
                            <th>Tax Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(p => {
                            const stock = parseFloat(p.stock || 0);
                            const stockClass = stock > 0 ? 'text-success' : 'text-muted';
                            return `
                            <tr>
                                <td><strong>${p.goodsCode || p.itemCode || ''}</strong></td>
                                <td>${p.goodsName || p.itemName || '-'}</td>
                                <td>${p.commodityCategoryName || p.goodsCategoryId || '-'}</td>
                                <td>UGX ${parseFloat(p.unitPrice || 0).toLocaleString()}</td>
                                <td><strong class="${stockClass}">${stock.toLocaleString()}</strong></td>
                                <td>${(parseFloat(p.taxRate || 0) * 100).toFixed(0)}%</td>
                                <td><span class="badge badge-success">Registered</span></td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayEFRISInvoices(invoices) {
            const content = document.getElementById('invoicesContent');
            if (!invoices || invoices.length === 0) {
                content.innerHTML = '<p style="color: #7f8c8d;">No invoices found in EFRIS.</p>';
                return;
            }

            content.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>FDN</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(inv => `
                            <tr>
                                <td><strong>${inv.invoiceNo || inv.invoiceNumber || ''}</strong></td>
                                <td>${inv.fdn || inv.fiscalDocumentNumber || '-'}</td>
                                <td>${inv.buyerLegalName || inv.buyerBusinessName || inv.customerName || '-'}</td>
                                <td>${inv.issuedDateStr || inv.issuedDate || inv.invoiceDate || '-'}</td>
                                <td>UGX ${parseFloat(inv.grossAmount || inv.totalAmount || 0).toLocaleString()}</td>
                                <td><span class="badge badge-success">Fiscalized</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function fetchQBProducts() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            // Switch to products tab first
            switchTab('products');
            
            try {
                showToast('Fetching QuickBooks products...', 'success');
                const response = await fetch(`${API_BASE}/api/quickbooks/items?company_id=${currentCompany.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch QB products');
                
                const data = await response.json();
                showToast(`Fetched ${data.count} products from QuickBooks (${data.registered} registered, ${data.pending} pending)`, 'success');
                
                // Display QB products in products tab
                displayQBProducts(data.items);
            } catch (error) {
                console.error('QB fetch error:', error);
                showToast('Failed to fetch QuickBooks products', 'error');
            }
        }

        async function fetchQBInvoices() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            // Switch to invoices tab first
            switchTab('invoices');
            
            try {
                showToast('Fetching QuickBooks invoices...', 'success');
                const response = await fetch(`${API_BASE}/api/quickbooks/invoices?company_id=${currentCompany.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch QB invoices');
                
                const data = await response.json();
                showToast(`Fetched ${data.count} invoices from QuickBooks`, 'success');
                
                // Display QB invoices in invoices tab
                displayQBInvoices(data.invoices);
            } catch (error) {
                console.error('QB fetch error:', error);
                showToast('Failed to fetch QuickBooks invoices', 'error');
            }
        }

        async function fetchQBPurchaseOrders() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            try {
                showToast('Fetching QuickBooks purchase orders...', 'success');
                const response = await fetch(`${API_BASE}/api/quickbooks/purchase-orders?company_id=${currentCompany.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch QB purchase orders');
                
                const data = await response.json();
                showToast(`Fetched ${data.count} purchase orders from QuickBooks`, 'success');
                console.log('QB POs:', data);
            } catch (error) {
                console.error('QB fetch error:', error);
                showToast('Failed to fetch QuickBooks purchase orders', 'error');
            }
        }

        async function fetchQBCreditMemos() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            try {
                showToast('Fetching QuickBooks credit memos...', 'success');
                const response = await fetch(`${API_BASE}/api/quickbooks/credit-memos?company_id=${currentCompany.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch QB credit memos');
                
                const data = await response.json();
                showToast(`Fetched ${data.count} credit memos from QuickBooks`, 'success');
                console.log('QB Credit Memos:', data);
            } catch (error) {
                console.error('QB fetch error:', error);
                showToast('Failed to fetch QuickBooks credit memos', 'error');
            }
        }

        // ========== DISPLAY FUNCTIONS ==========

        function displayProducts(products) {
            const contentDiv = document.getElementById('productsContent');
            
            if (!products || products.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p>No products found. Add products to get started.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>SKU</th>
                            <th>Unit Price</th>
                            <th>Category</th>
                            <th>EFRIS Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            products.forEach(product => {
                const status = product.efris_synced ? 'badge-success' : 'badge-warning';
                const statusText = product.efris_synced ? 'Synced' : 'Pending';
                html += `
                    <tr>
                        <td><strong>${product.name || '-'}</strong></td>
                        <td>${product.sku || '-'}</td>
                        <td>UGX ${product.unit_price || '0'}</td>
                        <td>${product.category || '-'}</td>
                        <td><span class="badge ${status}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding:0.5rem 1rem; font-size:0.85rem;" onclick="viewProduct('${product.id}')">View</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        function displayInvoices(invoices) {
            const contentDiv = document.getElementById('invoicesContent');
            
            if (!invoices || invoices.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <p>No invoices found. Add invoices to get started.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>EFRIS Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            invoices.forEach(invoice => {
                const status = invoice.efris_synced ? 'badge-success' : 'badge-warning';
                const statusText = invoice.efris_synced ? 'Synced' : 'Pending';
                html += `
                    <tr>
                        <td><strong>${invoice.invoice_number || '-'}</strong></td>
                        <td>${invoice.customer_name || '-'}</td>
                        <td>${invoice.invoice_date || '-'}</td>
                        <td>UGX ${invoice.total_amount || '0'}</td>
                        <td><span class="badge ${status}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding:0.5rem 1rem; font-size:0.85rem;" onclick="viewInvoice('${invoice.id}')">View</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        function displayQBProducts(items) {
            const contentDiv = document.getElementById('productsContent');
            
            if (!items || items.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p>No QuickBooks products found.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 6px;">
                    <strong>QuickBooks Products:</strong> ${items.length} items fetched
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Type</th>
                            <th>SKU</th>
                            <th>Unit Price</th>
                            <th>Qty on Hand</th>
                            <th>EFRIS Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            items.forEach(item => {
                const status = item.EfrisStatus === 'Registered' ? 'badge-success' : 'badge-warning';
                const statusText = item.EfrisStatus || 'Pending';
                html += `
                    <tr>
                        <td><strong>${item.Name || '-'}</strong></td>
                        <td>${item.Type || '-'}</td>
                        <td>${item.Sku || item.Description || '-'}</td>
                        <td>UGX ${item.UnitPrice || '0'}</td>
                        <td>${item.QtyOnHand || '0'}</td>
                        <td><span class="badge ${status}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding:0.5rem 1rem; font-size:0.85rem;" 
                                onclick="syncSingleProduct('${item.Id}')">
                                ${item.EfrisStatus === 'Registered' ? 'Update' : 'Sync to EFRIS'}
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        function displayQBInvoices(invoices) {
            const contentDiv = document.getElementById('invoicesContent');
            
            if (!invoices || invoices.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <p>No QuickBooks invoices found.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 6px;">
                    <strong>QuickBooks Invoices:</strong> ${invoices.length} invoices fetched
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            invoices.forEach(invoice => {
                const balance = invoice.Balance || 0;
                const statusClass = balance > 0 ? 'badge-warning' : 'badge-success';
                const statusText = balance > 0 ? 'Unpaid' : 'Paid';
                html += `
                    <tr>
                        <td><strong>${invoice.DocNumber || '-'}</strong></td>
                        <td>${invoice.CustomerRef?.name || '-'}</td>
                        <td>${invoice.TxnDate || '-'}</td>
                        <td>UGX ${invoice.TotalAmt || '0'}</td>
                        <td>UGX ${balance}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding:0.5rem 1rem; font-size:0.85rem;" 
                                onclick="syncSingleInvoice('${invoice.Id}')">
                                Sync to EFRIS
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        // ========== SYNC FUNCTIONS ==========

        async function syncSingleProduct(itemId) {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            try {
                showToast('Syncing product to EFRIS...', 'success');
                // TODO: Implement single product sync
                console.log('Sync product:', itemId);
                setTimeout(() => showToast('Product sync functionality coming soon', 'error'), 1000);
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Failed to sync product', 'error');
            }
        }

        async function syncSingleInvoice(invoiceId) {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            try {
                showToast('Syncing invoice to EFRIS...', 'success');
                const response = await fetch(`${API_BASE}/api/quickbooks/sync-invoice/${invoiceId}?company_id=${currentCompany.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to sync invoice');
                
                const result = await response.json();
                showToast(`Invoice ${result.invoiceNo} synced to EFRIS successfully!`, 'success');
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Failed to sync invoice to EFRIS', 'error');
            }
        }

        function viewProduct(productId) {
            showToast('Product details view coming soon', 'success');
        }

        function viewInvoice(invoiceId) {
            showToast('Invoice details view coming soon', 'success');
        }

        async function syncProductsToEFRIS() {
            showToast('Syncing products to EFRIS...', 'success');
            setTimeout(() => showToast('EFRIS sync functionality coming soon', 'error'), 1000);
        }

        async function syncInvoicesToEFRIS() {
            showToast('Syncing invoices to EFRIS...', 'success');
            setTimeout(() => showToast('EFRIS sync functionality coming soon', 'error'), 1000);
        }

        function viewPurchaseOrder(po) {
            const lines = (po.Line || []).filter(l => l.DetailType === 'ItemBasedExpenseLineDetail');
            const vendor = po.VendorRef?.name || 'N/A';
            
            const itemsHtml = lines.map((line, idx) => {
                const detail = line.ItemBasedExpenseLineDetail || {};
                const itemRef = detail.ItemRef || {};
                return `
                    <tr>
                        <td>${itemRef.name || 'N/A'}</td>
                        <td style="text-align:center;">${itemRef.value || ''}</td>
                        <td style="text-align:right;">${detail.Qty || 0}</td>
                        <td style="text-align:right;">UGX ${parseFloat(detail.UnitPrice || 0).toLocaleString()}</td>
                        <td style="text-align:right;"><strong>UGX ${parseFloat(line.Amount || 0).toLocaleString()}</strong></td>
                    </tr>
                `;
            }).join('');
            
            showModal(
                `Purchase Order #${po.DocNumber}`,
                `
                    <div style="background:#f5f5f5;padding:1rem;border-radius:4px;margin-bottom:1rem;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                            <div><strong>Vendor:</strong> ${vendor}</div>
                            <div><strong>Date:</strong> ${po.TxnDate || '-'}</div>
                            <div><strong>Total:</strong> UGX ${parseFloat(po.TotalAmt || 0).toLocaleString()}</div>
                            <div><strong>Items:</strong> ${lines.length}</div>
                        </div>
                        ${po.Memo ? `<div style="margin-top:1rem;"><strong>Memo:</strong> ${po.Memo}</div>` : ''}
                    </div>
                    <h4 style="margin:1rem 0;">Line Items</h4>
                    <div style="max-height:400px;overflow-y:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f5f5f5;border-bottom:2px solid #ddd;">
                                    <th style="padding:0.75rem;text-align:left;">Product</th>
                                    <th style="padding:0.75rem;text-align:center;">Code</th>
                                    <th style="padding:0.75rem;text-align:right;">Qty</th>
                                    <th style="padding:0.75rem;text-align:right;">Unit Price</th>
                                    <th style="padding:0.75rem;text-align:right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                    </div>
                `
            );
        }

        async function syncPurchaseOrdersToEFRIS() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            try {
                showToast('Sending purchase orders to EFRIS as stock increases...', 'success');

                // Get all purchase orders
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-purchase-orders`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch purchase orders');
                }

                const pos = await response.json();

                if (!pos || pos.length === 0) {
                    showToast('No purchase orders found to sync', 'warning');
                    return;
                }

                // Send to EFRIS
                const syncResponse = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-purchase-orders/sync-to-efris`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        po_ids: pos.map(po => po.id)
                    })
                });

                if (!syncResponse.ok) {
                    const error = await syncResponse.json();
                    throw new Error(error.detail || 'Failed to sync purchase orders');
                }

                const result = await syncResponse.json();
                
                if (result.failed_count > 0) {
                    showToast(`‚ö†Ô∏è ${result.synced_count} succeeded, ${result.failed_count} failed. Check console for details.`, 'warning');
                    console.log('Failed POs:', result.failed);
                } else {
                    showToast(`‚úÖ Successfully sent ${result.synced_count} purchase orders to EFRIS as stock increases!`, 'success');
                }
                
                // Reload purchase orders to see updated status
                await loadData('qb-purchase-orders');
                
            } catch (error) {
                console.error('Error syncing purchase orders:', error);
                showToast(`Failed to sync purchase orders: ${error.message}`, 'error');
            }
        }

        function toggleSelectAllPOs(checkbox) {
            const checkboxes = document.querySelectorAll('.po-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        async function sendSelectedPOsToEFRIS() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            // Get selected PO IDs
            const checkboxes = document.querySelectorAll('.po-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('Please select at least one purchase order', 'warning');
                return;
            }

            const poIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            try {
                showToast(`Sending ${poIds.length} purchase order(s) to EFRIS...`, 'success');

                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/qb-purchase-orders/sync-to-efris`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        po_ids: poIds
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to send purchase orders');
                }

                const result = await response.json();
                
                if (result.failed_count > 0) {
                    showToast(`‚ö†Ô∏è ${result.synced_count} succeeded, ${result.failed_count} failed. Check console for details.`, 'warning');
                    console.log('Failed POs:', result.failed);
                } else {
                    showToast(`‚úÖ Successfully sent ${result.synced_count} purchase order(s) to EFRIS as stock increases!`, 'success');
                }
                
                // Uncheck all checkboxes
                checkboxes.forEach(cb => cb.checked = false);
                const selectAllCheckbox = document.querySelector('input[type="checkbox"][onchange*="toggleSelectAllPOs"]');
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                
            } catch (error) {
                console.error('Error sending purchase orders:', error);
                showToast(`Failed to send purchase orders: ${error.message}`, 'error');
            }
        }

        async function viewPurchaseOrder(po) {
            console.log('Purchase Order:', po);
            
            // Extract data based on format (direct QB data or db record)
            const qbData = po.qb_data || po;
            const docNumber = po.doc_number || qbData.DocNumber || '';
            const vendorName = po.vendor_name || qbData.VendorRef?.name || '';
            const txnDate = po.txn_date || qbData.TxnDate || '';
            const totalAmt = po.total_amt || qbData.TotalAmt || 0;
            const efrisStatus = po.efris_status || 'pending';
            const lines = qbData.Line || [];
            
            // Build line items HTML
            let itemsHtml = '';
            let itemCount = 0;
            for (const line of lines) {
                if (line.DetailType === 'ItemBasedExpenseLineDetail') {
                    const detail = line.ItemBasedExpenseLineDetail || {};
                    const itemRef = detail.ItemRef || {};
                    const qty = detail.Qty || 0;
                    const unitPrice = detail.UnitPrice || 0;
                    const amount = line.Amount || 0;
                    
                    itemsHtml += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; border: 1px solid #dee2e6;">${itemRef.name || ''}</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${qty}</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">UGX ${parseFloat(unitPrice).toLocaleString()}</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;"><strong>UGX ${parseFloat(amount).toLocaleString()}</strong></td>
                        </tr>
                    `;
                    itemCount++;
                }
            }
            
            if (!itemsHtml) {
                itemsHtml = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #7f8c8d;">No line items found</td></tr>';
            }
            
            // Status badge
            let statusBadge = '';
            if (efrisStatus === 'sent') {
                statusBadge = '<span style="background: #2ecc71; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;">‚úì Sent to EFRIS</span>';
            } else if (efrisStatus === 'failed') {
                const errorMsg = po.efris_error || 'Unknown error';
                statusBadge = `<span style="background: #e74c3c; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;" title="${errorMsg}">‚úó Failed</span>`;
            } else {
                statusBadge = '<span style="background: #f39c12; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;">‚è≥ Pending</span>';
            }
            
            // Set modal content
            document.getElementById('poModalTitle').textContent = `Purchase Order #${docNumber}`;
            document.getElementById('poModalContent').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Vendor Information</h4>
                            <p style="margin: 5px 0;"><strong>Vendor:</strong> ${vendorName}</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${txnDate}</p>
                        </div>
                        <div style="text-align: right;">
                            ${statusBadge}
                            ${po.efris_sent_at ? `<p style="margin: 5px 0; color: #7f8c8d; font-size: 12px;">Sent: ${new Date(po.efris_sent_at).toLocaleString()}</p>` : ''}
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                        <p style="margin: 0; font-size: 18px;"><strong>Total Amount:</strong> <span style="color: #2ecc71; font-size: 22px; font-weight: bold;">UGX ${parseFloat(totalAmt).toLocaleString()}</span></p>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Line Items (${itemCount})</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden;">
                            <thead>
                                <tr style="background: #3498db; color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Item</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">Qty</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">Unit Price</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                ${po.efris_error ? `
                    <div style="background: #fee; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #e74c3c;">
                        <h4 style="margin: 0 0 10px 0; color: #e74c3c;">Error Details</h4>
                        <p style="margin: 0; color: #c0392b; font-family: monospace; font-size: 13px;">${po.efris_error}</p>
                    </div>
                ` : ''}
            `;
            
            // Show modal
            document.getElementById('viewPOModal').style.display = 'flex';
        }

        function closePOModal() {
            document.getElementById('viewPOModal').style.display = 'none';
        }

        async function syncCreditMemosToEFRIS() {
            showToast('EFRIS sync functionality coming soon', 'error');
        }

        async function syncToEFRIS() {
            showToast('EFRIS sync functionality coming soon', 'error');
        }

        async function refreshExciseCodes() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            try {
                showToast('Querying excise duty codes from EFRIS...', 'success');

                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/excise-duty`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to query excise codes');
                }

                const result = await response.json();
                
                // Count the excise codes
                const exciseList = result.data?.decrypted_content?.exciseDutyList || [];
                const leafNodes = exciseList.filter(item => item.isLeafNode === '1');
                
                showToast(`‚úÖ Successfully refreshed ${leafNodes.length} excise duty codes from EFRIS and saved to database!`, 'success');
                
                // Reload dropdown from database
                populateExciseCodes();
                
            } catch (error) {
                console.error('Error refreshing excise codes:', error);
                showToast(`Failed to refresh excise codes: ${error.message}`, 'error');
            }
        }

        async function refreshExciseCodesTab() {
            try {
                showToast('üîÑ Querying excise codes from EFRIS...', 'info');
                
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/excise-duty`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to query excise codes');
                }

                const result = await response.json();
                const exciseList = result.data?.decrypted_content?.exciseDutyList || [];
                const leafNodes = exciseList.filter(item => item.isLeafNode === '1');
                
                showToast(`‚úÖ Refreshed ${leafNodes.length} excise codes and saved to database!`, 'success');
                
                // Reload the excise codes table
                loadExciseCodes();
                
            } catch (error) {
                console.error('Error refreshing excise codes:', error);
                showToast(`Failed to refresh: ${error.message}`, 'error');
            }
        }

        async function loadExciseCodes() {
            const container = document.getElementById('exciseCodesContent');
            if (!container) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/excise-codes`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load excise codes');
                }
                
                const result = await response.json();
                const codes = result.codes || [];
                
                if (codes.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üè∑Ô∏è</div>
                            <p>No excise codes found. Click "Refresh from EFRIS" to load excise duty codes.</p>
                        </div>
                    `;
                    return;
                }
                
                // Build table
                let html = `
                    <div class="stats-grid" style="margin-bottom: 1.5rem;">
                        <div class="stat-card">
                            <div class="stat-value">${codes.length}</div>
                            <div class="stat-label">Total Excise Codes</div>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Rate</th>
                                    <th>Type</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                codes.forEach(code => {
                    const ruleText = code.exciseRule === '1' ? 'Percentage' : 'Fixed Rate';
                    const unitText = getUnitName(code.unit);
                    
                    html += `
                        <tr>
                            <td><strong>${code.exciseDutyCode}</strong></td>
                            <td>${code.goodService || 'N/A'}</td>
                            <td>${code.rateText || code.rate || 'N/A'}</td>
                            <td>${ruleText}</td>
                            <td>${unitText}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading excise codes:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>Error loading excise codes: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Global variable to store excise codes data
        let exciseCodesData = [];

        async function populateExciseCodes() {
            try {
                // Fetch from database (cached server-side)
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/excise-codes`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('Failed to load excise codes from database');
                    return;
                }
                
                const result = await response.json();
                const leafNodes = result.codes || [];
                
                // Store globally for unit lookup
                exciseCodesData = leafNodes;
                
                // Populate the dropdown
                const select = document.getElementById('editExciseDutyCode');
                if (select) {
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">Select excise code...</option>';
                    
                    // Add all leaf node codes
                    leafNodes.forEach(code => {
                        const option = document.createElement('option');
                        option.value = code.exciseDutyCode;
                        option.textContent = `${code.exciseDutyCode} - ${code.goodService}`;
                        select.appendChild(option);
                    });
                    
                    console.log(`Populated ${leafNodes.length} excise codes from database`);
                    
                    // Setup change handler if not already set
                    if (!select.dataset.handlerSet) {
                        select.addEventListener('change', handleExciseCodeChange);
                        select.dataset.handlerSet = 'true';
                    }
                }
            } catch (error) {
                console.error('Error populating excise codes:', error);
            }
        }

        function handleExciseCodeChange(event) {
            const selectedCode = event.target.value;
            if (!selectedCode) return;
            
            // Find the selected excise code data
            const exciseData = exciseCodesData.find(item => item.exciseDutyCode === selectedCode);
            if (!exciseData) return;
            
            // Get unit directly from excise data (stored in database now)
            let unitCode = exciseData.unit || '101'; // Default to pieces
            
            // Auto-populate the unit of measure dropdown
            const unitSelect = document.getElementById('editUnitOfMeasure');
            if (unitSelect) {
                unitSelect.value = unitCode;
                console.log(`Auto-populated unit ${unitCode} for excise code ${selectedCode}`);
                showToast(`Unit automatically set to ${getUnitName(unitCode)} for this excise item`, 'success');
            } else {
                console.error('Unit of measure dropdown not found');
            }
        }

        function getUnitName(code) {
            const units = {
                '101': 'Pieces',
                '102': 'Litres',
                '103': 'Boxes',
                '104': 'Kilograms',
                '105': 'Meters'
            };
            return units[code] || 'Unknown';
        }

        function viewProduct(productId) {
            showToast('Product details view coming soon', 'success');
        }

        function viewInvoice(invoiceId) {
            showToast('Invoice details view coming soon', 'success');
        }

        // ========== SEARCH FUNCTIONS ==========
        
        async function searchProducts(keyword) {
            try {
                const url = keyword 
                    ? `${API_BASE}/api/companies/${currentCompany.id}/products?search=${encodeURIComponent(keyword)}`
                    : `${API_BASE}/api/companies/${currentCompany.id}/products`;
                    
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const products = await response.json();
                    displayProducts(products);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function searchInvoices(keyword) {
            try {
                const url = keyword 
                    ? `${API_BASE}/api/companies/${currentCompany.id}/invoices?search=${encodeURIComponent(keyword)}`
                    : `${API_BASE}/api/companies/${currentCompany.id}/invoices`;
                    
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const invoices = await response.json();
                    displayInvoices(invoices);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function searchQBItems(keyword) {
            try {
                const url = keyword 
                    ? `${API_BASE}/api/companies/${currentCompany.id}/qb-items?search=${encodeURIComponent(keyword)}`
                    : `${API_BASE}/api/companies/${currentCompany.id}/qb-items`;
                    
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayQBItems(data.items || []);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function searchQBInvoices(keyword) {
            try {
                const url = keyword 
                    ? `${API_BASE}/api/companies/${currentCompany.id}/qb-invoices?search=${encodeURIComponent(keyword)}`
                    : `${API_BASE}/api/companies/${currentCompany.id}/qb-invoices`;
                    
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayQBInvoicesInTab(data.invoices || []);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function searchQBPurchaseOrders(keyword) {
            try {
                const url = keyword 
                    ? `${API_BASE}/api/companies/${currentCompany.id}/qb-purchase-orders?search=${encodeURIComponent(keyword)}`
                    : `${API_BASE}/api/companies/${currentCompany.id}/qb-purchase-orders`;
                    
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayQBPurchaseOrders(Array.isArray(data) ? data : (data.purchase_orders || []));
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function searchQBCreditMemos(keyword) {
            try {
                const url = keyword 
                    ? `${API_BASE}/api/companies/${currentCompany.id}/qb-credit-memos?search=${encodeURIComponent(keyword)}`
                    : `${API_BASE}/api/companies/${currentCompany.id}/qb-credit-memos`;
                    
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayQBCreditMemos(data.credit_memos || []);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // ========== QUICKBOOKS COMPANY SWITCHING FUNCTIONS ==========

        async function loadSettingsData() {
            if (!currentCompany) return;

            // Load company info
            document.getElementById('companyId').textContent = currentCompany.id;
            document.getElementById('companyName').textContent = currentCompany.name || 'Unnamed Company';
            document.getElementById('companyCreated').textContent = currentCompany.created_at ? new Date(currentCompany.created_at).toLocaleDateString() : 'Unknown';
            document.getElementById('companyUpdated').textContent = currentCompany.updated_at ? new Date(currentCompany.updated_at).toLocaleDateString() : 'Unknown';

            // Load EFRIS info (placeholder - you can enhance this with actual API call)
            document.getElementById('efrisTIN').textContent = '1014409555';
            document.getElementById('efrisDevice').textContent = '1014409555_02';
            document.getElementById('efrisEnv').textContent = 'Test Environment';
            document.getElementById('efrisCert').textContent = 'wandera.pfx';

            // Load QB connection status
            await refreshQuickBooksStatus();
        }

        async function refreshQuickBooksStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/quickbooks/status`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateQBConnectionUI(data);
                } else {
                    updateQBConnectionUI({ connected: false });
                }
            } catch (error) {
                console.error('Error checking QB status:', error);
                updateQBConnectionUI({ connected: false });
            }
        }

        function updateQBConnectionUI(status) {
            const statusBadge = document.getElementById('qbStatusBadge');
            const statusText = document.getElementById('qbStatusText');
            const companyInfo = document.getElementById('qbCompanyInfo');
            
            const connectBtn = document.getElementById('connectQBBtn');
            const connectNewBtn = document.getElementById('connectNewQBBtn');
            const switchBtn = document.getElementById('switchQBBtn');
            const disconnectBtn = document.getElementById('disconnectQBBtn');

            if (status.connected) {
                // Connected state
                statusBadge.style.background = '#2ecc71';
                statusBadge.innerHTML = '‚úì Connected';
                statusText.textContent = `Connected to ${status.company_name || 'QuickBooks Company'}`;
                
                // Show company info
                companyInfo.style.display = 'block';
                document.getElementById('qbCompanyName').textContent = status.company_name || 'Unknown';
                document.getElementById('qbRegion').textContent = status.region || 'US';
                document.getElementById('qbRealmId').textContent = status.realm_id || 'Unknown';
                document.getElementById('qbConnectedSince').textContent = status.connected_at ? new Date(status.connected_at).toLocaleDateString() : 'Unknown';
                
                // Show appropriate buttons
                connectBtn.style.display = 'none';
                connectNewBtn.style.display = 'inline-block';
                switchBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'inline-block';
            } else {
                // Disconnected state
                statusBadge.style.background = '#e74c3c';
                statusBadge.innerHTML = '‚úó Disconnected';
                statusText.textContent = 'Not connected to QuickBooks';
                
                // Hide company info
                companyInfo.style.display = 'none';
                
                // Show appropriate buttons
                connectBtn.style.display = 'inline-block';
                connectNewBtn.style.display = 'none';
                switchBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
            }
        }

        async function connectQuickBooks() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            try {
                // Call company-specific QB connect endpoint
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/quickbooks/connect`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.auth_url) {
                        // Redirect to QuickBooks OAuth
                        showToast('Redirecting to QuickBooks for authentication...', 'success');
                        window.open(data.auth_url, '_blank', 'width=800,height=600');
                        
                        // Check connection status periodically
                        const checkInterval = setInterval(async () => {
                            await refreshQuickBooksStatus();
                            const statusBadge = document.getElementById('qbStatusBadge');
                            if (statusBadge.textContent.includes('Connected')) {
                                clearInterval(checkInterval);
                                showToast('‚úÖ Successfully connected to QuickBooks!', 'success');
                            }
                        }, 3000);

                        // Stop checking after 2 minutes
                        setTimeout(() => {
                            clearInterval(checkInterval);
                        }, 120000);
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to initiate QuickBooks connection');
                }
            } catch (error) {
                console.error('Error connecting to QuickBooks:', error);
                showToast(`Failed to connect to QuickBooks: ${error.message}`, 'error');
            }
        }

        async function connectNewQuickBooksSandbox() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            const confirmation = confirm(
                'This will connect to a DIFFERENT QuickBooks sandbox. Your current QuickBooks connection will be replaced. Continue?'
            );

            if (!confirmation) return;

            try {
                showToast('Initiating connection to new QuickBooks sandbox...', 'success');
                
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/quickbooks/connect-new-sandbox`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authorization_url) {
                        // Open QuickBooks OAuth in new window
                        showToast('Opening QuickBooks authorization for new sandbox...', 'success');
                        window.open(data.authorization_url, '_blank', 'width=800,height=600');
                        
                        // Monitor connection status
                        const checkInterval = setInterval(async () => {
                            await refreshQuickBooksStatus();
                            const statusBadge = document.getElementById('qbStatusBadge');
                            if (statusBadge.textContent.includes('Connected')) {
                                clearInterval(checkInterval);
                                showToast('‚úÖ Successfully connected to new QuickBooks sandbox!', 'success');
                            }
                        }, 3000);

                        // Stop checking after 2 minutes
                        setTimeout(() => {
                            clearInterval(checkInterval);
                        }, 120000);
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to initiate connection to new sandbox');
                }
            } catch (error) {
                console.error('Error connecting to new QB sandbox:', error);
                showToast(`Failed to connect to new QuickBooks sandbox: ${error.message}`, 'error');
            }
        }

        async function switchQuickBooksCompany() {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            const confirmation = confirm(
                'This will disconnect from the current QuickBooks company and allow you to connect to a different one. Continue?'
            );

            if (confirmation) {
                try {
                    // Disconnect first
                    await disconnectQuickBooks(false);
                    
                    // Then connect to new company
                    setTimeout(() => {
                        connectQuickBooks();
                    }, 1000);
                } catch (error) {
                    console.error('Error switching QB company:', error);
                    showToast(`Failed to switch QuickBooks company: ${error.message}`, 'error');
                }
            }
        }

        async function disconnectQuickBooks(showConfirmation = true) {
            if (!currentCompany) {
                showToast('Please select a company first', 'error');
                return;
            }

            if (showConfirmation) {
                const confirmation = confirm('Are you sure you want to disconnect from QuickBooks? This will stop all data synchronization.');
                if (!confirmation) return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/companies/${currentCompany.id}/quickbooks/disconnect`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast('‚úÖ Successfully disconnected from QuickBooks', 'success');
                    await refreshQuickBooksStatus();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to disconnect from QuickBooks');
                }
            } catch (error) {
                console.error('Error disconnecting from QuickBooks:', error);
                if (showConfirmation) {
                    showToast(`Failed to disconnect from QuickBooks: ${error.message}`, 'error');
                }
                throw error;
            }
        }
        
        // ========== ERP CONNECTION FUNCTIONS ==========
        
        async function checkERPConnection() {
            if (!selectedCompanyId) return;
            
            try {
                const response = await fetch(`/api/companies/${selectedCompanyId}/erp/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const status = await response.json();
                    
                    if (status.connected) {
                        // Show connected banner
                        document.getElementById('erpConnectionBanner').style.display = 'none';
                        document.getElementById('erpConnectedBanner').style.display = 'block';
                        document.getElementById('connectedERPName').textContent = 
                            status.erp_type.charAt(0).toUpperCase() + status.erp_type.slice(1);
                        
                        if (status.last_sync) {
                            const lastSync = new Date(status.last_sync);
                            document.getElementById('lastSyncTime').textContent = lastSync.toLocaleString();
                        }
                    } else {
                        // Show connect banner
                        document.getElementById('erpConnectionBanner').style.display = 'block';
                        document.getElementById('erpConnectedBanner').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking ERP connection:', error);
            }
        }
        
        function showConnectERPModal() {
            document.getElementById('connectERPModal').style.display = 'flex';
        }
        
        function closeConnectERPModal() {
            document.getElementById('connectERPModal').style.display = 'none';
        }
        
        async function connectQuickBooks() {
            if (!selectedCompanyId) {
                showToast('Please select a company first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/companies/${selectedCompanyId}/quickbooks/connect`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Redirect to QuickBooks OAuth
                    window.location.href = data.authorization_url;
                } else {
                    const error = await response.json();
                    showToast(`Failed to connect: ${error.detail}`, 'error');
                }
            } catch (error) {
                showToast('Failed to initiate QuickBooks connection', 'error');
            }
        }
        
        async function disconnectERP() {
            if (!confirm('Are you sure you want to disconnect your accounting software? You will need to reconnect to sync data.')) {
                return;
            }
            
            if (!selectedCompanyId) return;
            
            try {
                const response = await fetch(`/api/companies/${selectedCompanyId}/quickbooks/disconnect`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showToast('Disconnected successfully', 'success');
                    checkERPConnection();
                } else {
                    showToast('Failed to disconnect', 'error');
                }
            } catch (error) {
                showToast('Failed to disconnect', 'error');
            }
        }
        
        async function syncERPData() {
            if (!selectedCompanyId) return;
            
            showToast('Syncing data from QuickBooks...', 'info');
            
            try {
                // Call your existing sync endpoint
                await syncProducts();
                showToast('Sync completed successfully', 'success');
                checkERPConnection();
            } catch (error) {
                showToast('Sync failed', 'error');
            }
        }
        
        // Check ERP connection on load and company switch
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (document.getElementById('dashboard').style.display !== 'none') {
                    checkERPConnection();
                }
            }, 1000);
        });
    </script>
    
    <!-- Connect ERP Modal -->
    <div id="connectERPModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #2c3e50;">Connect Your Accounting Software</h2>
            <p style="color: #7f8c8d; margin-bottom: 30px;">Choose your accounting software to automatically sync invoices and products with EFRIS</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- QuickBooks -->
                <div onclick="connectQuickBooks(); closeConnectERPModal();" style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s; text-align: center;" onmouseover="this.style.borderColor='#2ca01c'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(44, 160, 28, 0.2)';" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="font-size: 3rem; margin-bottom: 12px;">üíö</div>
                    <h3 style="margin: 0 0 8px 0; color: #2c3e50;">QuickBooks</h3>
                    <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">Online & Desktop</p>
                </div>
                
                <!-- Xero -->
                <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 24px; text-align: center; opacity: 0.5; cursor: not-allowed;" title="Coming soon">
                    <div style="font-size: 3rem; margin-bottom: 12px;">üíô</div>
                    <h3 style="margin: 0 0 8px 0; color: #2c3e50;">Xero</h3>
                    <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">Coming Soon</p>
                </div>
                
                <!-- Zoho -->
                <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 24px; text-align: center; opacity: 0.5; cursor: not-allowed;" title="Coming soon">
                    <div style="font-size: 3rem; margin-bottom: 12px;">üü†</div>
                    <h3 style="margin: 0 0 8px 0; color: #2c3e50;">Zoho Books</h3>
                    <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">Coming Soon</p>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="closeConnectERPModal()" style="padding: 12px 24px; background: #ecf0f1; color: #2c3e50; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</body>
</html>
